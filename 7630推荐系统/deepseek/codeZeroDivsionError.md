> ğŸ’­ å¥½çš„ï¼Œæˆ‘ç°åœ¨è¦è§£å†³ç”¨æˆ·é‡åˆ°çš„ZeroDivisionErroré—®é¢˜ã€‚ç”¨æˆ·çš„ä»£ç åœ¨é¢„å¤„ç†æ•°æ®æ—¶ï¼Œæ‰§è¡Œåˆ°SnowNLPè¿›è¡Œæƒ…æ„Ÿåˆ†ææ—¶å‡ºç°äº†é™¤ä»¥é›¶çš„é”™è¯¯ï¼Œå…·ä½“æ˜¯åœ¨bm25.pyæ–‡ä»¶ä¸­è®¡ç®—avgdlæ—¶ï¼Œself.Dçš„å€¼æ˜¯é›¶å¯¼è‡´çš„ã€‚
>
> é¦–å…ˆï¼Œæˆ‘éœ€è¦ç†è§£è¿™ä¸ªé”™è¯¯çš„åŸå› ã€‚æ ¹æ®é”™è¯¯å †æ ˆï¼Œé—®é¢˜å‡ºåœ¨snownlpçš„bm25æ¨¡å—ï¼Œå½“åˆå§‹åŒ–æ—¶self.Dè¢«è®¾ç½®ä¸ºdocsçš„é•¿åº¦ï¼Œè€Œåœ¨è¿™é‡Œdocsçš„é•¿åº¦ä¸ºé›¶ã€‚è¿™æ„å‘³ç€ç”¨æˆ·ä¼ é€’ç»™SnowNLPçš„æ•°æ®ä¸­å­˜åœ¨ç©ºå†…å®¹çš„æƒ…å†µï¼Œå¯¼è‡´åœ¨è®¡ç®—æ—¶é™¤ä»¥é›¶ã€‚
>
> æ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦æ£€æŸ¥ç”¨æˆ·çš„æ•°æ®æ¸…æ´—æ­¥éª¤ã€‚ç”¨æˆ·ä½¿ç”¨äº†clean_textå‡½æ•°ï¼Œé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼å»é™¤éä¸­æ–‡å­—ç¬¦å’Œå¤šä½™ç©ºæ ¼ã€‚ä½†å¯èƒ½åœ¨æ¸…æ´—ä¹‹åï¼ŒæŸäº›è¡Œçš„contentå˜æˆäº†ç©ºå­—ç¬¦ä¸²ï¼Œè¿™æ ·åœ¨åˆ†è¯å’ŒSnowNLPå¤„ç†æ—¶ï¼Œå°±ä¼šä¼ é€’ç©ºçš„å†…å®¹ï¼Œå¯¼è‡´snownlpå†…éƒ¨å¤„ç†ç©ºåˆ—è¡¨æ—¶å‡ºé”™ã€‚
>
> å…·ä½“æ¥è¯´ï¼Œå½“ç”¨æˆ·åº”ç”¨SnowNLPåˆ°ç©ºå­—ç¬¦ä¸²æ—¶ï¼Œå¯èƒ½è§¦å‘äº†æŸä¸ªæ–¹æ³•çš„æ‰§è¡Œï¼Œæ¯”å¦‚æ„å»ºæ–‡æ¡£é›†æ—¶ä¼ å…¥ç©ºçš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œbm25ç®—æ³•å¯èƒ½éœ€è¦æ–‡æ¡£é•¿åº¦ï¼Œä½†å¦‚æœæ–‡æ¡£æ•°ä¸ºé›¶ï¼Œå°±ä¼šæŠ›å‡ºé™¤ä»¥é›¶çš„é”™è¯¯ã€‚æ­¤æ—¶éœ€è¦æ£€æŸ¥æ¸…æ´—åçš„æ•°æ®æ˜¯å¦åŒ…å«ç©ºå†…å®¹ï¼Œå¯¼è‡´SnowNLPå†…éƒ¨å¤„ç†å¤±è´¥ã€‚
>
> è§£å†³æ–¹æ¡ˆåŒ…æ‹¬å‡ ä¸ªæ­¥éª¤ï¼šé¦–å…ˆï¼Œåº”åœ¨æ¸…æ´—åè¿‡æ»¤æ‰ç©ºçš„å†…å®¹ï¼›å…¶æ¬¡ï¼Œåœ¨åº”ç”¨SnowNLPä¹‹å‰æ£€æŸ¥æ–‡æœ¬æ˜¯å¦æœ‰æ•ˆï¼›å¦å¤–ï¼Œè¿˜å¯ä»¥è€ƒè™‘åœ¨æ•°æ®é¢„å¤„ç†é˜¶æ®µä½¿ç”¨try-exceptæ¥æ•è·å¼‚å¸¸ï¼Œç¡®ä¿ç¨‹åºç»§ç»­è¿è¡Œã€‚
>
> ç”¨æˆ·ç°åœ¨çš„æ¸…æ´—å‡½æ•°clean_textä½¿ç”¨re.sub(r'[^\u4e00-\u9fff]', ' ', text)ï¼Œè¿™ä¼šå°†æ‰€æœ‰éä¸­æ–‡å­—ç¬¦æ›¿æ¢ä¸ºç©ºæ ¼ï¼Œå¹¶ä¸”ä¹‹åç”¨strip()ç§»é™¤é¦–å°¾ç©ºæ ¼ã€‚å¦‚æœåŸå§‹å†…å®¹ä¸­æ²¡æœ‰ä¸­æ–‡å­—ç¬¦ï¼Œæ¸…æ´—åçš„å†…å®¹ä¼šæ˜¯ç©ºå­—ç¬¦ä¸²ã€‚è¿™ä¼šå¯¼è‡´cleaned_contentåˆ—ä¸ºç©ºï¼Œåœ¨åç»­åˆ†è¯å’Œåº”ç”¨SnowNLPæ—¶å¯èƒ½å‡ºç°é—®é¢˜ã€‚
>
> å› æ­¤ï¼Œä¿®å¤æ–¹æ³•æ˜¯åœ¨é¢„å¤„ç†æµç¨‹ä¸­æ·»åŠ è¿‡æ»¤æ­¥éª¤ï¼Œå»é™¤ç©ºå†…å®¹ï¼Œæˆ–è€…åœ¨åº”ç”¨SnowNLPä¹‹å‰åšæ£€æŸ¥ã€‚å¦å¤–ï¼Œä¿®æ”¹clean_textå‡½æ•°ï¼Œä½¿ç©ºå†…å®¹è¢«å¤„ç†ä¸ºæŸç§å ä½ç¬¦ï¼Œæˆ–ç›´æ¥è·³è¿‡å¤„ç†è¿™äº›è¡Œã€‚åŒæ—¶ï¼Œä½¿ç”¨try-exceptå—æ¥é¿å…ç¨‹åºå´©æºƒä¹Ÿæ˜¯ä¸€ä¸ªå¥½æ–¹æ³•ã€‚
>
> ä¾‹å¦‚ï¼Œåœ¨preprocess_dataå‡½æ•°ä¸­ï¼Œåœ¨æ‰§è¡ŒSnowNLPå‰æ£€æŸ¥cleaned_contentæ˜¯å¦ä¸ºç©ºã€‚å¦‚æœä¸ºç©ºï¼Œå¯ä»¥è®¾ç½®é»˜è®¤æƒ…æ„Ÿå€¼æˆ–è€…è·³è¿‡å¤„ç†ã€‚æˆ–è€…åœ¨æ¸…æ´—æ•°æ®æ—¶ï¼Œç”¨æ¡ä»¶åˆ¤æ–­ç¡®ä¿å¤„ç†åçš„æ–‡æœ¬ä¸ä¸ºç©ºã€‚æ­¤å¤–ï¼Œåœ¨æ¸…æ´—å‡½æ•°ä¸­ä¿ç•™ä¸€äº›æ ‡ç‚¹æˆ–å¿…è¦å­—ç¬¦å¯èƒ½ä¹Ÿæœ‰å¸®åŠ©ï¼Œä½†éœ€è¦æ ¹æ®ç”¨æˆ·çš„éœ€æ±‚è€Œå®šã€‚
>
> å¦å¤–ï¼Œå¯èƒ½æœ‰æŸäº›æ–‡æœ¬åœ¨è¢«æ¸…æ´—åå˜æˆäº†ç©ºå­—ç¬¦ä¸²ï¼Œå¯¼è‡´åˆ†è¯æ—¶å¾—åˆ°ä¸€ä¸ªç©ºåˆ—è¡¨ï¼Œè€Œsnownlpçš„å†…éƒ¨å¤„ç†å¯èƒ½éœ€è¦å¤„ç†éç©ºæ–‡æœ¬ã€‚å› æ­¤ï¼Œè¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²æ˜¯å…³é”®ã€‚åœ¨ä»£ç ä¸­åŠ å…¥df = df[df['cleaned_content'].str.strip().astype(bool)]è¿™æ ·çš„è¡Œå¯ä»¥è¿‡æ»¤æ‰ç©ºå†…å®¹ã€‚
>
> æ€»ç»“ï¼šé—®é¢˜æ ¹æºæ˜¯æ¸…æ´—åçš„æŸäº›è¡Œå†…å®¹ä¸ºç©ºï¼Œå¯¼è‡´snownlpå¤„ç†æ—¶åˆ†æ¯ä¸ºé›¶ã€‚è§£å†³æ–¹æ³•æ˜¯åœ¨æ•°æ®é¢„å¤„ç†æ­¥éª¤ä¸­è¿‡æ»¤ç©ºå†…å®¹ï¼Œæˆ–è€…åœ¨åº”ç”¨SnowNLPå‰è¿›è¡Œæ£€æŸ¥å’Œå¤„ç†ã€‚
>
> 



è¿™ä¸ªé”™è¯¯æ˜¯ç”±äºæ¸…æ´—åå‡ºç°ç©ºç™½æ–‡æœ¬å¯¼è‡´çš„ã€‚ä¸ºäº†è®©æµç¨‹æ›´å¥å£®ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä»¥ä¸‹ä¼˜åŒ–æ–¹æ¡ˆï¼š

```python
import jieba
import re
from snownlp import SnowNLP

def clean_text_v2(text):
    """å¢å¼ºå‹æ–‡æœ¬æ¸…æ´—"""
    if pd.isna(text) or not isinstance(text, str):
        return ""
    
    # ä¿ç•™ä¸­æ–‡åŠåŸºç¡€æ ‡ç‚¹
    text = re.sub(r'[^\u4e00-\u9fa5ã€‚ï¼ï¼Ÿï¼Œã€ï¼›ï¼šâ€œâ€â€˜â€™ã€Šã€‹ã€ã€‘ï¼ˆï¼‰â…§â€”â€¦]', ' ', text)
    text = re.sub(r'\s+', ' ', text).strip()
    return text if len(text) >= 2 else ""  # è¿‡æ»¤å•ä¸ªå­—ç¬¦

def safe_sentiment(text):
    """å®‰å…¨æƒ…æ„Ÿè®¡ç®—"""
    if len(text) < 5:  # è¿‡çŸ­å†…å®¹æ— åˆ†ææ„ä¹‰
        return 0.5  # ä¸­æ€§é»˜è®¤å€¼
    try:
        return SnowNLP(text).sentiments
    except:
        return 0.5

def enhanced_preprocess(df):
    """å¢å¼ºé¢„å¤„ç†æµç¨‹"""
    # æ¸…æ´—æ—¶ä¿ç•™æœ€ä½æœ‰æ•ˆå†…å®¹
    df['cleaned_content'] = df['content'].apply(clean_text_v2)
    
    # è¿‡æ»¤æ— æ•ˆè§‚æµ‹ï¼ˆå…³é”®ä¿®æ­£ï¼ï¼‰
    df = df[df['cleaned_content'].str.len() >= 10].copy()
    
    # å±‚çº§å¤„ç†
    df['segmented'] = df['cleaned_content'].apply(
        lambda x: ' '.join(jieba.lcut(x)) if x else '')
    
    # å¹¶å‘æƒ…æ„Ÿè®¡ç®—ï¼ˆå¸¦å¼‚å¸¸æ•è·ï¼‰
    df['sentiment'] = df['cleaned_content'].parallel_apply(safe_sentiment)  # éœ€è¦å®‰è£…swifter
    
    return df

# æ‰§è¡Œé¢„å¤„ç†
cleaned_df = enhanced_preprocess(sina_news_df)
```

**å…³é”®ä¼˜åŒ–è¯´æ˜ï¼š**

1. **æ­£åˆ™è¡¨è¾¾å¼è°ƒæ•´**ï¼š
```python
# åŸå§‹ç‰ˆæœ¬ï¼šå»é™¤éä¸­æ–‡å­—ç¬¦
r'[^\u4e00-\u9fff]' â†’ åœ¨v2ç‰ˆæœ¬ä¸­ä¿®æ­£ä¸ºï¼š 
r'[^\u4e00-\u9fa5ã€‚ï¼ï¼Ÿï¼Œã€ï¼›ï¼šâ€œâ€â€˜â€™ã€Šã€‹ã€ã€‘ï¼ˆï¼‰â…§â€”â€¦]'
# ä¿ç•™ä¸­æ–‡å¸¸ç”¨æ ‡ç‚¹ç¬¦å·ï¼ˆUnicodeèŒƒå›´ä¿®æ­£ï¼‰
```

2. **æœ‰æ•ˆæ€§è¿‡æ»¤æœºåˆ¶**ï¼š
```python
df = df[df['cleaned_content'].str.len() >= 10]  # è¿‡æ»¤10å­—ä»¥ä¸‹çš„æ— æ•ˆå†…å®¹
```

3. **æƒ…æ„Ÿè®¡ç®—å®‰å…¨é˜²æŠ¤**ï¼š
```python
def safe_sentiment(text):
    if len(text) < 5:  # è¯­ä¹‰æœ‰æ•ˆæ€§ä¸‹é™
        return 0.5
    try:
        return SnowNLP(text).sentiments  # ä¸»è®¡ç®—æ–¹æ³•
    except Exception as e:  # æ•è·æ‰€æœ‰å¼‚å¸¸ç±»å‹
        print(f"ERROR on text: {text} â†’ {str(e)}")
        return 0.5  # å¼‚å¸¸æ—¶è¿”å›ä¸­æ€§å€¼
```

4. **å¹¶è¡Œå¤„ç†åŠ é€Ÿ**ï¼š
```python
# ä½¿ç”¨parallel_applyä»£æ›¿applyï¼ˆéœ€å®‰è£…swifterï¼‰
df['sentiment'] = df['cleaned_content'].swifter.apply(safe_sentiment)
```

5. **æ—¥å¿—ç›‘æ§ä½“ç³»**ï¼š
```python
# è®°å½•æ¸…æ´—å‰åçš„æ•°æ®å˜åŒ–
orig_len = len(sina_news_df)
cleaned_len = len(cleaned_df)
print(f"æ•°æ®æœ‰æ•ˆæ€§ï¼š{cleaned_len}/{orig_len} ({cleaned_len/orig_len:.1%})")
```

æ³¨ï¼šå¦‚é‡åˆ°swifterå®‰è£…é—®é¢˜ï¼Œå¯é‡‡ç”¨ä¼ ç»Ÿå¼‚å¸¸å¤„ç†æ–¹æ¡ˆï¼š
```python
def robust_sentiment(text):
    """ä¼ ç»Ÿå®‰å…¨å¤„ç†æ–¹æ³•"""
    if not text.strip():
        return None
    try:
        s = SnowNLP(text)
        return s.sentiments
    except ZeroDivisionError:
        print(f"æ•è·ZeroDivision: {text}")
        return 0.5
    except Exception as e:
        print(f"å¼‚å¸¸å†…å®¹ï¼š{text} â†’ {str(e)}")
        return 0.5

df['sentiment'] = df['cleaned_content'].apply(robust_sentiment).fillna(0.5)
```

å¯é€šè¿‡ä»¥ä¸‹æ£€æŸ¥éªŒè¯æ–¹æ¡ˆæœ‰æ•ˆæ€§ï¼š
```python
# éªŒè¯æ ·ä¾‹
test_cases = [
    ("æ­£å¸¸ä¸­æ–‡æ–‡æœ¬", 0.876),       # é¢„æœŸæ­£å¸¸
    ("Short", 0.5),            # æ–‡æœ¬è¿‡çŸ­
    ("", 0.5),                 # ç©ºæ–‡æœ¬
    ("12345#$%", None),        # åŸå§‹æ–‡æœ¬è¢«è¿‡æ»¤
    ("æ··åˆChinese withè‹±æ–‡", 0.721)  # éœ€éªŒè¯æ­£åˆ™æœ‰æ•ˆæ€§
]
```
