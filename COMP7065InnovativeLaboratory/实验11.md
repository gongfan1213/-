以下是完成该实验作业的详细步骤指南，包含每一步需要下载的内容、配置方法和具体操作流程：

---

### **第一部分：应用现有LoRA模型（Load LoRA节点）**
#### **1. 下载LoRA模型**
- **步骤**：
  1. 访问 [CivitAI](https://civitai.com)，搜索并下载“80s Movie Style LoRA”的权重文件 `80s_offset.safetensors`。
  2. 将下载的 `.safetensors` 文件放入 `ComfyUI/models/loras` 文件夹中。

#### **2. 在ComfyUI中配置工作流**
- **步骤**：
  1. 打开 ComfyUI，新建一个工作流。
  2. 添加以下节点（按顺序连接）：
     - **Checkpoint Loader**：加载基础模型（如 `Dreamshaper_8_pruned.safetensors`）。
     - **Load LoRA**：选择 `80s_offset.safetensors`，设置 `strength_model` 和 `strength_clip` 为 1.0。
     - **CLIP Text Encode**：输入正向提示词（需包含触发词“80s”）。
     - **KSampler**：配置采样参数（如步数20，CFG 7）。
     - **VAE Decode**：生成最终图像。
  3. 点击 **Queue Prompt** 生成图像，观察是否带有复古电影风格。

#### **3. 验证LoRA效果**
- **对比实验**：
  1. 移除 `Load LoRA` 节点，保持其他参数不变，重新生成图像。
  2. 比较两次生成的图像，确认LoRA是否生效（带LoRA的图像应呈现复古风格）。

---

### **第二部分：创建自定义LoRA（SimpleLoRA节点）**
#### **1. 安装SimpleLoRA节点**
- **步骤**：
  1. 从 GitHub 下载 [ComfyUI_SimpleLoRA](https://github.com/sifengshang/ComfyUI_SimpleLoRA)。
  2. 将源码文件夹 `ComfyUI_SimpleLoRA` 复制到 `ComfyUI/custom_nodes`。
  3. 双击运行 `install_requirements.bat` 安装依赖。
  4. 重启 ComfyUI，确认节点安装成功（右键菜单中应有 `SimpleLoRA`）。

#### **2. 配置LoRATrainer节点**
- **步骤**：
  1. 新建空白工作流，添加 **LoRATrainer** 节点（右键菜单 → SimpleLoRA → LoRATrainer）。
  2. 设置参数：
     - `ckpt_name`: `DreamShaper_8_pruned.safetensors`
     - `use_custom_dataset`: `false`
     - `dataset_path`: `syjack/pokemon-blip-captions-en-zh`（HuggingFace数据集）
     - `lora_checkpoint_folder`: `lora_showcase`
     - `lora_name`: `pokemon_lora`
     - `caption_column`: `en_text`
     - `batch_size`: 1（显存不足时保持默认）
     - `training_steps`: 1000，`checkpointing_steps`: 200
     - `rank`: 4，`learning_rate`: 0.0001
  3. 点击 **Queue Prompt** 开始训练（约15分钟）。

#### **3. 验证训练结果**
- **步骤**：
  1. 训练完成后，检查 `ComfyUI/models/lora_logs/lora_showcase` 是否生成 `.safetensors` 文件。
  2. 新建工作流，用 **LoraLoaderModelOnly** 节点加载 `pokemon_lora.safetensors`。
  3. 输入提示词如“a pokemon that looks like a mouse”，生成图像对比是否卡通化。

---

### **第三部分：练习任务（构建自定义数据集）**
#### **1. 准备数据集**
- **步骤**：
  1. 创建文件夹 `D:\one-line-art`，内部新建 `image` 和 `text` 子文件夹。
  2. 下载并重命名图片（如从 HuggingFace 的 `sd-concepts-library/one-line-drawing`），保存为 `0.png`, `1.png` 等。
  3. 为每张图片创建对应的 `.txt` 文件（如 `0.txt`），内容为描述词（如“one-line-art, face, front view”）。

#### **2. 训练自定义LoRA**
- **步骤**：
  1. 在 **LoRATrainer** 节点中设置：
     - `use_custom_dataset`: `true`
     - `dataset_path`: `D:/one-line-art`
     - `lora_name`: `one-line-art_lora`
     - `training_steps`: 64，`checkpointing_steps`: 16（避免过拟合）
  2. 启动训练，完成后检查 `lora_logs/one-line-art` 中的权重文件。

#### **3. 生成并提交结果**
- **步骤**：
  1. 应用训练好的LoRA，输入提示词如“one-line-art, face, side view”生成图像。
  2. 提交内容：
     - **ComfyUI工作流文件**（保存为 `.json`）。
     - **LoRA权重文件**（`.safetensors`）。
     - **10张生成图像** + **对应的提示词文本文件**。

---

### **常见问题解决**
- **LoRA加载失败**：检查文件路径和名称，确保与基础模型兼容（如SD1.5）。
- **显存不足**：降低 `batch_size` 或 `training_steps`。
- **生成效果差**：调整学习率或增加训练数据量。

按此流程操作即可完成实验。如果有报错，优先检查路径、依赖安装和参数设置。
