### **4.3 实时保存**

---

### **4.3.1 总述**
- **需求**：  
  对画布图层进行实时保存，特别处理画布中的图片，采用单独上传的方式。
- **实现方式**：  
  1. 图片上传后获取 `key`，替换画布内容中的 `base64` 数据。
  2. 通过这种方式降低实时保存的流量消耗和时间消耗。
- **目标**：  
  保存内容的实时同步成功率 > 99.9%。

---

### **4.3.2 流程图**

#### **实时保存内容**
- **保存内容包括**：
  1. 图层的 `json` 数据。
  2. 编码后的图片。

---

#### **流程梳理**

1. **创建项目**：
   - 用户创建项目后，初始化画布。

2. **图片处理**：
   - 根据压缩后的图片、官方个人元素配置的图片或用户本地图片，生成图片路径。

3. **判断是否需要保存**：
   - 如果用户的图层 `json` 数据未发生变化，则不执行保存操作。
   - 如果图层发生变化，进入保存流程。

4. **执行保存任务**：
   - **图片上传**：
     - 判断是否有需要上传的图片。
     - 如果有图片，上传图片并获取 `key`。
     - 替换画布内容中的 `base64` 数据为图片的 `key`。
   - **上传 `json` 数据**：
     - 上传图层的 `json` 数据。
     - 如果上传成功，保存完成；如果失败，返回错误信息。

5. **上传结果处理**：
   - **图片上传成功**：
     - 替换 `base64` 数据为 `key`，并更新 `json` 数据。
   - **图片上传失败**：
     - 返回错误信息，提示用户重新上传。

---

#### **流程图详细说明**

1. **初始化阶段**：
   - 用户创建项目，初始化画布。
   - 根据用户选择的图片来源（压缩图片、官方图片或本地图片），生成图片路径。

2. **判断图层变化**：
   - 检查用户的图层 `json` 数据是否发生变化：
     - **未变化**：不执行保存操作。
     - **发生变化**：进入保存流程。

3. **图片上传流程**：
   - 判断是否有需要上传的图片：
     - **有图片**：上传图片，获取 `key`，替换 `base64` 数据。
     - **无图片**：直接上传 `json` 数据。

4. **`json` 数据上传流程**：
   - 上传图层的 `json` 数据。
   - 如果上传成功，保存完成；如果失败，返回错误信息。

5. **结果处理**：
   - **图片上传成功**：
     - 替换 `base64` 数据为 `key`，并更新 `json` 数据。
   - **图片上传失败**：
     - 返回错误信息，提示用户重新上传。

---

#### **辅助方法入口**
1. **图片上传接口**：
   - 上传图片到服务器，返回图片的 `key`。
2. **`base64` 替换**：
   - 替换画布内容中的 `base64` 数据为图片的 `key`。
3. **`json` 数据上传接口**：
   - 上传图层的 `json` 数据到服务器。
4. **更新 `token`**：
   - 更新用户的身份验证信息。

---

### **总结**
通过对图片和 `json` 数据的分离处理，实时保存流程大幅降低了流量和时间消耗，确保了高效性和稳定性。整个流程设计清晰，能够有效应对用户的实时保存需求，同时保证了保存成功率 > 99.9%。
