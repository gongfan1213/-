

### **1. 单例模式**
- 通过单例模式确保全局只有一个统计上报管理器实例，避免重复创建。
- 使用 `IndexedDB` 作为本地存储，确保数据的持久化，即使页面刷新或关闭也不会丢失。

---

### **2. 初始化逻辑**
- **首次进入页面时**：
  - 打开 `IndexedDB` 数据库，获取所有历史埋点数据。
  - 对历史数据进行处理：
    - 如果埋点已结束或更新时间超过 10 分钟：
      - 如果数据有未上报的内容，尝试上报。
      - 上报成功后删除对应数据；如果上报失败，保留数据。
  - 初始化当前页面的埋点数据（`pageDataTemp`），记录页面 ID、创建时间和更新时间。
  - 设置定时器，每隔 5 分钟检查并上报埋点数据。

---

### **3. 数据记录**
- 提供 `addStatisticalEvent` 方法，用于记录用户行为事件。
  - 每条事件包括事件名称、参数（如值、额外信息、时间戳）和用户信息。
  - 将事件存储到当前页面的埋点数据中，并更新数据库。
  - 如果事件数量达到 20 条，立即触发上报。

---

### **4. 数据上报**
- 定期调用 `reportData` 方法：
  - 从当前页面的埋点数据中取出最多 20 条事件。
  - 调用 `sendReport` 方法将事件上报到服务器。
  - 如果上报成功，从本地数据中移除已上报的事件，并更新数据库。

---

### **5. 页面退出**
- 提供 `unInit` 方法：
  - 标记当前页面的埋点数据为已结束。
  - 清除定时器，停止定期上报。

---

### **6. 上报策略**
- **定时上报**：每隔 5 分钟检查是否有数据需要上报。
- **事件触发上报**：当事件数量达到 20 条时，立即上报。

---

### **7. 错误处理**
- 如果上报失败，数据会保留在本地，等待下次上报，确保数据不会丢失。

---

### **总结**

1. **数据持久化**：使用 `IndexedDB` 存储埋点数据，确保数据不会因页面刷新或关闭而丢失。
2. **定时与触发上报**：结合定时器和事件触发机制，优化上报频率，减少服务器压力。
3. **容错机制**：上报失败时保留数据，确保数据可靠性。
4. **灵活扩展**：通过 `addStatisticalEvent` 方法，可以轻松记录各种埋点事件。

