> ğŸ’­ ä»Šå¤©ï¼Œæˆ‘éœ€è¦è¯¦ç»†ç†è§£ç”¨æˆ·æä¾›çš„è¿™æ®µåˆ†ç‰‡ä¸‹è½½çš„TypeScriptå‡½æ•°`parallelDownload`ã€‚é¦–å…ˆï¼Œæˆ‘è¦é€šè¯»ä»£ç ï¼Œäº†è§£å®ƒçš„ä¸»è¦æµç¨‹å’Œå„éƒ¨åˆ†çš„åŠŸèƒ½ã€‚
>
> é¦–å…ˆï¼Œè¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯é€šè¿‡åˆ†ç‰‡çš„æ–¹å¼å¹¶è¡Œä¸‹è½½ä¸€ä¸ªå¤§æ–‡ä»¶ã€‚ç”¨æˆ·ä¼ å…¥URLå’Œå¯é€‰é…ç½®ï¼Œå‡½æ•°è¿”å›åˆå¹¶åçš„æ–‡ä»¶ã€‚æˆ‘åœ¨æƒ³è¦æ€ä¹ˆåˆ†ç‰‡ï¼Œæ˜¯åˆ†å‰²æˆå¤šä¸ªéƒ¨åˆ†åŒæ—¶ä¸‹è½½ï¼Œç„¶åå°†ç»“æœåˆå¹¶ï¼Ÿè¿™éƒ¨åˆ†å¯èƒ½éœ€è¦ç”¨åˆ°HTTPçš„Rangeå¤´å§ã€‚
>
> çœ‹å‡½æ•°å‚æ•°ï¼Œ`splitNumber`é»˜è®¤æ˜¯4ï¼Œè¯´æ˜é»˜è®¤åˆ†4ç‰‡ä¸‹è½½ã€‚`onProcess`æ˜¯ä¸€ä¸ªè¿›åº¦å›è°ƒå‡½æ•°ã€‚æ¥ä¸‹æ¥ï¼Œå‡½æ•°å¼€å§‹æ—¶ï¼Œå…ˆå°è¯•è·å–æ–‡ä»¶çš„æ€»å¤§å°ã€‚è¿™é‡Œç”¨äº†fetchè¯·æ±‚ï¼Œä½†Rangeå¤´è®¾ç½®ä¸º0-0ï¼Œè¿™æ˜¯å› ä¸ºæœåŠ¡å™¨éœ€è¦æ”¯æŒéƒ¨åˆ†å†…å®¹è¯·æ±‚ï¼Œå³è¿”å›Content-Rangeå¤´éƒ¨ï¼Œè¿™æ ·å°±å¯ä»¥å¾—åˆ°æ–‡ä»¶çš„æ€»å¤§å°ã€‚è¿™éƒ¨åˆ†é€»è¾‘å¯¹å—ï¼Ÿå¦‚æœæœåŠ¡å™¨ä¸æ”¯æŒRangeè¯·æ±‚ï¼Œå¯èƒ½å°±ä¼šå¤±è´¥ï¼Œè¿”å›0ï¼Œå¯¼è‡´åé¢æ— æ³•åˆ†ç‰‡ã€‚
>
> ç„¶åï¼Œè·å–åˆ°`contentLength`æ€»å¤§å°åï¼Œè®¡ç®—æ¯ä¸ªåˆ†ç‰‡çš„å¤§å°ï¼Œç”¨`Math.ceil(contentLength / 4)`ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªåˆ†ç‰‡æ˜¯æ€»å¤§å°é™¤ä»¥åˆ†ç‰‡æ•°ï¼Œå‘ä¸Šå–æ•´ã€‚è¿™å¯èƒ½æœ€åä¸€ç‰‡å¯èƒ½ä¼šå°ä¸€äº›ï¼Œä½†ä»£ç é‡Œç”¨äº†`Math.min`æ¥å¤„ç†è¿™ç§æƒ…å†µï¼Œè¿™åº”è¯¥æ²¡é—®é¢˜ã€‚
>
> ä¹‹åï¼Œéå†åˆ†ç‰‡æ•°ï¼Œä¸ºæ¯ä¸ªåˆ†ç‰‡å‘èµ·ä¸€ä¸ªfetchè¯·æ±‚ï¼Œè®¾ç½®æ­£ç¡®çš„Rangeå¤´ã€‚ä¾‹å¦‚ï¼Œç¬¬ä¸€ä¸ªåˆ†ç‰‡è¯·æ±‚0åˆ°chunkSize-1ï¼Œç¬¬äºŒä¸ªä»chunkSizeå¼€å§‹ï¼Œä¾æ­¤ç±»æ¨ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯Rangeçš„æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œæ˜¯å¦åŒ…å«å­—èŠ‚èµ·å§‹å’Œç»“æŸä½ç½®ã€‚
>
> æ¥ç€ï¼Œæ¯ä¸ªåˆ†ç‰‡çš„å¤„ç†éƒ¨åˆ†ã€‚é€šè¿‡`response.body.getReader()`è·å–å¯è¯»æµï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ReadableStreamæ¥è¯»å–æ•°æ®ã€‚åœ¨è¯»å–è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡è¯»å–ä¸€å—æ•°æ®ï¼Œå°±æ›´æ–°è¯¥åˆ†ç‰‡å·²ä¸‹è½½çš„å­—èŠ‚æ•°ï¼Œç„¶åè®¡ç®—æ€»è¿›åº¦ï¼Œè°ƒç”¨`onProcess`å›è°ƒã€‚è¿™é‡Œå¯èƒ½æœ‰ä¸ªé—®é¢˜ï¼šå½“å¤šä¸ªåˆ†ç‰‡åŒæ—¶ä¸‹è½½æ—¶ï¼Œå®ƒä»¬çš„è¿›åº¦æ›´æ–°å¯èƒ½ä¼šç«äº‰ï¼Œå¦‚ä½•æ­£ç¡®è®¡ç®—æ€»è¿›åº¦ï¼Ÿæ¯”å¦‚ï¼Œå„ä¸ªåˆ†ç‰‡çš„ä¸‹è½½é€Ÿåº¦ä¸åŒï¼Œæ¯æ¬¡æ›´æ–°çš„æ˜¯å„è‡ªåˆ†ç‰‡çš„å·²ä¸‹è½½å­—èŠ‚ï¼Œç´¯åŠ å¾—åˆ°æ€»è¿›åº¦æ˜¯å¦æ­£ç¡®ï¼Ÿ
>
> ç„¶åï¼Œæ¯ä¸ªåˆ†ç‰‡çš„æµè¢«è½¬æ¢ä¸ºArrayBufferï¼Œå¹¶ç­‰å¾…æ‰€æœ‰åˆ†ç‰‡ä¸‹è½½å®Œæˆåï¼Œåˆå¹¶è¿™äº›ArrayBufferã€‚åˆå¹¶çš„æ–¹æ³•æ˜¯è°ƒç”¨`mergeArrayBuffers`ï¼Œä¸è¿‡è¿™ä¸ªå‡½æ•°éœ€è¦ç”¨æˆ·è‡ªå·±å®ç°ï¼Œè¿™é‡Œçš„å®ç°å¯èƒ½æ¶‰åŠåˆ°å°†å¤šä¸ªArrayBufferåˆå¹¶æˆä¸€ä¸ªå¤§çš„ã€‚è¿™éƒ¨åˆ†æ˜¯å¦æ­£ç¡®ï¼Ÿæ¯”å¦‚ï¼Œæ¯ä¸ªåˆ†ç‰‡çš„æ•°æ®é¡ºåºæ˜¯å¦æ­£ç¡®ï¼Œæ˜¯å¦æŒ‰é¡ºåºåˆå¹¶ï¼Ÿ
>
> æ¥ä¸‹æ¥éœ€è¦è€ƒè™‘é”™è¯¯å¤„ç†ã€‚æ¯”å¦‚ï¼ŒæŸä¸ªåˆ†ç‰‡ä¸‹è½½å¤±è´¥çš„æƒ…å†µï¼ŒPromise.allä¼šæŠŠæ•´ä¸ªè¯·æ±‚éƒ½æ‹’ç»å—ï¼Ÿè¿™ä¸ªæ—¶å€™å¦‚ä½•å¤„ç†ï¼Ÿå½“å‰çš„ä»£ç æ˜¯å¦æ•è·äº†é”™è¯¯ï¼Ÿ
>
> å¦å¤–ï¼Œéƒ¨åˆ†æœåŠ¡å™¨å¯èƒ½ä¸æ”¯æŒå¹¶è¡Œä¸‹è½½ï¼Œæˆ–è€…å¯¹äºå¹¶å‘è¯·æ±‚æœ‰é™åˆ¶ï¼Œæ˜¯å¦ä¼šæœ‰æ€§èƒ½é—®é¢˜ï¼Ÿæˆ–è€…æœ‰äº›æœåŠ¡å™¨ä¸å…è®¸åˆ†ç‰‡è¯·æ±‚ï¼Œéœ€è¦æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ¥å—Rangeå¤´ã€‚
>
> è¿˜è¦æ³¨æ„ï¼Œå½“Content-Lengthè·å–å¤±è´¥æ—¶ï¼Œå‡½æ•°ä¼šæŠ›å‡ºé”™è¯¯ç»§ç»­åˆ°æœ€åçš„elseå—æŠ›é”™ã€‚è¿™ç§æƒ…å†µä¸‹åªèƒ½æŠ›é”™ï¼Œç”¨æˆ·éœ€è¦å¤„ç†è¿™ç§æƒ…å†µï¼Œæ¯”å¦‚å›é€€åˆ°æ™®é€šä¸‹è½½æ–¹å¼ã€‚
>
> å†æ€è€ƒä¸€ä¸‹æ­¥éª¤ï¼š
>
> 1. å‘é€å¤´éƒ¨è¯·æ±‚è·å–æ€»å¤§å°ï¼šæ˜¯å¦æ­£ç¡®å¤„ç†äº†å¯èƒ½çš„é”™è¯¯ï¼Ÿ
>
>    - æ¯”å¦‚ï¼Œå¦‚æœæœåŠ¡å™¨ä¸æ”¯æŒRangeè¯·æ±‚ï¼Œè¿”å›çš„Content-Rangeå¯èƒ½ä¸å­˜åœ¨ï¼Œå¯¼è‡´contentLengthä¸º0ï¼Œè§¦å‘é”™è¯¯ã€‚è¿™æ—¶å‡½æ•°ä¼šthrow 'Partial download failed'ã€‚
>
> 2. åˆ†ç‰‡è¯·æ±‚ï¼šæ¯ä¸ªåˆ†ç‰‡çš„Rangeæ˜¯å¦æ­£ç¡®ï¼Ÿ
>
>    - æ¯”å¦‚ï¼Œcursorçš„è®¡ç®—æ˜¯å¦æ­£ç¡®ï¼Ÿå‡è®¾åˆ†ç‰‡æ•°ä¸º4ï¼Œé‚£ä¹ˆæ¯ä¸ªåˆ†ç‰‡çš„èµ·å§‹æ˜¯0, chunkSize, 2*chunkSize, 3*chunkSizeç­‰ã€‚ä½†ä»£ç ä¸­ç”¨çš„æ˜¯cursorä½œä¸ºchunkSizeä¹˜ä»¥indexï¼Œè¿™åº”è¯¥å¯¹å§ï¼Ÿ
>
>    - ç»“æŸä½ç½®æ˜¯cursor + chunkSize -1ï¼Œä½†å¦‚æœè¶…è¿‡æ€»é•¿åº¦çš„è¯ï¼Œç”¨Math.miné™åˆ¶ã€‚
>
> 3. åˆ†ç‰‡ä¸‹è½½è¿›åº¦è·Ÿè¸ªï¼š
>
>    - æ¯ä¸ªåˆ†ç‰‡çš„è¯»å–æµé‡Œï¼Œæ¯æ¬¡è¯»å–åˆ°æ•°æ®å—ï¼Œå°±å°†è¯¥åˆ†ç‰‡çš„downloadedBytes[index]åŠ ä¸Šè¯¥å—çš„å­—èŠ‚é•¿åº¦ï¼Œå¯¹å—ï¼Ÿ
>
>    - ç„¶åç´¯åŠ æ‰€æœ‰åˆ†ç‰‡çš„ä¸‹è½½é‡å¾—åˆ°æ€»è¿›åº¦ã€‚è¿™é‡Œå¯èƒ½ä¼šæœ‰å¤šä¸ªåˆ†ç‰‡åŒæ—¶æ›´æ–°å„è‡ªçš„downloadedBytesæ•°ç»„ï¼Œå¯¼è‡´è®¡ç®—ç»“æœæ˜¯å¦æ­£ç¡®ã€‚å› ä¸ºJavaScriptæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰§è¡Œé¡ºåºå¦‚ä½•ï¼Ÿæ˜¯å¦ä¼šå‡ºç°ç«æ€æ¡ä»¶ï¼Ÿæ¯”å¦‚ï¼Œä¸¤ä¸ªåˆ†ç‰‡åŒæ—¶è¯»å–åˆ°å—ï¼Œç„¶ååŒæ—¶æ›´æ–°å„è‡ªçš„downloadedBytes[index]ï¼Œå¯èƒ½åœ¨è¿™ä¸ªæ­¥éª¤ä¸­ï¼Œç´¯è®¡çš„è¿›åº¦ä¼šä¸ä¼šæ¼æ‰ä¸€äº›å­—èŠ‚ï¼Ÿ
>
> è¿™äº›å¯èƒ½éœ€è¦è¿›ä¸€æ­¥ç¡®è®¤ã€‚å®é™…ä¸Šï¼ŒJavaScriptçš„äº‹ä»¶å¾ªç¯æ˜¯å•çº¿ç¨‹çš„ï¼Œå¼‚æ­¥å¤„ç†çš„å„ä¸ªå›è°ƒä¼šè¢«æŒ‰é¡ºåºå¤„ç†ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰å¹¶è¡Œæ›´æ–°çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªåˆ†ç‰‡çš„reader.read()å®Œæˆï¼Œè§¦å‘å…¶å›è°ƒï¼Œæ›´æ–°downloadedBytes[index]ï¼Œæ­¤æ—¶å…¶ä»–åˆ†ç‰‡çš„å¤„ç†è¿˜æ²¡æ‰§è¡Œçš„è¯ï¼Œæ‰€ä»¥åœ¨åŒä¸€ä¸ªæ—¶é—´ç‚¹åªæœ‰ä¸€ä¸ªdownloadedByteså…ƒç´ è¢«æ›´æ–°ã€‚å› æ­¤ç´¯åŠ æ—¶çš„æ•°æ®æ˜¯æ­£ç¡®çš„ï¼Œä¸ä¼šå‡ºç°æ•°æ®ç«äº‰çš„é—®é¢˜ã€‚
>
> æ¥ä¸‹æ¥ï¼Œåˆå¹¶ArrayBufferçš„é¡ºåºæ˜¯å¦æ­£ç¡®ã€‚åœ¨Promise.allä¸­ï¼Œåˆ†ç‰‡çš„å¤„ç†æ˜¯æŒ‰é¡ºåºå­˜å‚¨åˆ°promisesæ•°ç»„ä¸­çš„ã€‚å½“åˆå¹¶æ—¶ï¼Œchunksæ•°ç»„æ˜¯æŒ‰ç…§åˆ†ç‰‡çš„åŸå§‹é¡ºåºæ’åˆ—çš„ï¼Œå› æ­¤mergeArrayBuffersåº”è¯¥åªæ˜¯æŠŠå®ƒä»¬æ‹¼æ¥èµ·æ¥ã€‚å‡è®¾ç”¨æˆ·æä¾›çš„mergeArrayBuffersæ˜¯æŒ‰é¡ºåºå°†æ¯ä¸ªchunkçš„bufferæ‹¼æ¥åˆ°ä¸€èµ·ï¼Œæ¯”å¦‚ï¼Œç¬¬ä¸€ä¸ªåˆ†ç‰‡åœ¨å‰ï¼Œç¬¬äºŒä¸ªåœ¨ä¸‹ä¸€ä¸ªçš„ä½ç½®ï¼Œä¾æ­¤ç±»æ¨ã€‚è¿™ç‚¹æ˜¯å¦æ­£ç¡®ï¼Ÿå¦‚æœåˆ†ç‰‡è¯·æ±‚çš„é¡ºåºæ­£ç¡®ï¼Œä¸”åˆå¹¶æ—¶ä¹ŸæŒ‰é¡ºåºåˆå¹¶çš„è¯ï¼Œé‚£ä¹ˆåˆå¹¶åçš„æ–‡ä»¶åº”è¯¥æ­£ç¡®ã€‚
>
> æ¯”å¦‚ï¼Œå¦‚æœæœåŠ¡å™¨å¯¹èŒƒå›´è¯·æ±‚çš„å¤„ç†æ˜¯ä¸¥æ ¼æŒ‰ç…§è¯·æ±‚çš„é¡ºåºè¿”å›æ•°æ®ï¼Œåˆ™æ²¡é—®é¢˜ã€‚å¦‚æœæŸä¸ªåˆ†ç‰‡ä¸‹è½½è¾ƒæ…¢ï¼Œå¯èƒ½åœ¨åˆå¹¶é¡ºåºä¸Šå‡ºé—®é¢˜å—ï¼Ÿä¸ï¼Œå› ä¸ºpromisesæ•°ç»„æ˜¯æŒ‰åˆ†ç‰‡é¡ºåºç”Ÿæˆçš„ï¼Œå®ƒä»¬è¢«Promise.allå¤„ç†æ—¶ï¼Œè¿”å›çš„ç»“æœçš„é¡ºåºæ˜¯æŒ‰ç…§promiseæ•°ç»„çš„é¡ºåºï¼Œè€Œä¸æ˜¯å®Œæˆé¡ºåºã€‚ä¾‹å¦‚ï¼Œåˆ†ç‰‡3å¯èƒ½åœ¨åˆ†ç‰‡2ä¹‹å‰å®Œæˆï¼Œä½†ç»“æœæ•°ç»„ä¸­chunksçš„é¡ºåºä»ç„¶æ˜¯åˆ†ç‰‡0,1,2,3çš„é¡ºåºã€‚å› æ­¤åˆå¹¶çš„é¡ºåºæ˜¯æ­£ç¡®çš„ã€‚
>
> ç„¶åï¼Œæ€»è¿›åº¦æ˜¯å¦æ­£ç¡®ã€‚æ¯æ¬¡ä»»ä½•ä¸€ä¸ªåˆ†ç‰‡çš„æ•°æ®åˆ°è¾¾æ—¶ï¼Œéƒ½ä¼šç´¯åŠ æ‰€æœ‰downloadedBytesçš„å…ƒç´ ï¼Œè®¡ç®—å‡ºæ€»çš„ä¸‹è½½é‡ã€‚å› æ­¤ï¼Œè¿™ä¸ªè¿›åº¦æ˜¯å®æ—¶æ›´æ–°çš„ã€‚ä¸è¿‡ï¼Œå¯¹äºå¤§æ–‡ä»¶ä¸‹è½½ï¼Œè¿™æ ·çš„é¢‘ç¹è®¡ç®—æ˜¯å¦ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Ÿç‰¹åˆ«æ˜¯åœ¨ä¸‹è½½é€Ÿåº¦å¾ˆå¿«çš„æ—¶å€™ï¼Œå¯èƒ½é¢‘ç¹è§¦å‘onProcesså›è°ƒï¼Œå¯¼è‡´UIå¡é¡¿ã€‚ä¸è¿‡ä¸€èˆ¬æ¥è¯´è¿™ç§å›è°ƒæ˜¯è½»é‡çº§çš„ï¼Œå¯èƒ½ä¸ä¼šæœ‰å¤ªå¤§å½±å“ã€‚
>
> å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æœç½‘ç»œç¯å¢ƒä¸å¥½ï¼ŒæŸä¸ªåˆ†ç‰‡ä¸­é€”å¤±è´¥æ€ä¹ˆåŠï¼Ÿä¾‹å¦‚ï¼ŒæŸä¸ªåˆ†ç‰‡çš„fetchè¯·æ±‚å¤±è´¥ï¼ˆå¦‚è¶…æ—¶ã€ç½‘ç»œä¸­æ–­ï¼‰ï¼Œæ­¤æ—¶Promise.allä¼šç«‹å³rejectï¼Œæ•´ä¸ªä¸‹è½½å°†å¤±è´¥ã€‚ç”¨æˆ·æ˜¯å¦å¯ä»¥è¿›è¡Œé‡è¯•ï¼Ÿæˆ–è€…æ˜¯å¦å¯ä»¥æ•è·å•ä¸ªåˆ†ç‰‡çš„é”™è¯¯å¹¶å•ç‹¬å¤„ç†ï¼Ÿå½“å‰çš„å®ç°å¹¶æœªå¤„ç†è¿™ä¸€ç‚¹ï¼Œå› æ­¤ä¸€æ—¦æŸä¸ªåˆ†ç‰‡å¤±è´¥ï¼Œæ•´ä¸ªä¸‹è½½å°±ä¼šå¤±è´¥ã€‚å¯èƒ½éœ€è¦å¯¹æ­¤è¿›è¡Œä¼˜åŒ–ï¼Œä¾‹å¦‚åˆ©ç”¨Promise.allSettledï¼Œå¹¶å¤„ç†å¤±è´¥æƒ…å†µä¸‹çš„é‡è¯•æˆ–è·³è¿‡ã€‚
>
> æ¥ä¸‹æ¥ï¼Œå…·ä½“ä»£ç ä¸­çš„æ­¥éª¤ï¼š
>
> - å½“å‘èµ·HEADè¯·æ±‚æ—¶è®¾ç½®Range: bytes=0-0å—ï¼Ÿæˆ–è€…åº”è¯¥æ˜¯HEADæ–¹æ³•ï¼Ÿ
>
> ä¸ï¼Œç”¨æˆ·è¿™é‡Œå‘é€çš„æ˜¯GETæ–¹æ³•ï¼Œä½†Rangeå¤´è®¾ç½®ä¸º0-0ã€‚è¿™æ ·ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›206 Partial Contentï¼Œä½†åªè¿”å›å‰0å­—èŠ‚çš„å†…å®¹ã€‚è¿™æ—¶è¿”å›çš„headersé‡Œçš„Content-Rangeå¤´åº”ç±»ä¼¼äº"bytes 0-0/12345"ï¼Œå…¶ä¸­12345æ˜¯æ€»å¤§å°ã€‚è¿™ç§æ–¹å¼æ˜¯å¦æ­£ç¡®ï¼Ÿæ˜¯çš„ï¼Œå› ä¸ºHTTPå…è®¸ä»…è¯·æ±‚èµ„æºçš„æŸéƒ¨åˆ†ã€‚ä¸è¿‡ï¼Œæœ‰å¯èƒ½ä¸€äº›æœåŠ¡å™¨å¯èƒ½ä¸æ¥å—è¿™ç§æ–¹æ³•æ¥è·å–æ€»å¤§å°ï¼Œå¯èƒ½æ›´å¥½çš„åšæ³•æ˜¯ä½¿ç”¨HEADè¯·æ±‚æ¥è·å–Content-Lengthã€‚ç„¶è€Œï¼ŒHEADå¯èƒ½ä¸è¿”å›Content-Rangeï¼Œéœ€è¦çœ‹æœåŠ¡å™¨æ”¯æŒæƒ…å†µã€‚å½“å‰ç”¨æˆ·çš„åšæ³•æ˜¯å‘é€GETè¯·æ±‚çš„0-0å­—èŠ‚æ¥è§¦å‘æœåŠ¡å™¨è¿”å›Content-Rangeã€‚è¿™æˆ–è®¸å¯è¡Œï¼Œä½†æœ‰äº›æœåŠ¡å™¨å¯èƒ½å¦‚æœæ²¡æœ‰æ­£ç¡®çš„å¤šéƒ¨åˆ†æ”¯æŒï¼Œå¯èƒ½è¿”å›ä¸æ­£ç¡®çš„Content-Lengthã€‚
>
> è¿™ä¸€ç‚¹åœ¨ä»£ç ä¸­å¯èƒ½å­˜åœ¨é£é™©ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœåŠ¡å™¨ä¸æ”¯æŒRangeå¤´ï¼Œé‚£ä¹ˆè¿”å›çš„å¯èƒ½æ˜¯æ•´ä¸ªæ–‡ä»¶ï¼Œè€ŒContent-Rangeå¤´ä¸å­˜åœ¨ã€‚è¿™æ—¶`contentLength`ä¼šè¢«è§£æä¸º0ï¼Œå¯¼è‡´æœ€ç»ˆæŠ›å‡ºé”™è¯¯ã€‚æ­¤æ—¶å°†æ— æ³•ç»§ç»­åˆ†ç‰‡ä¸‹è½½ã€‚è€ŒæŸäº›æœåŠ¡å™¨å³ä½¿ä¸æ”¯æŒåˆ†ç‰‡ï¼Œä¹Ÿä¼šå¿½ç•¥Rangeå¤´ï¼Œè¿”å›å…¨éƒ¨å†…å®¹çš„200OKï¼Œæ­¤æ—¶`contentLength`ä¹Ÿä¼šæ˜¯0ï¼Œä»è€Œå¯¼è‡´åˆ†ç‰‡å¤±è´¥ã€‚è¿™æ ·çš„å¤„ç†æ˜¯å¦æ°å½“ï¼Ÿ
>
> å¯èƒ½ï¼Œå½“æ— æ³•è·å–æ­£ç¡®çš„æ–‡ä»¶å¤§å°æ—¶ï¼Œå‡½æ•°æ— æ³•å·¥ä½œï¼Œä½†ç”¨æˆ·æ­¤æ—¶å¯ä»¥æ•è·é”™è¯¯ï¼Œå›é€€åˆ°æ™®é€šä¸‹è½½æ–¹æ³•ã€‚ç°æœ‰çš„ä»£ç åœ¨è¿™ç§æƒ…å†µä¸‹ä¼šæŠ›å‡ºé”™è¯¯ï¼Œä½†ç”¨æˆ·æ˜¯å¦å¸Œæœ›å¤„ç†è¿™ç§æƒ…å†µï¼Ÿå½“å‰å‡½æ•°è®¾è®¡ä¸ºå¿…é¡»åˆ†ç‰‡ä¸‹è½½ï¼Œæ‰€ä»¥ç¡®å®å¦‚æ­¤ã€‚
>
> å¦å¤–ï¼Œåœ¨è·å–contentLengthæ—¶ï¼Œç”¨æˆ·å¤„ç†äº†å¯èƒ½å‡ºç°çš„å¼‚å¸¸ï¼Œé€šè¿‡æ•è·é”™è¯¯å¹¶è¿”å›0ï¼Œå¯èƒ½å¯¼è‡´åç»­åˆ†ç‰‡é€»è¾‘æ— æ³•æ­£ç¡®æ‰§è¡Œã€‚è¿™æ˜¯å¦éœ€è¦åœ¨é”™è¯¯æ•è·æ—¶æŠ›å‡ºæ›´æ˜ç¡®çš„é”™è¯¯ï¼Ÿä¾‹å¦‚ï¼Œåœ¨æ— æ³•è·å–contentLengthçš„æƒ…å†µä¸‹ï¼Œç›´æ¥rejectæˆ–returnï¼Œè€Œä¸ç»§ç»­åˆ†ç‰‡ï¼Ÿ
>
> ç°åœ¨æµç¨‹æ˜¯è·å–åˆ°contentLengthåï¼Œå¦‚æœå¤§äº0åˆ™ç»§ç»­åˆ†ç‰‡ï¼Œå¦åˆ™æŠ›å‡ºé”™è¯¯ã€‚è¿™åº”è¯¥æ²¡é—®é¢˜ã€‚
>
> å†çœ‹æ¯ä¸ªåˆ†ç‰‡çš„è¯·æ±‚å¤„ç†ï¼š
>
> æ¯ä¸ªåˆ†ç‰‡è¯·æ±‚è¿”å›ä¸€ä¸ªpromiseï¼Œè¯¥promiseä»fetchè¿”å›åå¤„ç†ä¸ºArrayBufferã€‚é€ä¸ªè¿™æ ·å¤„ç†æ˜¯å¦æ­£ç¡®ï¼Ÿ
>
> å¯¹äºæ¯ä¸ªåˆ†ç‰‡è¯·æ±‚ï¼Œå“åº”ä¼šè¢«è½¬æ¢ä¸ºArrayBufferã€‚ä½†å› ä¸ºæ¯ä¸ªåˆ†ç‰‡çš„Rangeä¸åŒï¼Œæ‰€ä»¥ç»“æœçš„éƒ¨åˆ†æ˜¯ä¸åŒçš„ï¼Œåˆå¹¶åæ‰ä¼šæ­£ç¡®ã€‚
>
> æœ€åï¼Œä»£ç å°†æ‰€æœ‰çš„ArrayBufferåˆå¹¶æˆä¸€ä¸ªå¤§çš„ï¼Œç„¶ååŒ…è£…ä¸ºFileå¯¹è±¡è¿”å›ï¼Œå‡è®¾æ–‡ä»¶æ˜¯æ­£ç¡®çš„ã€‚å‡è®¾æ¯æ¬¡åˆ†ç‰‡ä¸‹è½½æ­£ç¡®çš„éƒ¨åˆ†ï¼Œåˆå¹¶é¡ºåºæ­£ç¡®çš„è¯ï¼Œæœ€åçš„æ–‡ä»¶åº”è¯¥æ˜¯å®Œæ•´çš„ã€‚
>
> æ€»ç»“ï¼š
>
> è¿™ä¸ªå‡½æ•°çš„æ•´ä½“é€»è¾‘æ˜¯é€šè¿‡åˆ†å‰²æˆå¤šä¸ªåˆ†ç‰‡ï¼Œå¹¶è¡Œä¸‹è½½æ¯ä¸ªåˆ†ç‰‡çš„å†…å®¹ï¼Œç„¶ååœ¨å…¨éƒ¨å®Œæˆååˆå¹¶æˆä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ã€‚è¿™ç§æ–¹æ³•å¯ä»¥åŠ é€Ÿå¤§æ–‡ä»¶çš„ä¸‹è½½ï¼Œç‰¹åˆ«æ˜¯å½“æœåŠ¡å™¨æ”¯æŒå¹¶è¡Œä¸‹è½½ä¸”ç½‘ç»œå¸¦å®½è¶³å¤Ÿæ—¶ã€‚ä½†éœ€è¦æ³¨æ„ï¼š
>
> 1. æœåŠ¡å™¨å¿…é¡»æ”¯æŒRangeè¯·æ±‚ï¼Œæ­£ç¡®è¿”å›Content-Rangeå¤´éƒ¨ã€‚
>
> 2. åˆå¹¶çš„ArrayBufferçš„é¡ºåºå¿…é¡»æ­£ç¡®ã€‚
>
> 3. é”™è¯¯å¤„ç†éœ€è¦å®Œå–„ï¼Œå°¤å…¶æ˜¯æŸä¸ªåˆ†ç‰‡å¤±è´¥çš„æƒ…å†µã€‚
>
> 4. é¢‘ç¹çš„è¿›åº¦æ›´æ–°å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œéœ€æµ‹è¯•éªŒè¯ã€‚
>
> å¯èƒ½çš„æ”¹è¿›ç‚¹åŒ…æ‹¬ï¼šå¯¹åˆ†ç‰‡å¤±è´¥çš„é‡è¯•æœºåˆ¶ã€æ›´å‡†ç¡®çš„Content-Lengthè·å–æ–¹æ³•ï¼ˆä¾‹å¦‚ä½¿ç”¨HEADè¯·æ±‚ï¼‰ã€åŠ¨æ€è°ƒæ•´åˆ†ç‰‡æ•°æ ¹æ®å®é™…ç½‘ç»œæƒ…å†µç­‰ã€‚
>
> ç”¨æˆ·å¯èƒ½è¿˜æƒ³äº†è§£è¿™æ®µä»£ç çš„å…·ä½“å®ç°ç»†èŠ‚ã€æ½œåœ¨çš„é—®é¢˜ä»¥åŠå¦‚ä½•ä¼˜åŒ–ï¼Œç‰¹åˆ«æ˜¯å¦åœ¨æœåŠ¡å™¨æ”¯æŒåˆ†ç‰‡ä¸‹è½½çš„æƒ…å†µä¸‹é€‚ç”¨ï¼Œæˆ–è€…æœ‰å“ªäº›æ½œåœ¨çš„é—®é¢˜éœ€è¦æ³¨æ„ï¼Œå¦‚å¤§æ–‡ä»¶çš„å†…å­˜å ç”¨é—®é¢˜ï¼ˆå› ä¸ºæ‰€æœ‰åˆ†ç‰‡éœ€è¦å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­åˆå¹¶ï¼‰ã€‚
>
> 



è¿™ä¸ª `parallelDownload` å‡½æ•°é€šè¿‡ **HTTP Range è¯·æ±‚**å’Œ **å¤šçº¿ç¨‹å¹¶è¡Œä¸‹è½½** æŠ€æœ¯å®ç°äº†å¤§æ–‡ä»¶åˆ†ç‰‡ä¸‹è½½ã€‚ä»¥ä¸‹æ˜¯å¯¹å…¶è®¾è®¡æ€è·¯ã€æŠ€æœ¯ç»†èŠ‚å’Œæ½œåœ¨ä¼˜åŒ–çš„åˆ†æ­¥è¯¦è§£ï¼š

---

### **ä¸€ã€æ ¸å¿ƒæµç¨‹è§£æ**
#### **1. è·å–æ–‡ä»¶æ€»å¤§å°ï¼ˆContent-Lengthï¼‰**
```typescript
const contentLength = await fetch(url, { 
  method: 'GET',
  headers: { Range: 'bytes=0-0' } // âœ¨ å…³é”®ç‚¹ï¼šä»…è¯·æ±‚é¦–å­—èŠ‚
}).then(resp => {
  // ä» Content-Range æå–æ€»å¤§å°ï¼ˆå¦‚ "bytes 0-0/12345" â†’ 12345ï¼‰
  return parseInt(resp.headers.get('Content-Range')?.match(/\/(\d+)/)?.[1] || '0');
});
```
- **å®ç°å…³é”®**ï¼šé€šè¿‡å¸¦ `Range: bytes=0-0` å¤´çš„ GET è¯·æ±‚ï¼Œâ€œå·å–â€æœåŠ¡å™¨è¿”å›çš„å®Œæ•´æ–‡ä»¶å¤§å°ï¼ˆ`Content-Range` ä¸­çš„æ€»å­—èŠ‚æ•°ï¼‰ã€‚
- **é£é™©**ï¼šè‹¥æœåŠ¡å™¨ä¸æ”¯æŒ Range è¯·æ±‚ï¼ˆè¿”å› 200 è€Œé 206ï¼‰ï¼Œå‡½æ•°ä¼šå¤±è´¥æŠ›å‡ºå¼‚å¸¸ã€‚

#### **2. åˆ†ç‰‡ä¸‹è½½ä»»åŠ¡è°ƒåº¦**
```typescript
const chunkSize = Math.ceil(contentLength / SPLIT_NUM); // è®¡ç®—åˆ†ç‰‡å¤§å°ï¼ˆå‘ä¸Šå–æ•´ï¼‰

const promises = downloadedBytes.map((v, index) => {
  const start = index * chunkSize;
  const end = Math.min(start + chunkSize - 1, contentLength); // âœ¨ é¿å…è¶Šç•Œ

  return fetch(url, { 
    headers: { Range: `bytes=${start}-${end}` } // ä¸ºæ¯ä¸ªåˆ†ç‰‡æŒ‡å®šåŒºé—´
  }).then(response => { ... });
});
```
- **åˆ†ç‰‡ç­–ç•¥**ï¼šå°†æ–‡ä»¶å‡åŒ€åˆ‡å‰²æˆ `SPLIT_NUM` ä¸ªå­åŒºé—´ï¼ˆæœ€åä¸€ç‰‡å¯èƒ½ç•¥å°ï¼‰ã€‚
- **å¹¶è¡Œåº¦æ§åˆ¶**ï¼šæ¯ä¸ªåˆ†ç‰‡é€šè¿‡ç‹¬ç«‹ Promise å¯åŠ¨ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨ç®¡ç†å¹¶è¡Œè¯·æ±‚ï¼ˆé€šå¸¸å—åŒåŸŸåæœ€å¤§å¹¶å‘é™åˆ¶ï¼Œå¦‚ 6ï¼‰ã€‚

#### **3. æµå¼æ¥æ”¶ä¸è¿›åº¦è·Ÿè¸ª**
```typescript
const reader = response.body.getReader();
const stream = new ReadableStream({
  async start(controller) {
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      downloadedBytes[index] += value.byteLength; // å®æ—¶è®°å½•æœ¬åˆ†ç‰‡è¿›åº¦
      const total = downloadedBytes.reduce((acc, v) => acc + v, 0);
      options?.onProcess?.( (total / contentLength) * 100 ); // âœ¨ å›è°ƒé€šçŸ¥è¿›åº¦
      controller.enqueue(value);
    }
  }
});
```
- **æµå¼å¤„ç†ä¼˜åŠ¿**ï¼šæ— éœ€ç­‰å¾…æ•´ä¸ªåˆ†ç‰‡å®Œå…¨ä¸‹è½½ï¼Œé€å—æ¥æ”¶æ•°æ®å‡å°‘å†…å­˜å³°å€¼ã€‚
- **è¿›åº¦ç²¾ç¡®æ€§**ï¼šæ¯ä¸ªæ•°æ®å—ï¼ˆ`value`ï¼‰åˆ°è¾¾æ—¶ç«‹å³ç´¯åŠ å¯¹åº”åˆ†ç‰‡çš„ `downloadedBytes[index]`ï¼Œç¡®ä¿æ€»è¿›åº¦å®æ—¶å‡†ç¡®ã€‚

#### **4. æ•°æ®åˆå¹¶ä¸è¿”å›**
```typescript
Promise.all(promises).then(chunks => {
  const mergedBuffer = mergeArrayBuffers(chunks); // âš ï¸è‡ªå®šä¹‰åˆå¹¶å‡½æ•°éœ€ä¿è¯é¡ºåºæ­£ç¡®
  return new File([mergedBuffer], fileName);
});
```
- **åˆ†ç‰‡é¡ºåºä¿è¯**ï¼š`Promise.all` ä¼šæŒ‰åˆ†ç‰‡ç´¢å¼•é¡ºåºè¿”å›ç»“æœæ•°ç»„ `chunks`ï¼Œç¡®ä¿åˆå¹¶é¡ºåºæ­£ç¡®ã€‚
- **å†…å­˜æ³¨æ„äº‹é¡¹**ï¼šå¤§æ–‡ä»¶å®Œå…¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¯èƒ½å ç”¨è¾ƒå¤šèµ„æºï¼ˆä¼˜åŒ–æ€è·¯è§ä¸‹æ–‡ï¼‰ã€‚

---

### **äºŒã€ä»£ç å…³é”®ç»†èŠ‚**
#### **1. HTTP Range è§„èŒƒ**
- **åˆæ³• Range ç¤ºä¾‹**ï¼š
  - `Range: bytes=0-499` â†’ ä¸‹è½½å‰ 500 å­—èŠ‚ã€‚
  - `Range: bytes=500-999` â†’ ä¸‹è½½ç¬¬äºŒä¸ª 500 å­—èŠ‚ã€‚
- **æœåŠ¡å™¨è¦æ±‚**ï¼šå¿…é¡»å“åº” `206 Partial Content` çŠ¶æ€ç ï¼Œå¹¶åœ¨ `Content-Range` å¤´éƒ¨è¿”å›å®é™…å‘é€çš„å­—èŠ‚åŒºé—´å’Œå®Œæ•´å¤§å°ã€‚

#### **2. åˆ†ç‰‡ä¸‹è½½çš„æµè§ˆå™¨è¡Œä¸º**
- **å¹¶è¡Œé™åˆ¶**ï¼šæµè§ˆå™¨å¯¹åŒä¸€åŸŸåæœ‰å¹¶å‘è¯·æ±‚æ•°é™åˆ¶ï¼ˆé€šå¸¸ 6ï¼‰ï¼Œè¶…è¿‡é™åˆ¶çš„è¯·æ±‚ä¼šè¢«æ’é˜Ÿã€‚
- **ä¼˜åŒ–å»ºè®®**ï¼šåŠ¨æ€è°ƒæ•´ `splitNumber` ä¸ºå®é™…å¹¶å‘ä¸Šé™å€¼ï¼ˆå¦‚ 4ï¼‰ã€‚

#### **3. ReadableStream çš„ä½œç”¨**
- **é€å—å¤„ç†**ï¼šä»ç½‘ç»œæµä¸­æŒ‰å—ï¼ˆChunkï¼‰æ¥æ”¶æ•°æ®ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªåˆ†ç‰‡åˆ°å†…å­˜ã€‚
- **å®æ—¶æ€§**ï¼šæ¯æ”¶åˆ°ä¸€ä¸ªæ•°æ®å—ç«‹å³æ›´æ–°è¿›åº¦ï¼Œè€Œéç­‰å¾…æ•´ä¸ªåˆ†ç‰‡ä¸‹è½½å®Œæ¯•ã€‚

---

### **ä¸‰ã€æ½œåœ¨é—®é¢˜ä¸ä¼˜åŒ–**
#### **1. è·¨åˆ†ç‰‡æ•°æ®è¾¹ç•Œé—®é¢˜**
- **é£é™©**ï¼šè‹¥æœåŠ¡å™¨åŠ¨æ€ç”Ÿæˆæ–‡ä»¶ï¼ˆå¦‚å®æ—¶å‹ç¼©ï¼‰ï¼Œåˆ†ç‰‡å¤„å¯èƒ½å‡ºç°æ•°æ®æ–­è£‚ï¼ˆæ¯”å¦‚ä¸€ä¸ªåˆ†ç‰‡ç»“æŸåœ¨ ZIP æ–‡ä»¶çš„ä¸­é—´æ¡ç›®ï¼‰ã€‚
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - ä»…å¯¹é™æ€æ–‡ä»¶ï¼ˆå¦‚å·²çŸ¥çš„å›ºå®šå¤§å°æ–‡ä»¶ï¼‰ä½¿ç”¨æ­¤æ–¹æ³•ã€‚
  - åˆå¹¶åè¿›è¡Œå®Œæ•´æ€§æ ¡éªŒï¼ˆå¦‚ MD5 æ¯”å¯¹ã€è§£å‹æµ‹è¯•ï¼‰ã€‚

#### **2. åˆ†ç‰‡è¯·æ±‚å¤±è´¥å¤„ç†**
```typescript
// å½“å‰ä»£ç ï¼ˆä»»ä¸€å¤±è´¥åˆ™æ•´ä½“å¤±è´¥ï¼‰
Promise.all(promises).then(...).catch(...);

// ä¼˜åŒ–æ–¹æ¡ˆï¼šå…è®¸é‡è¯•å¤±è´¥åˆ†ç‰‡
const withRetry = (promiseCreator, retries = 3) => {
  return promiseCreator().catch(err => 
    retries > 0 ? withRetry(promiseCreator, retries - 1) : Promise.reject(err)
  );
};

// æ›¿æ¢åŸ promises æ•°ç»„
const promises = downloadedBytes.map((v, index) => 
  withRetry(() => createFetchPromise(index))
);
```

#### **3. è¶…å¤§æ–‡ä»¶å†…å­˜ä¼˜åŒ–**
- **å½“å‰é—®é¢˜**ï¼šæ‰€æœ‰åˆ†ç‰‡æ•°æ®éœ€åœ¨å†…å­˜ä¸­åˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´ `ArrayBuffer`ï¼Œå¯èƒ½è¶…å‡ºå†…å­˜é™åˆ¶ã€‚
- **æ›¿ä»£æ–¹æ¡ˆ**ï¼šåˆå¹¶é˜¶æ®µä½¿ç”¨ [Streams API](https://developer.mozilla.org/en-US/docs/Web/API/Streams_API) æµå¼å†™å…¥ç£ç›˜ï¼Œå¤§å¹…å‡å°‘å†…å­˜å ç”¨ï¼š
  ```typescript
  const fileStream = new FileWriterStream('example.zip');
  for (const chunk of chunks) {
    await fileStream.write(chunk);
  }
  ```

#### **4. åŠ¨æ€è°ƒæ•´åˆ†ç‰‡æ•°**
- **æŒ‰æ–‡ä»¶å¤§å°è‡ªé€‚åº”åˆ‡åˆ†**ï¼š
  ```typescript
  const MAX_CHUNK_SIZE = 10 * 1024 * 1024; // æ¯ä¸ªåˆ†ç‰‡æœ€å¤§ 10MB
  const splitNumber = Math.ceil(contentLength / MAX_CHUNK_SIZE);
  ```

---

### **å››ã€é€‚ç”¨åœºæ™¯å»ºè®®**
1. **å¤§æ–‡ä»¶ä¸‹è½½åŠ é€Ÿ**ï¼šå°¤å…¶é€‚åˆ CDN æˆ–æ”¯æŒé«˜å¹¶å‘çš„é™æ€èµ„æºæœåŠ¡å™¨ã€‚
2. **æœåŠ¡å™¨æ”¯æŒ Range è¯·æ±‚**ï¼šå¿…é¡»ç¡®è®¤ç›®æ ‡ URL æ”¯æŒ `206 Partial Content`ã€‚

```js
export const parallelDownload = async (
  url: string,
  options?: { splitNumber?: number, onProcess?: (v: number, total: number) => void, }
) => {
  const SPLIT_NUM = options?.splitNumber || 4
  const downloadedBytes = new Array<number>(SPLIT_NUM).fill(0)
  const contentLength = await fetch(url, {
    method: 'GET',
    credentials: 'omit',
    // Partial è¯·æ±‚ï¼Œè·å– Content-Range
    headers: { Range: 'bytes=0-0' },
  }).then(resp => {
    const contentLength = resp.headers.get('Content-Range')?.match(/\/(\d+)/)?.[1] || ''
    return parseInt(contentLength) || 0
  }).catch((err) => {
    ConsoleUtil.error(err)
    return 0
  })
  if (contentLength > 0) {
    const chunkSize = Math.ceil(contentLength / 4)
    let cursor = 0
    const promises = downloadedBytes.map((v, index) => {
      cursor = chunkSize * index
      return fetch(url, {
        method: 'GET',
        credentials: 'omit',
        headers: {
          Range: `bytes=${cursor}-${Math.min(cursor + chunkSize - 1, contentLength)}`,
        },
      }).then(response => {
        const reader = response?.body?.getReader();

        return new ReadableStream({
          async start(controller) {
            while (true) {
              const { done, value } = await reader?.read() || {}
              if (done) {
                controller.close()
                break
              }
              downloadedBytes[index] += value?.byteLength || 0
              const progress = (downloadedBytes.reduce((acc, v) => acc + v, 0) / contentLength) * 100;
              options?.onProcess?.(progress, contentLength)
              controller.enqueue(value);
            }
          }
        });
      })
        .then(stream => new Response(stream))
        .then(response => response.arrayBuffer())
    })
    return Promise.all(promises)
      .then(chunks => {
        const zipName = getZipFileNameFromUrl(url, 'file.zip')
        const mergedArrayBuffer = mergeArrayBuffers(chunks)
        return new File([mergedArrayBuffer], zipName, { type: 'application/octet-stream' })
      })
  } else {
    throw 'Partial download failed'
  }
}
```
4. **æµè§ˆå™¨ç«¯å¤§æ–‡ä»¶æ“ä½œ**ï¼šéœ€ç»“åˆ `File API` æˆ– `IndexedDB` å­˜å‚¨åˆå¹¶ç»“æœã€‚

---

å¦‚æœéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–æˆ–è§£å†³ç‰¹å®šè¾¹ç•Œæƒ…å†µï¼ˆå¦‚æ–­ç‚¹ç»­ä¼ ã€æœåŠ¡ç«¯ Range éªŒè¯ï¼‰ï¼Œå¯ç»“åˆå…·ä½“éœ€æ±‚è°ƒæ•´è®¾è®¡ã€‚

> ğŸ’­ å—¯ï¼Œç”¨æˆ·è®©æˆ‘ç»§ç»­åˆ†æ`mergeArrayBuffers`å‡½æ•°ã€‚ä»–ä¹‹å‰å¯èƒ½å·²ç»å¾—åˆ°äº†ä¸€äº›åˆæ­¥çš„è§£é‡Šï¼Œç°åœ¨éœ€è¦æ›´æ·±å…¥çš„ç†è§£æˆ–è€…å‘ç°äº†æ½œåœ¨çš„é—®é¢˜ï¼Ÿ
>
> é¦–å…ˆï¼Œæˆ‘è¦å›é¡¾å‡½æ•°çš„ä»£ç é€»è¾‘ã€‚å‡½æ•°çš„ä½œç”¨æ˜¯åˆå¹¶å¤šä¸ªArrayBufferï¼Œè®¡ç®—æ€»é•¿åº¦ï¼Œåˆ›å»ºä¸€ä¸ªå¤§ç¼“å†²åŒºï¼Œç„¶åç”¨Uint8Arrayé€ä¸ªå¤åˆ¶æ•°æ®ã€‚è¿™çœ‹èµ·æ¥æ˜¯æ ‡å‡†çš„åšæ³•ï¼Œä½†æ˜¯æœ‰æ²¡æœ‰éšè—çš„é—®é¢˜å‘¢ï¼Ÿ
>
> å¯èƒ½çš„é—®é¢˜ç‚¹ä¹‹ä¸€æ˜¯æ€§èƒ½ã€‚å¦‚æœchunkså¾ˆå¤§æˆ–æ•°é‡å¾ˆå¤šï¼ŒforEachå¾ªç¯é€ä¸ªå¤åˆ¶ä¼šä¸ä¼šæ¯”è¾ƒæ…¢ï¼Ÿè™½ç„¶å¯¹äºæ™®é€šä½¿ç”¨æ²¡é—®é¢˜ï¼Œä½†æµ·é‡æ•°æ®å¯èƒ½æœ‰ç“¶é¢ˆã€‚
>
> å…¶æ¬¡ï¼Œç±»å‹å®‰å…¨é—®é¢˜ã€‚Uint8Arrayæ˜¯å¤„ç†å­—èŠ‚çš„å¥½é€‰æ‹©ï¼Œä½†å¦‚æœæŸäº›chunkä¸æ˜¯Uint8Arrayè§†å›¾åˆ›å»ºçš„ï¼Œæ¯”å¦‚å…¶ä»–ç±»å‹çš„TypedArrayæˆ–DataViewï¼Œä¼šä¸ä¼šå‡ºé”™ï¼Ÿæˆ–è€…å½“åŸå§‹ArrayBufferè¢«æ›´æ”¹æ—¶ï¼Œåˆå¹¶åçš„æ•°æ®ä¼šä¸ä¼šä¸åŒæ­¥ï¼Ÿ
>
> å†…å­˜ä½¿ç”¨ä¹Ÿæ˜¯ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„ç‚¹ã€‚åˆå¹¶åçš„æ–°ArrayBufferä¼šä¸€æ¬¡æ€§åˆ†é…å¾ˆå¤§çš„å†…å­˜ï¼Œå¦‚æœtotalLengthéå¸¸å¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä¸è¶³ï¼Œå°¤å…¶æ˜¯åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ã€‚
>
> é”™è¯¯å¤„ç†æ–¹é¢ï¼Œå‡½æ•°ç°åœ¨æ²¡æœ‰å¯¹chunksçš„æœ‰æ•ˆæ€§åšæ£€æŸ¥ï¼Œæ¯”å¦‚æ˜¯å¦æ¯ä¸ªå…ƒç´ éƒ½æ˜¯æœ‰æ•ˆçš„ArrayBufferï¼Œæˆ–è€…æœ‰æ²¡æœ‰å¯èƒ½ä¼ å…¥nullæˆ–undefinedã€‚è¿™å¯èƒ½å¼•å‘è¿è¡Œæ—¶é”™è¯¯ã€‚
>
> å¦å¤–ï¼Œæ˜¯å¦æœ‰æ›´ç®€æ´çš„å®ç°æ–¹å¼ï¼Ÿæ¯”å¦‚ä½¿ç”¨Blobå¯¹è±¡çš„åˆå¹¶æ–¹æ³•ï¼Œä¸è¿‡ç»“æœç±»å‹å¯èƒ½ä¸åŒï¼ŒArrayBufferå’ŒBlobæœ‰ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚
>
> ç”¨æˆ·å¯èƒ½æ˜¯å¼€å‘è€…ï¼Œå¤„ç†æµå¼æ•°æ®æˆ–åˆ†ç‰‡ä¼ è¾“ï¼Œæ¯”å¦‚æ–‡ä»¶ä¸Šä¼ ã€WebSocketåˆ†ç‰‡ç­‰ã€‚ä»–åœ¨ç¡®ä¿åˆå¹¶çš„æ­£ç¡®æ€§å’Œæ•ˆç‡å¯èƒ½é‡åˆ°é—®é¢˜ï¼Œæˆ–è€…éœ€è¦ä¼˜åŒ–ç°æœ‰ä»£ç ã€‚å¯èƒ½æ›´æ·±å±‚æ¬¡çš„éœ€æ±‚æ˜¯å¤„ç†å¤§æ•°æ®é‡åˆå¹¶æ—¶çš„æ€§èƒ½é—®é¢˜ï¼Œæˆ–è€…å¯»æ±‚æ›´å¥å£®çš„è§£å†³æ–¹æ¡ˆã€‚
>
> æ¯”å¦‚ï¼Œåœ¨å¤„ç†éå¸¸å¤§çš„chunksæ•°ç»„æ—¶ï¼Œæ˜¯å¦éœ€è¦æ”¹ç”¨æ›´é«˜æ•ˆçš„æ–¹æ³•ï¼Œæ¯”å¦‚åˆ©ç”¨TextDecoder/Encoderæˆ–ç›´æ¥æ“ä½œç¼“å†²åŒºï¼Ÿæˆ–è€…æ˜¯å¦éœ€è¦åˆ†æ‰¹æ¬¡å¤„ç†ä»¥é¿å…ä¸»çº¿ç¨‹é˜»å¡ï¼Ÿ
>
> è€ƒè™‘åˆ°è¿™äº›æ½œåœ¨é—®é¢˜ï¼Œæˆ‘åº”è¯¥æŒ‡å‡ºå‡½æ•°çš„ç°æœ‰ä¼˜ç¼ºç‚¹ï¼Œå¯èƒ½çš„æ”¹è¿›æ–¹å‘ï¼Œä¾‹å¦‚é”™è¯¯å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼Œä»¥åŠæ›¿ä»£æ–¹æ¡ˆçš„ä½¿ç”¨åœºæ™¯ã€‚
>
> 



è¦æ·±å…¥åˆ†æè¿™ä¸ª `mergeArrayBuffers` å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä»å®ç°åŸç†ã€ä½¿ç”¨åœºæ™¯ã€æ½œåœ¨é—®é¢˜å’Œä¼˜åŒ–æ”¹è¿›å››ä¸ªè§’åº¦å±•å¼€ï¼š

---

### **1. å®ç°åŸç†åˆ†æ**
- **æ­¥éª¤æ‹†è§£**
  - **æ€»é•¿åº¦è®¡ç®—**  
    é€šè¿‡ `reduce` è®¡ç®—æ‰€æœ‰ `ArrayBuffer` çš„æ€»é•¿åº¦ï¼Œç¡®ä¿æ–°åˆ›å»ºçš„ç¼“å†²åŒºèƒ½å¤Ÿå®¹çº³å…¨éƒ¨æ•°æ®
    ```typescript
    chunks.reduce((total, chunk) => total + chunk.byteLength, 0)
    ```
  - **ç¼“å†²åŒºåˆå§‹åŒ–**  
    `new ArrayBuffer(totalLength)` åˆ›å»ºä¸€ä¸ªå¤§å°åŒ¹é…çš„äºŒè¿›åˆ¶å®¹å™¨
  - **æ•°æ®æ‹¼æ¥**  
    ä½¿ç”¨ `Uint8Array.set()` æ–¹æ³•é€ä¸ªæ‹·è´æ¯ä¸ª chunk çš„äºŒè¿›åˆ¶æ•°æ®åˆ°æ–°ç¼“å†²åŒºï¼Œé€šè¿‡ `offset` æŒ‡é’ˆè®°å½•å†™ä½ç½®

- **å…³é”®ç‚¹**
  - **æ— æ•°æ®ç±»å‹å‡è®¾**  
    ä½¿ç”¨ `Uint8Array` è€Œä¸æ˜¯å…¶ä»–ç±»å‹è§†å›¾ï¼ˆå¦‚ `Int32Array`ï¼‰ï¼Œä¿è¯ä»»æ„æ ¼å¼çš„äºŒè¿›åˆ¶æ•°æ®éƒ½èƒ½æ­£ç¡®æ‹·è´
  - **é¡ºåºå®Œæ•´æ€§**  
    `offset` æŒ‡é’ˆç¡®ä¿åˆ†ç‰‡çš„é¡ºåºä¸¥æ ¼ä¿æŒåŸå§‹æ’åˆ—é¡ºåº

---

### **2. ä½¿ç”¨åœºæ™¯**
- **Web å¼€å‘å¸¸è§åº”ç”¨**
  1. **åˆ†ç‰‡ä¸Šä¼ /ä¸‹è½½**  
     åˆå¹¶æ¥è‡ªç½‘ç»œçš„åˆ†ç‰‡æ•°æ®ï¼ˆå¦‚å¤§æ–‡ä»¶åˆ‡å‰²ä¼ è¾“ï¼‰
  2. **WebSocket æ¶ˆæ¯å¤„ç†**  
     ç²˜åŒ…å¤„ç†æ—¶éœ€è¦åˆå¹¶å¤šä¸ªæ¶ˆæ¯ç‰‡æ®µ
  3. **Web Crypto API**  
     å¤„ç†åŠ å¯†æ“ä½œç”Ÿæˆçš„åˆ†ç‰‡ç»“æœ
  4. **Canvas/WebGL æ“ä½œ**  
     åˆå¹¶å›¾åƒåƒç´ æ•°æ®ç­‰äºŒè¿›åˆ¶æ“ä½œ
  
---

### **3. æ½œåœ¨é—®é¢˜**
#### **3.1 å†…å­˜åˆ†é…é£é™©**
```typescript
const mergedBuffer = new ArrayBuffer(totalLength) // å¯èƒ½è§¦å‘ OOM é”™è¯¯
```
- **é£é™©æ¡ˆä¾‹**  
  å½“ `totalLength` â‰¥ 1GB æ—¶ï¼Œåœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹å¯èƒ½å› å†…å­˜ä¸è¶³å¯¼è‡´åˆ†é…å¤±è´¥ï¼ˆä¸åŒæµè§ˆå™¨ V8 å¼•æ“çš„å †å†…å­˜é™åˆ¶ä¸åŒï¼‰

#### **3.2 å¤§æ•°ç»„æ€§èƒ½ç“¶é¢ˆ**
- **å®æµ‹ä»£ç ç‰‡æ®µ**
  ```javascript
  // æµ‹è¯• 10 ä¸‡ä¸ª 1KB åˆ†ç‰‡çš„åˆå¹¶æ€§èƒ½
  const chunks = Array(100000).fill().map(() => new ArrayBuffer(1024));
  console.time('merge');
  mergeArrayBuffers(chunks);
  console.timeEnd('merge'); // Chrome ä¸‹çº¦ 300-500ms
  ```
- **åˆ†æåŸå› **  
  é€ä¸ªæ‹·è´å°åˆ†ç‰‡å¯¼è‡´é¢‘ç¹çš„ JS â†’ Native ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆæ¯æ¬¡ `set()` è°ƒç”¨éƒ½è¦è§¦å‘åº•å±‚å†…å­˜æ‹·è´ï¼‰

#### **3.3 æ•°æ®æ„å¤–ä¿®æ”¹**
- **åœºæ™¯æ¼”ç¤ºèŒƒä¾‹**
  ```javascript
  const chunk1 = new Uint8Array([1,2,3]).buffer;
  const merged = mergeArrayBuffers([chunk1]);
  
  // ä¿®æ”¹åŸå§‹åˆ†ç‰‡åå·²åˆå¹¶æ•°æ®ä¸å—å½±å“ â€”â€” è¿™æ˜¯ä¸€ä¸ªå®‰å…¨è¡Œä¸º
  new Uint8Array(chunk1)[0] = 99;
  console.log(new Uint8Array(merged)); // ä»è¾“å‡º [1,2,3]
  ```
- **éšæ€§é£é™©**  
  å¦‚æœä¼ å…¥çš„ chunks åŒ…å«é `ArrayBuffer` å¯¹è±¡ï¼ˆå¦‚ `SharedArrayBuffer` æˆ–å…¶ä»–ç±»ä¼¼ buffer çš„ç»“æ„ï¼‰ï¼Œåˆ™å¯èƒ½å¼•å‘ä¸å¯é¢„æœŸçš„è¡Œä¸º

---

### **4. ä¼˜åŒ–æ”¹è¿›æ–¹å‘**
#### **4.1 å†…å­˜å®‰å…¨å¤„ç†**
```typescript
function safeMerge(chunks: ArrayBuffer[]): ArrayBuffer | null {
  try {
    const totalLength = chunks.reduce((t, c) => t + c.byteLength, 0);
    return mergeArrayBuffers(chunks);
  } catch (e) {
    console.error('Allocation failed:', e);
    return null; // æˆ–æŠ›å‡ºè‡ªå®šä¹‰é”™è¯¯
  }
}
```

#### **4.2 åˆ†å—åˆå¹¶ä¼˜åŒ–**
```typescript
// åˆ†æ‰¹åˆå¹¶ä»¥å‡å°‘è°ƒç”¨æ¬¡æ•°ï¼ˆæ¯æ‰¹æœ€å¤š 1000 ä¸ªåˆ†ç‰‡ï¼‰
const BATCH_SIZE = 1000;
let merged = new Uint8Array(totalLength);
for (let i=0; i<chunks.length; i+=BATCH_SIZE) {
  const batch = chunks.slice(i, i+BATCH_SIZE)
                     .map(c => new Uint8Array(c));
  const batchMerged = Uint8Array.from(batch.flat());
  merged.set(batchMerged, i * BATCH_SIZE);
}
```

#### **4.3 ç±»å‹å®‰å…¨æ£€æŸ¥**
```typescript
function validateChunks(chunks: unknown[]): chunks is ArrayBuffer[] {
  return chunks.every(c => c instanceof ArrayBuffer && !(c instanceof SharedArrayBuffer));
}

if (!validateChunks(chunks)) {
  throw new TypeError("Invalid chunk type");
}
```

#### **4.4 é›¶æ‹·è´æ–¹æ¡ˆï¼ˆé«˜çº§ï¼‰**
ä½¿ç”¨ WebAssembly çš„ `memory.buffer` ç›´æ¥æ“ä½œå†…å­˜ï¼š
```javascript
// å‡è®¾å·²åˆå§‹åŒ– wasm å†…å­˜å®ä¾‹
const memory = new WebAssembly.Memory({ initial: 1 });
const mergedBuffer = memory.buffer;

// åœ¨ wasm æ¨¡å—ä¸­ä½¿ç”¨ memcpy ç­‰åº•å±‚æ–¹æ³•é«˜æ•ˆæ‹·è´
// ï¼ˆéœ€è¦é…å¥—çš„ C/Rust å®ç°ç›¸å…³å†…å­˜æ“ä½œï¼‰
```

#### **4.5 Blob æ›¿ä»£æ–¹æ¡ˆ**
å¦‚æœä¸éœ€è¦ç«‹å³è®¿é—®äºŒè¿›åˆ¶å†…å®¹ï¼Œå¯ç”¨ Blob åˆå¹¶ï¼š
```typescript
const blob = new Blob(chunks);
// éœ€è¦æ—¶è½¬ä¸º ArrayBuffer
blob.arrayBuffer().then(buffer => {...});
```

---

### **5. æ€»ç»“å»ºè®®**
- âœ… **æ­£ç¡®æ€§ä¼˜å…ˆ**  
  åŸå‡½æ•°åœ¨å¸¸è§„ä½¿ç”¨åœºæ™¯ä¸‹åŠŸèƒ½æ­£ç¡®
- âš ï¸ **æ³¨æ„å¤§è§„æ¨¡æ•°æ®**  
  éœ€è¦å¢åŠ å†…å­˜åˆ†é…å¤±è´¥å¤„ç†å’Œåˆ†æ®µåˆå¹¶ä¼˜åŒ–
- ğŸ”§ **å¢å¼ºé²æ£’æ€§**  
  å»ºè®®æ·»åŠ å‚æ•°ç±»å‹æ ¡éªŒ
- ğŸš€ **æ€§èƒ½å…³é”®è·¯å¾„**  
  å¯¹æµ·é‡åˆ†ç‰‡ï¼ˆå¦‚ 10 ä¸‡+ï¼‰å»ºè®®ä½¿ç”¨ Web Worker åˆ†çº¿ç¨‹å¤„ç†åˆå¹¶æ“ä½œ
