<img width="1154" alt="image" src="https://github.com/user-attachments/assets/9cd19045-6839-41db-928c-7acf54f4f296" />
### 一：简介
Lighthouse是一款自动化开源工具，用于提升网页质量。开发者可以针对具体某个页面进行性能优化从而运行它，Lighthouse就会对该页面进行打分评估，给出有针对性的审核，其中包含了对性能、无障碍功能、最佳做法、搜索引擎优化（SEO）等方面的审核，并给出具体的审核分数及相关问题和建议的指导。

### 二：如何使用
1. 打开谷歌浏览器控制台，切换到Lighthouse选项。
2. 点击“分析网页加载情况”按钮。加载如图所示。审核期间你在界面上做了那些操作，它会自动记录你操作的过程，并对整个过程涉及到的界面进行综合审核评分。
### Lighthouse审核完成后的审核评分情况：

- **性能**：29
- **无障碍**：81
- **最佳做法**：74
- **SEO**：67

### 三：评分模块和相关指标说明

**性能**是比较重要的审核模块，性能得分分为3个情况：
- 0 - 49（红色）：差
- 50 到 89（橙色）：需要改进
- 90 到 100（绿色）：良好

**性能**得分：29

性能评分包含5个指标，如下图所示：
- **首次内容绘制**：5.2秒
- **最大内容绘制**：12.6秒
- **总阻塞时间**：700毫秒
- **速度指数**：16.0秒
- **意外的布局偏移**：0.052
<img width="616" alt="image" src="https://github.com/user-attachments/assets/6a0415b8-8ad8-4f8f-b306-423af897dc3b" />

这几个指标是衡量网页性能的重要指标，分别反映了页面加载和用户体验的不同方面。以下是每个指标的详细解释：

### 1. 首次内容绘制（First Contentful Paint, FCP）
**含义**：首次内容绘制是指浏览器从开始加载到页面上任何内容（如文本、图像、SVG等）首次绘制的时间。这个指标反映了页面开始显示内容的速度。
**示例值**：2.0秒
**解释**：页面在2.0秒内首次显示内容。

### 2. 最大内容绘制（Largest Contentful Paint, LCP）
**含义**：最大内容绘制是指页面加载过程中，视口内最大可见内容元素（如图像、视频、块级文本等）完全加载并渲染的时间。这个指标反映了页面主要内容的加载速度。
**示例值**：26.5秒
**解释**：页面在26.5秒内完成最大内容的加载和渲染。

### 3. 总阻塞时间（Total Blocking Time, TBT）
**含义**：总阻塞时间是指从首次内容绘制（FCP）到可交互时间（Time to Interactive, TTI）之间，主线程被长任务（超过50毫秒的任务）阻塞的总时间。这个指标反映了页面在加载过程中响应用户输入的能力。
**示例值**：1,720毫秒
**解释**：在页面加载过程中，主线程被长任务阻塞了1,720毫秒。

### 4. 速度指数（Speed Index, SI）
**含义**：速度指数是指页面内容在视口内可见的速度。它通过计算页面在加载过程中各个时间点的可见内容比例来衡量页面的加载速度。速度指数越低，页面加载速度越快。
**示例值**：26.0秒
**解释**：页面内容在26.0秒内逐渐变得可见。

### 5. 累积布局偏移（Cumulative Layout Shift, CLS）
**含义**：累积布局偏移是指页面在加载过程中发生的所有意外布局偏移的总和。布局偏移是指页面元素在没有用户输入的情况下发生位置变化。这个指标反映了页面的视觉稳定性。
**示例值**：0.567
**解释**：页面在加载过程中发生了较大的布局偏移，可能会影响用户体验。

### 总结
这些指标共同反映了页面的加载性能和用户体验：
- **首次内容绘制（FCP）**：页面开始显示内容的速度。
- **最大内容绘制（LCP）**：页面主要内容的加载速度。
- **总阻塞时间（TBT）**：页面在加载过程中响应用户输入的能力。
- **速度指数（SI）**：页面内容在视口内可见的速度。
- **累积布局偏移（CLS）**：页面的视觉稳定性。

通过优化这些指标，可以提升页面的加载性能和用户体验。
<img width="631" alt="image" src="https://github.com/user-attachments/assets/a3441f19-9b28-49a7-b271-8a45c5c00e38" />
### 性能评分包含5个指标，如下图所示：
- **首次内容绘制**：2.0秒
- **最大内容绘制**：26.5秒
- **总阻塞时间**：1,720毫秒
- **速度指数**：26.0秒
- **累积布局偏移**：0.567

### 根据这5个指标，Lighthouse会给出相关的诊断结果
例如下图所示的“移除阻塞渲染资源”就是“首次内容绘制”指标相关的问题诊断，点击右侧下拉箭头，提供了如何提升网页加载性能的具体提示和相关详情。

### 无障碍功能、最佳做法、搜索引擎优化等方面的测试评分及处理建议
点击下拉箭头，Lighthouse会给出具体提示，例如具体哪个图片图标需要添加属性。

- **无障碍**：81
  - 图片元素缺少`[alt]`属性
  - 文档不含`<title>`元素

- **SEO**：67
  - 内容最佳做法
    - 文档不含`<title>`元素
    - 缺少`meta`描述
    - 图片元素缺少`[alt]`属性

- **最佳做法**：74
  - 依赖与安全
    - 未使用 HTTPS
    - 浏览器 CSP 缺陷使其绕过 XSS 保护
  - 用户体验
    - 所有的页面均为用户打开的标签页

通过这些提示和建议，开发者可以针对具体问题进行优化，提升网页的性能、无障碍性、最佳做法和搜索引擎优化（SEO）等方面的表现。
<img width="644" alt="image" src="https://github.com/user-attachments/assets/4e7156a0-681f-4576-a3d2-bf845a85e720" />
<img width="632" alt="image" src="https://github.com/user-attachments/assets/e4e2e2ea-688f-43ea-a90a-56014853e964" />
<img width="644" alt="image" src="https://github.com/user-attachments/assets/8c0ee1d1-6091-4b14-a246-d975c11e29a4" />
### 四：性能方面相关的诊断结果及处理和提升方案

#### 总阻塞时间（Total Blocking Time）消耗大：
该指标是性能方面评分占比最大的部分，占30%的权重。界面涉及加载许多图片的情况下，建议使用`react-lazy-load-image-component`插件来加载图片。与原生`<img>`标签相比，该插件能有效减少任务耗时，同时也提升了占位图加载、优化了图片预加载效果，提升用户的感知体验。使用前后对比，有效减少了总阻塞时间的时长，如下：
- 使用前是700毫秒左右
- 使用后是430毫秒

总的性能提升了7%。

### 性能评分指标：
- **首次内容绘制（FCP）**：4.2秒
- **最大内容绘制（LCP）**：12.4秒
- **总阻塞时间（TBT）**：700毫秒（优化后为430毫秒）
- **速度指数（SI）**：7.9秒
- **累积布局偏移（CLS）**：0.025

### 优化后的性能评分：
- **首次内容绘制（FCP）**：4.4秒
- **最大内容绘制（LCP）**：13.2秒
- **总阻塞时间（TBT）**：430毫秒
- **速度指数（SI）**：6.8秒
- **累积布局偏移（CLS）**：0.024

通过这些优化措施，页面的总阻塞时间显著减少，整体性能得到了提升。
### 优化报告总结

#### 采用新一代格式提供图片
根据生成的报告，优化了“采用新一代格式提供图片”的情况，使用前后情况如下：
- **使用前**：有望节省16,778 KiB
- **使用后**：有望节省2,020 KiB

因此，涉及通过接口加载图片的，建议使用`react-lazy-load-image-component`插件。具体在项目的LazyLoadImage文件中，满足常见业务加载效果。后续根据自己的需要通过穿参扩展自己的需求，相关API参考官方文档：[react-lazy-load-image-component](https://www.npmjs.com/package/react-lazy-load-image-component)

#### 缩短JavaScript执行时间
- **问题**：缩短JavaScript执行时间5.4秒
- **处理建议**：增强服务器性能（通过部署新的测试环境，该方案已经得到了验证），缩减代码量，拆分代码；移除未使用的代码。

#### 减小主线程工作问题
- **问题**：主线程工作时间过长
- **处理建议**：优化代码，减少不必要的计算和操作，使用Web Workers等技术将部分任务移出主线程。

通过这些优化措施，可以显著提升网页的加载性能和用户体验。
<img width="612" alt="image" src="https://github.com/user-attachments/assets/dec72988-4c55-4fd9-9cef-0dff897f962b" />

这张图表显示了在网页加载过程中，主线程花费时间的各个方面。以下是每个指标的详细解释：

### 最大限度地减少主线程工作
**总时间**：38.4秒
- **建议**：减少为解析、编译和执行 JavaScript 而花费的时间。提供较小的 JavaScript 载荷有助于实现此目标。

### 各个类别的时间花费
1. **Script Evaluation（脚本执行）**
   - **时间**：14,336毫秒
   - **含义**：执行 JavaScript 代码所花费的时间。这包括所有的脚本执行时间。

2. **Style & Layout（样式和布局）**
   - **时间**：8,668毫秒
   - **含义**：计算样式和布局所花费的时间。这包括 CSS 解析、样式计算和布局计算。

3. **Other（其他）**
   - **时间**：8,297毫秒
   - **含义**：其他未分类的任务所花费的时间。这可能包括一些不常见的操作或未明确分类的任务。

4. **Rendering（渲染）**
   - **时间**：5,700毫秒
   - **含义**：渲染页面内容所花费的时间。这包括绘制页面元素到屏幕上的时间。

5. **Script Parsing & Compilation（脚本解析和编译）**
   - **时间**：1,072毫秒
   - **含义**：解析和编译 JavaScript 代码所花费的时间。这包括将 JavaScript 代码转换为可执行代码的时间。

6. **Garbage Collection（垃圾回收）**
   - **时间**：342毫秒
   - **含义**：垃圾回收所花费的时间。这包括清理不再使用的内存的时间。

7. **Parse HTML & CSS（解析 HTML 和 CSS）**
   - **时间**：21毫秒
   - **含义**：解析 HTML 和 CSS 代码所花费的时间。这包括将 HTML 和 CSS 代码转换为 DOM 和 CSSOM 树的时间。

### 总结
这些指标反映了网页加载过程中主线程的工作负载。通过优化这些方面，可以减少主线程的工作时间，从而提升网页的加载性能和用户体验。具体的优化建议包括：
- **减少 JavaScript 代码量**：通过代码拆分、懒加载等方式减少初始加载的 JavaScript 代码量。
- **优化样式和布局**：减少复杂的 CSS 规则和布局计算，使用更高效的样式和布局策略。
- **优化渲染**：减少重绘和重排，使用更高效的渲染策略。
- **减少解析和编译时间**：使用更高效的 JavaScript 代码，减少解析和编译的时间。
- **优化垃圾回收**：减少内存分配和释放的频率，优化内存管理策略。

- 相关文档
https://developer.chrome.com/docs/lighthouse/performance/mainthread-work-breakdown?utm_source=lighthouse&utm_medium=devtools&hl=zh-cn
- 浏览器的渲染程序进程会将您的代码转换为用户可以与之互动的网页。默认情况下，渲染程序进程的主线程通常会处理大多数代码：它会解析 HTML 并构建 DOM，解析 CSS 并应用指定的样式，然后解析、评估和执行 JavaScript。

- 主线程也会处理用户事件。 因此，每当主线程忙于执行其他操作时，您的网页可能不会响应用户互动，从而导致糟糕的体验。
- 为了帮助您确定主线程负载的来源，Lighthouse 详细显示了浏览器加载页面时 CPU 时间所花在何处。
### 排查方法：

1. **切换到性能模块**：
   - 在浏览器开发者工具中，切换到“性能”模块。

2. **重新加载页面**：
   - 点击左侧上方的“重新加载”按钮，浏览器会分析页面加载情况。

3. **查看网络记录**：
   - 在分析结果中，查看网络记录中消耗时间比较长的点。
   - 点击这些点，可以在下方的面板中看到当前页面加载消耗时间的具体情况。

4. **跟踪和优化代码**：
   - 通过查看详细的加载时间和消耗情况，找到影响性能的代码部分，并进行优化。

### 图示说明：

- **性能模块**：
  - 在开发者工具中，点击“性能”标签，进入性能分析模块。

- **重新加载按钮**：
  - 点击左上角的“重新加载”按钮，开始分析页面加载情况。

- **网络记录**：
  - 在分析结果中，关注网络面板中花费时间比较长的请求。
  - 点击这些请求，可以在下方的面板中查看详细的加载时间和消耗情况。

- **详细信息**：
  - 在下方的面板中，可以看到每个请求的具体消耗时间和活动情况。
  - 通过这些信息，可以找到影响性能的代码部分，并进行优化。

通过这种方法，可以有效地排查和优化网页加载性能，提升用户体验。
<img width="880" alt="image" src="https://github.com/user-attachments/assets/636daf68-102c-4d46-af03-94883b0103f2" />

- 优化建议： 增强服务器性能，通过部署新的测试环境，
<img width="909" alt="image" src="https://github.com/user-attachments/assets/b0c28502-55cd-4a0f-8368-ff073e5d151b" />
### 减小未使用的JS和CSS问题：

#### 处理方法1：安装插件`gatsby-plugin-purgecss`，并在`gatsby-config`文件中配置（2d编辑器已有该文件）

```javascript
module.exports = {
  plugins: [
    'gatsby-plugin-stylus',
    'gatsby-plugin-sass',
    'gatsby-plugin-less',
    'gatsby-plugin-postcss',
    {
      resolve: 'gatsby-plugin-purgecss',
      options: {
        printRejected: true,
      },
    },
  ],
}
```

#### 处理方法2：在控制台上执行命令查找覆盖率，英文版是coverage，点击选中

1. **显示覆盖范围**：
   - 在开发者工具中，点击“显示覆盖范围”选项。

2. **点击重新运行**：
   - 点击重新运行按钮，可以看到哪些CSS文件或者JS文件在当前页面中用到的情况。

3. **查看CSS的使用情况**：
   - 具体点击加载的文件，面板会显示该文件，红色区域表示当前加载界面没有用到的样式。

### 图示说明：

- **显示覆盖范围**：
  - 在开发者工具中，点击“显示覆盖范围”选项，进入覆盖率分析模式。

- **重新运行**：
  - 点击重新运行按钮，开始分析当前页面中用到的CSS和JS文件。

- **查看使用情况**：
  - 在面板中，可以看到每个文件的具体使用情况。
  - 红色区域表示当前页面没有用到的样式或代码。

通过这些方法，可以有效地减少未使用的JS和CSS，优化网页加载性能。
`gatsby-plugin-purgecss` 是一个用于 Gatsby 项目的插件，它的主要作用是移除未使用的 CSS，从而减少最终生成的 CSS 文件的大小，提升网页的加载性能和用户体验。以下是这个插件的详细介绍和作用：

### 主要作用
1. **移除未使用的 CSS**：
   - `gatsby-plugin-purgecss` 会分析你的项目，找出哪些 CSS 规则在实际的 HTML 文件中没有被使用，然后将这些未使用的 CSS 规则移除。
   - 这可以显著减少 CSS 文件的大小，从而加快网页的加载速度。

2. **优化性能**：
   - 通过移除未使用的 CSS，可以减少浏览器解析和渲染 CSS 的时间，从而提升网页的性能。
   - 更小的 CSS 文件也意味着更少的网络传输时间，进一步提升网页的加载速度。

3. **提升用户体验**：
   - 更快的加载速度和更高的性能可以显著提升用户体验，减少用户等待时间，提高用户满意度。

### 安装和配置
以下是如何在 Gatsby 项目中安装和配置 `gatsby-plugin-purgecss`：

#### 安装插件
使用 npm 或 yarn 安装插件：
```bash
npm install gatsby-plugin-purgecss
# 或者
yarn add gatsby-plugin-purgecss
```

#### 配置插件
在 `gatsby-config.js` 文件中配置插件：
```javascript
module.exports = {
  plugins: [
    // 其他插件
    {
      resolve: 'gatsby-plugin-purgecss',
      options: {
        printRejected: true, // 打印被移除的 CSS 选择器
        develop: false, // 在开发环境中启用
        tailwind: true, // 启用 Tailwind CSS 支持
        whitelist: ['whitelist'], // 不移除的 CSS 选择器
        ignore: ['/ignored.css', 'prismjs/', 'docsearch.js/'], // 忽略的文件或文件夹
        purgeOnly : ['src/'], // 仅移除这些文件或文件夹中的未使用 CSS
      },
    },
  ],
}
```

### 配置选项
- `printRejected`：是否打印被移除的 CSS 选择器，默认为 `false`。
- `develop`：是否在开发环境中启用，默认为 `false`。
- `tailwind`：是否启用 Tailwind CSS 支持，默认为 `false`。
- `whitelist`：不移除的 CSS 选择器列表。
- `ignore`：忽略的文件或文件夹列表。
- `purgeOnly`：仅移除这些文件或文件夹中的未使用 CSS。

### 使用示例
以下是一个简单的使用示例：
```javascript
module.exports = {
  plugins: [
    'gatsby-plugin-stylus',
    'gatsby-plugin-sass',
    'gatsby-plugin-less',
    'gatsby-plugin-postcss',
    {
      resolve: 'gatsby-plugin-purgecss',
      options: {
        printRejected: true, // 打印被移除的 CSS 选择器
      },
    },
  ],
}
```

### 总结
`gatsby-plugin-purgecss` 是一个非常有用的插件，可以帮助你移除未使用的 CSS，优化网页的加载性能和用户体验。通过合理配置这个插件，你可以显著减少 CSS 文件的大小，加快网页的加载速度，提升用户满意度。

