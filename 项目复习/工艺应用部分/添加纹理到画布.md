在这个代码中,纹理的添加过程是通过 `AddImagePlugin` 类中的 `addTextureImage` 方法实现的。我们来详细分析一下这个过程:

1. **获取图像尺寸和变换参数**

   首先,代码会调用 `getImageSize` 方法获取图像的原始宽高。然后,根据工作区的大小、图像自身大小以及是否需要缩放等因素,通过 `getTransformByWorkspace` 方法计算出图像在画布上的最终宽高、左上角坐标等参数。

2. **创建 TextureImage 对象**

   接下来,代码会使用 `TextureImage.fromURL` 方法根据图像 URL 创建一个 `TextureImage` 对象,这是一个继承自 `fabric.Image` 的自定义类。在创建对象时,会将之前计算出的变换参数作为选项传入。

3. **应用其他选项**

   创建 `TextureImage` 对象时还会应用一些其他选项,如 `importSource`、`fileType`、`textureType` 等,用于标识该图像的来源、文件类型和纹理类型。

4. **处理纹理组**

   如果画布上已有活动对象,并且该对象是图像或纹理组,代码会调用 `handleTextureGroup` 方法进行处理。这个方法的主要作用是:

   - 如果活动对象是普通图像,则将其克隆为原始图像,并将新的纹理图像作为裁剪路径应用到克隆图像上,然后将两者编组为纹理组。
   - 如果活动对象已经是纹理组,则先解组,移除旧的纹理图像,然后重复上一步的操作,生成新的纹理组。

5. **处理单个纹理**

   如果画布上没有活动对象,或者活动对象既不是图像也不是纹理组,则代码会调用 `handleTexture` 方法直接将新的纹理图像添加到画布上。根据纹理类型的不同,会对图像的透明度、层级等属性进行相应调整。

6. **渲染画布**

   最后,代码会触发画布重新渲染,使新添加的纹理图像或纹理组生效并显示在画布上。

需要注意的是,在处理纹理组时,代码会考虑活动对象的旋转、缩放等属性,并对新的纹理图像进行相应的变换,以确保纹理图像和原始图像的大小和位置一致。此外,纹理图像还会被设置为不可选中和不可编辑的状态,而原始图像则保留了可编辑性。

总的来说,添加纹理到画布的过程包括了图像尺寸计算、纹理对象创建、与已有对象的组合处理,以及最终的画布渲染等多个环节,并针对不同情况做了相应的处理和优化。
