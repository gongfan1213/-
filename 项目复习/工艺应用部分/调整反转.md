### **调整反转部分的逻辑详解**

在调整反转（`invert`）的代码中，涉及到 **获取灰度图**、**调整反转** 和 **生成法线图** 的操作。这些步骤是为了确保纹理的显示效果正确，并且在 3D 场景中能够真实地反映纹理的凹凸效果。以下是对这部分代码的详细讲解，包括为什么要获取灰度图、调整反转以及生成法线图的逻辑。

---

### **1. 调整反转的代码**

```typescript
async function hanlderInvert(invert: boolean) {
    grayData.forEach(async (data) => {
      if (data.id === activeData?.id) {
        let img = temGrayData.current[data.id]; // 获取缓存的灰度图
        const res = await textureEffect2dManager.hanlderContrast(img, contrast, invert); // 调整对比度和反转
        const normal = await textureEffect2dManager.grayToNormalMap(res); // 生成法线图
        data.grayImg = res; // 更新灰度图
        data.normal = normal; // 更新法线图
        data.invert = invert; // 更新反转状态
        textureScene.current.update(data, rotary_params.current); // 更新场景
      }
    });
}
```

---

### **2. 为什么要获取灰度图？**

#### **2.1 灰度图的作用**
- **灰度图** 是纹理生成的基础数据，表示纹理表面的高度信息。
  - 灰度值范围：`0`（黑色）到 `255`（白色）。
  - 灰度值越高，表示表面越高；灰度值越低，表示表面越低。

#### **2.2 为什么需要获取灰度图？**
- **反转操作依赖灰度图**：
  - 反转操作的本质是将灰度图的亮暗关系颠倒。
  - 例如：
    - 原始灰度值为 `0`（黑色），反转后变为 `255`（白色）。
    - 原始灰度值为 `255`（白色），反转后变为 `0`（黑色）。

- **缓存的灰度图**：
  - 从 `temGrayData` 中获取缓存的灰度图，避免重复计算，提高性能。

#### **2.3 获取灰度图的逻辑**
```typescript
let img = temGrayData.current[data.id]; // 获取缓存的灰度图
```
- **从缓存中获取灰度图**：
  - 每个纹理对象的灰度图在初始化时已经被缓存到 `temGrayData` 中。
  - 通过纹理对象的 `id`，可以快速获取对应的灰度图。

---

### **3. 为什么要调整反转？**

#### **3.1 反转的作用**
- **反转操作** 是将灰度图的亮暗关系颠倒。
  - 反转后，原本的高点变为低点，低点变为高点。
  - 例如：
    - 原始灰度图：
      ```
      [255, 128, 0]
      ```
    - 反转后的灰度图：
      ```
      [0, 127, 255]
      ```

#### **3.2 为什么需要调整反转？**
- **用户需求**：
  - 在某些场景中，用户可能希望调整纹理的凹凸方向。
  - 例如：
    - 原本的纹理是凸起的，用户希望将其调整为凹陷的。

- **对比度和反转的结合**：
  - 反转操作通常与对比度调整结合使用，以增强纹理的细节。

#### **3.3 调整反转的逻辑**
```typescript
const res = await textureEffect2dManager.hanlderContrast(img, contrast, invert); // 调整对比度和反转
```
- **调用 `hanlderContrast` 方法**：
  - 调整灰度图的对比度和反转状态。
  - 如果 `invert` 为 `true`，对灰度图进行反转。

- **返回结果**：
  - 返回调整后的灰度图。

---

### **4. 为什么要生成法线图？**

#### **4.1 法线图的作用**
- **法线图** 是一种特殊的纹理图，用于描述表面每个像素的法线方向。
  - 法线方向用于计算光照效果，使得表面看起来具有凹凸感。
  - 法线图通常用 RGB 颜色表示：
    - R（红色）：表示法线的 X 分量。
    - G（绿色）：表示法线的 Y 分量。
    - B（蓝色）：表示法线的 Z 分量。

#### **4.2 为什么需要生成法线图？**
- **3D 场景中的光照计算**：
  - 在 3D 场景中，光照效果依赖于法线方向。
  - 通过法线图，可以模拟出表面的凹凸效果，而不需要增加几何体的复杂度。

- **反转操作会影响法线图**：
  - 反转操作会改变灰度图的亮暗关系，从而影响法线方向。
  - 因此，在调整反转后，需要重新生成法线图。

#### **4.3 生成法线图的逻辑**
```typescript
const normal = await textureEffect2dManager.grayToNormalMap(res); // 生成法线图
```
- **调用 `grayToNormalMap` 方法**：
  - 将调整后的灰度图转换为法线图。

- **返回结果**：
  - 返回生成的法线图。

---

### **5. 更新纹理和场景**

#### **5.1 更新纹理数据**
```typescript
data.grayImg = res; // 更新灰度图
data.normal = normal; // 更新法线图
data.invert = invert; // 更新反转状态
```
- **更新灰度图**：
  - 将调整后的灰度图保存到纹理数据中。

- **更新法线图**：
  - 将生成的法线图保存到纹理数据中。

- **更新反转状态**：
  - 保存当前的反转状态。

#### **5.2 更新 3D 场景**
```typescript
textureScene.current.update(data, rotary_params.current); // 更新场景
```
- **调用 `update` 方法**：
  - 将更新后的纹理数据传递给 3D 场景对象。
  - 刷新场景，使得纹理的变化（如反转效果）能够实时反映在 3D 预览中。

---

### **6. 示例流程**

#### **6.1 原始灰度图**
```
[255, 128, 0]
```

#### **6.2 调整反转**
- 调用 `hanlderContrast` 方法，调整对比度并反转灰度图：
```
[0, 127, 255]
```

#### **6.3 生成法线图**
- 调用 `grayToNormalMap` 方法，将反转后的灰度图转换为法线图：
```
[法线方向数据]
```

#### **6.4 更新场景**
- 将更新后的灰度图和法线图传递给 3D 场景对象，刷新场景。

---

### **7. 总结**

#### **7.1 为什么要获取灰度图？**
- 灰度图是纹理生成的基础数据，反转操作依赖于灰度图。

#### **7.2 为什么要调整反转？**
- 反转操作可以调整纹理的凹凸方向，满足用户的需求。

#### **7.3 为什么要生成法线图？**
- 法线图用于计算光照效果，反转操作会影响法线方向，因此需要重新生成法线图。

#### **7.4 更新场景的意义**
- 更新场景可以实时反映纹理的变化（如反转效果），提升用户体验。

通过这些步骤，可以确保纹理的显示效果正确，并在 3D 场景中真实地反映纹理的凹凸效果。如果你对某些部分仍有疑问，可以告诉我，我会进一步解释！
