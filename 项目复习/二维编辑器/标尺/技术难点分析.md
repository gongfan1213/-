> ğŸ’­ å¥½çš„ï¼Œç°åœ¨éœ€è¦åˆ†æç”¨æˆ·ä¹‹å‰æä¾›çš„ä»£ç ä¸­çš„æ ‡å°ºæ’ä»¶å®ç°ï¼Œå¹¶æŒ‡å‡ºå…¶ä¸­çš„æŠ€æœ¯éš¾ç‚¹å’Œä¸å®¹æ˜“å¤„ç†çš„éƒ¨åˆ†ã€‚ç”¨æˆ·ä¹‹å‰çš„ä»£ç æ˜¯ç”¨TypeScriptç¼–å†™çš„ï¼Œä¸»è¦æ˜¯ä¸€ä¸ªRulerç±»çš„å®ç°ï¼Œç”¨äºåœ¨Fabric.jsçš„Canvasä¸Šç»˜åˆ¶æ°´å¹³å’Œå‚ç›´æ ‡å°ºï¼Œå¹¶æ”¯æŒå‚è€ƒçº¿çš„åˆ›å»ºå’Œæ‹–åŠ¨ã€‚
>
> é¦–å…ˆï¼Œæˆ‘éœ€è¦å›é¡¾ä»£ç çš„ç»“æ„å’Œä¸»è¦åŠŸèƒ½ï¼Œæ‰¾å‡ºæ½œåœ¨çš„æŠ€æœ¯éš¾ç‚¹ã€‚ä»ä¹‹å‰çš„å›ç­”æ¥çœ‹ï¼Œæˆ‘éœ€è¦ç»“åˆä¹‹å‰çš„åˆ†æï¼Œå…·ä½“è¯¦ç»†è¯´æ˜ç”¨æˆ·ä»£ç ä¸­å·²å¤„ç†çš„éƒ¨åˆ†ä»¥åŠå¯èƒ½å­˜åœ¨çš„é—®é¢˜æˆ–éš¾ç‚¹ã€‚
>
> é¦–å…ˆï¼Œä»£ç çš„ç»“æ„åŒ…æ‹¬ï¼š
>
> 1. Rulerç±»ï¼Œæ„é€ å‡½æ•°æ¥æ”¶Canvaså…ƒç´ å’Œé…ç½®é¡¹ã€‚
>
> 2. initæ–¹æ³•åˆ›å»ºæ°´å¹³å’Œå‚ç›´æ ‡å°ºçš„Canvasï¼Œå¹¶æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚
>
> 3. createRuleræ–¹æ³•ç”Ÿæˆæ ‡å°ºçš„Canvaså…ƒç´ ï¼Œè®¾ç½®å°ºå¯¸å’Œäº‹ä»¶ç›‘å¬ã€‚
>
> 4. drawæ–¹æ³•è´Ÿè´£ç»˜åˆ¶æ ‡å°ºçš„åˆ»åº¦å’Œæ ‡ç­¾ï¼Œå¤„ç†viewportTransformçš„åæ ‡è½¬æ¢ã€‚
>
> 5. onMouseDownã€onMouseMoveã€onMouseUpå¤„ç†å‚è€ƒçº¿çš„åˆ›å»ºå’Œæ‹–åŠ¨äº‹ä»¶ã€‚
>
> 6. getGuidelinesæ–¹æ³•è·å–æ‰€æœ‰å‚è€ƒçº¿ã€‚
>
> 7. getPointerå’ŒcalcZoomå¸®åŠ©æ–¹æ³•å¤„ç†åæ ‡è½¬æ¢å’Œç¼©æ”¾è®¡ç®—ã€‚
>
> æŠ€æœ¯éš¾ç‚¹å¯èƒ½å‡ºç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
>
> ä¸€ã€æ ‡å°ºçš„ç»˜åˆ¶ä¸è§†å£å˜æ¢åŒæ­¥
>
> - ç”¨æˆ·åœ¨ä»£ç ä¸­å¤„ç†äº†viewportTransformçŸ©é˜µçš„å˜æ¢ï¼Œç¡®ä¿æ ‡å°ºçš„åˆ»åº¦æ­£ç¡®å¯¹åº”ç”»å¸ƒçš„ç¼©æ”¾å’Œå¹³ç§»ã€‚
>
> - ä¾‹å¦‚ï¼Œåœ¨drawæ–¹æ³•ä¸­ï¼Œä»£ç ä½¿ç”¨viewportTransformæ¥è½¬æ¢åæ ‡ç³»ã€‚ä½†æ˜¯ï¼Œæ˜¯å¦æ­£ç¡®å¤„ç†äº†åŸç‚¹åç§»ï¼ˆå¦‚çŸ©é˜µçš„å¹³ç§»éƒ¨åˆ†ï¼‰å’Œç¼©æ”¾ï¼Ÿå½“è§†å£è¢«å¹³ç§»æˆ–ç¼©æ”¾æ—¶ï¼Œæ ‡å°ºä¸Šçš„åˆ»åº¦å’Œæ ‡ç­¾å¿…é¡»å®æ—¶æ›´æ–°ä½ç½®ï¼Œè¿™å¯èƒ½æ¶‰åŠæ€§èƒ½ä¼˜åŒ–ã€‚
>
> äºŒã€åŠ¨æ€åˆ»åº¦é—´éš”çš„è®¡ç®—
>
> - ç”¨æˆ·çš„ä»£ç ä¸­ï¼Œåœ¨drawæ–¹æ³•å†…è®¡ç®—åˆ»åº¦é—´éš”ï¼Œæ ¹æ®å½“å‰ç¼©æ”¾çº§åˆ«åŠ¨æ€è°ƒæ•´ã€‚ä¾‹å¦‚ï¼Œå½“zoomå˜åŒ–æ—¶ï¼Œé€‚åº”å½“å‰ç¼©æ”¾çº§åˆ«ç»˜åˆ¶ä¸åŒå¯†åº¦çš„åˆ»åº¦ã€‚
>
> - å…³é”®ç‚¹æ˜¯å¦‚ä½•é«˜æ•ˆè®¡ç®—åˆé€‚çš„ä¸»è¦åˆ»åº¦å’Œæ¬¡è¦åˆ»åº¦ï¼Œä»¥åŠé¿å…æ ‡ç­¾é‡å ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜ç¼©æ”¾çº§åˆ«ä¸‹å¯èƒ½éœ€è¦æ›´é«˜çš„ç²¾åº¦ã€‚
>
> ä¸‰ã€å‚è€ƒçº¿çš„äº¤äº’å¤„ç†
>
> - å‚è€ƒçº¿çš„åˆ›å»ºå’Œæ‹–åŠ¨æ¶‰åŠäº‹ä»¶å¤„ç†ï¼Œéœ€è¦ç²¾ç¡®æ•è·é¼ æ ‡ä½ç½®å¹¶è½¬æ¢ä¸ºç”»å¸ƒåæ ‡ã€‚
>
> - åœ¨onMouseDownä¸­åˆ¤æ–­æ˜¯å¦åœ¨æ ‡å°ºåŒºåŸŸç‚¹å‡»ï¼Œç„¶ååˆ›å»ºå‚è€ƒçº¿ï¼Œå¹¶åœ¨onMouseMoveä¸­æ›´æ–°ä½ç½®ã€‚è¿™é‡Œçš„é—®é¢˜å¯èƒ½åŒ…æ‹¬äº‹ä»¶ç©¿é€ï¼ˆæ ‡å°ºCanvaså’Œä¸»Canvasçš„äº‹ä»¶åè°ƒï¼‰ã€åæ ‡è½¬æ¢æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠå‚è€ƒçº¿çš„ä½ç½®åŒæ­¥ã€‚
>
> å››ã€æ€§èƒ½ä¼˜åŒ–
>
> - å½“ç”»å¸ƒé¢‘ç¹ç¼©æ”¾æˆ–å¹³ç§»æ—¶ï¼Œæ ‡å°ºéœ€è¦ä¸æ–­é‡ç»˜ã€‚å¦‚æœå¤„ç†ä¸å½“ï¼Œå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå¦‚å¡é¡¿ã€‚ç”¨æˆ·ä»£ç ä¸­æ˜¯å¦æœ‰ä¼˜åŒ–æªæ–½ï¼Œå¦‚ä½¿ç”¨requestAnimationFrameï¼Œé™åˆ¶é‡ç»˜é¢‘ç‡ï¼Œæˆ–è€…é¿å…ä¸å¿…è¦çš„é‡ç»˜ï¼Ÿ
>
> äº”ã€è·¨æµè§ˆå™¨å…¼å®¹æ€§å’Œé«˜DPIæ”¯æŒ
>
> - ç”¨æˆ·ä»£ç åœ¨åˆ›å»ºCanvasæ—¶æ˜¯å¦è€ƒè™‘äº†è®¾å¤‡åƒç´ æ¯”ä¾‹ï¼Ÿä¾‹å¦‚ï¼Œåœ¨é«˜DPIå±å¹•ä¸Šï¼ŒCanvaså¯èƒ½éœ€è¦è°ƒæ•´å°ºå¯¸ä»¥é˜²æ­¢æ¨¡ç³Šã€‚
>
> - åœ¨createRuleræ–¹æ³•ä¸­ï¼Œè®¾ç½®Canvasçš„widthå’Œheightä¸ºå®¹å™¨çš„å®½é«˜ï¼Œä½†æ²¡æœ‰ä¹˜ä»¥devicePixelRatioï¼Œå¯èƒ½å¯¼è‡´åœ¨é«˜åˆ†å±ä¸Šæ˜¾ç¤ºæ¨¡ç³Šã€‚
>
> å…­ã€å‚è€ƒçº¿çš„å­˜å‚¨ä¸ç®¡ç†
>
> - ç”¨æˆ·çš„Rulerç±»ä¸­ä½¿ç”¨guidelinesæ•°ç»„æ¥å­˜å‚¨å‚è€ƒçº¿ã€‚ä½†å½“å­˜åœ¨å¤šä¸ªå‚è€ƒçº¿æ—¶ï¼Œå¦‚ä½•é«˜æ•ˆç®¡ç†å®ƒä»¬çš„æ¸²æŸ“å’Œäº‹ä»¶å¤„ç†ï¼Ÿä¾‹å¦‚ï¼Œå½“æ‹–åŠ¨ä¸€æ¡å‚è€ƒçº¿æ—¶ï¼Œå¦‚ä½•é¿å…å…¨é‡é‡ç»˜æ‰€æœ‰å‚è€ƒçº¿ï¼Ÿ
>
> ä¸ƒã€äº‹ä»¶å¤„ç†ä¸åæ ‡è½¬æ¢çš„ç²¾åº¦é—®é¢˜
>
> - ç”¨æˆ·çš„getPointeræ–¹æ³•æ˜¯å¦æ­£ç¡®å¤„ç†äº†é¼ æ ‡äº‹ä»¶çš„åæ ‡è½¬æ¢ï¼Ÿç‰¹åˆ«æ˜¯åœ¨å­˜åœ¨è§†å£å˜æ¢çš„æƒ…å†µä¸‹ï¼Œå‚è€ƒçº¿çš„ä½ç½®æ˜¯å¦å‡†ç¡®æ˜ å°„åˆ°ç”»å¸ƒä¸–ç•Œåæ ‡ï¼Ÿ
>
>   
>
> ç°åœ¨ï¼Œæˆ‘ç»“åˆç”¨æˆ·çš„å…·ä½“ä»£ç è¯¦ç»†åˆ†æä»¥ä¸Šéš¾ç‚¹ï¼š
>
> 1. **è§†å£å˜æ¢åŒæ­¥**ï¼š
>
>    - åœ¨drawæ–¹æ³•ä¸­ï¼Œä½¿ç”¨äº†viewportTransformæ¥è°ƒæ•´åŸç‚¹ï¼Œé€šè¿‡setTransformåº”ç”¨å˜æ¢çŸ©é˜µã€‚è¿™ä¿è¯äº†æ ‡å°ºçš„ä½ç½®å’Œåˆ»åº¦å’Œç”»å¸ƒè§†å£åŒæ­¥ã€‚ä½†éœ€è¦æ³¨æ„ï¼Œå½“ç”»å¸ƒçš„viewportTransformæ”¹å˜æ—¶ï¼Œå¦‚ä½•è§¦å‘æ ‡å°ºçš„é‡ç»˜ï¼Ÿä¾‹å¦‚ï¼Œå½“ç”¨æˆ·å¹³ç§»æˆ–ç¼©æ”¾ç”»å¸ƒæ—¶ï¼Œå¯èƒ½éœ€è¦ç›‘å¬ç›¸åº”çš„Fabric.jsäº‹ä»¶ï¼ˆä¾‹å¦‚'after:render'ï¼‰å¹¶è°ƒç”¨Rulerçš„drawæ–¹æ³•ã€‚ç”¨æˆ·ä»£ç ä¸­æ˜¯å¦æœ‰è¿™æ ·çš„æœºåˆ¶ï¼Ÿç›®å‰ä»£ç ä¸­æœ‰canvas.on('after:render', this.draw)ä½†è¢«æ³¨é‡Šæ‰äº†ï¼Œå¯èƒ½å¯¼è‡´æ ‡å°ºæ›´æ–°ä¸åŠæ—¶ã€‚
>
> 2. **åŠ¨æ€åˆ»åº¦è®¡ç®—**ï¼š
>
>    - åœ¨drawæ–¹æ³•ä¸­ï¼Œè®¡ç®—åˆ»åº¦çš„é—´éš”ï¼ˆstepï¼‰ï¼Œæ ¹æ®å½“å‰zoomçš„å€¼è°ƒæ•´æ­¥é•¿ã€‚ä¾‹å¦‚ï¼Œå¯¹äºå°ç¼©æ”¾çº§åˆ«ï¼ˆzoom < 0.2ï¼‰ï¼Œæ­¥é•¿ä¸º100pxï¼Œä½†åœ¨æ›´é«˜ç¼©æ”¾çº§åˆ«æ—¶æ­¥é•¿å‡å°ã€‚è¿™å¯èƒ½æœ‰æ•ˆï¼Œä½†éœ€è¦ç¡®ä¿æ ‡ç­¾ä¸ä¼šé‡å ï¼Œå°¤å…¶æ˜¯å½“ç¼©æ”¾æå¤§æ—¶ï¼Œæ­¥é•¿å¯èƒ½å¯¼è‡´è¿‡å¤šçš„æ ‡ç­¾ã€‚ä¾‹å¦‚ï¼Œå½“zoomè¶³å¤Ÿå¤§ä½¿å¾—æ­¥é•¿å¯¹åº”çš„å±å¹•è·ç¦»å°äºæ ‡ç­¾å®½åº¦ï¼Œå¯èƒ½å‡ºç°é‡å ã€‚ç”¨æˆ·ä»£ç ä¸­çš„stepè®¡ç®—å¯èƒ½éœ€è¦æ›´æ™ºèƒ½çš„åŠ¨æ€è°ƒæ•´ï¼Œæ¯”å¦‚åŸºäºå½“å‰è§†å›¾çš„å®é™…å¯è§èŒƒå›´è®¡ç®—åˆé€‚çš„æ­¥é•¿ï¼Œä»¥ä¿è¯æ ‡ç­¾çš„å¯è¯»æ€§ã€‚
>
> 3. **å‚è€ƒçº¿äº¤äº’å¤„ç†**ï¼š
>
>    - å½“ç”¨æˆ·ä»æ ‡å°ºæ‹–å‡ºå‚è€ƒçº¿æ—¶ï¼Œåœ¨onMouseDownä¸­åˆ›å»ºæ–°çš„å‚è€ƒçº¿å¯¹è±¡ï¼Œå¹¶åœ¨onMouseMoveä¸­æ›´æ–°å…¶ä½ç½®ï¼Œç„¶ååœ¨onMouseUpæ—¶ç¡®è®¤æ”¾ç½®ã€‚è¿™é‡Œå­˜åœ¨çš„æ½œåœ¨é—®é¢˜æ˜¯ï¼Œå‚è€ƒçº¿çš„åæ ‡è½¬æ¢æ˜¯å¦æ­£ç¡®ã€‚ä¾‹å¦‚ï¼Œåœ¨onMouseMoveä¸­ä½¿ç”¨getPointer(event)æ–¹æ³•ï¼Œå…¶å†…éƒ¨è½¬æ¢æ˜¯å¦æ­£ç¡®è€ƒè™‘äº†å½“å‰è§†å£å˜æ¢åçš„åæ ‡ï¼Œè€Œä¸ä»…ä»…æ˜¯å®¹å™¨åç§»ã€‚
>
>    - å¦å¤–ï¼Œå½“æ‹–åŠ¨å‚è€ƒçº¿æ—¶ï¼Œä¸»ç”»å¸ƒä¸­çš„å…ƒç´ æ˜¯å¦éœ€è¦å¸é™„åˆ°å‚è€ƒçº¿ï¼Ÿç”¨æˆ·çš„ä»£ç ç›®å‰å¯èƒ½åœ¨å‚è€ƒçº¿æ‹–åŠ¨æ—¶æ²¡æœ‰å¤„ç†ä¸å…¶ä»–å…ƒç´ çš„äº’åŠ¨ï¼Œå¦‚è‡ªåŠ¨å¸é™„åˆ°å…ƒç´ è¾¹ç¼˜ï¼Œç±»ä¼¼Fabric.jsçš„snapåŠŸèƒ½ã€‚è¿™éœ€è¦é¢å¤–çš„è®¡ç®—ï¼Œå¯èƒ½å¢åŠ å¤æ‚åº¦ã€‚
>
> 4. **æ€§èƒ½é—®é¢˜**ï¼š
>
>    - æ ‡å°ºåœ¨æ¯æ¬¡è°ƒç”¨drawæ—¶ä¼šå®Œæ•´é‡ç»˜æ•´ä¸ªæ ‡å°ºï¼ŒåŒ…æ‹¬æ¸…é™¤Canvasã€ç»˜åˆ¶èƒŒæ™¯å’Œåˆ»åº¦ã€‚å½“é¢‘ç¹ç¼©æ”¾æˆ–å¹³ç§»å¯¼è‡´drawè¢«é¢‘ç¹è°ƒç”¨æ—¶ï¼Œå¯èƒ½å¼•èµ·æ€§èƒ½é—®é¢˜ã€‚å¦‚æœViewportå˜æ¢è¾ƒé¢‘ç¹ï¼Œå¯èƒ½éœ€è¦é‡‡ç”¨åŒç¼“å†²æŠ€æœ¯æˆ–èŠ‚æµæœºåˆ¶ï¼Œä¾‹å¦‚ä»…åœ¨åŠ¨ç”»ç»“æŸæ—¶æ›´æ–°æ ‡å°ºï¼Œæˆ–ç”¨requestAnimationFrameæ¥åˆå¹¶é‡ç»˜è¯·æ±‚ã€‚
>
> 5. **é«˜DPIæ”¯æŒ**ï¼š
>
>    - åœ¨createRuleræ–¹æ³•ä¸­ï¼Œåˆ›å»ºcanvaså…ƒç´ æ—¶è®¾ç½®çš„å®½åº¦å’Œé«˜åº¦ä¸ºå®¹å™¨çš„clientWidth/clientHeightï¼Œä½†æœªè€ƒè™‘devicePixelRatioã€‚è¿™å¯èƒ½å¯¼è‡´åœ¨é«˜DPIå±å¹•ï¼ˆå¦‚Retinaæ˜¾ç¤ºå±ï¼‰ä¸Šæ ‡å°ºæ¨¡ç³Šã€‚æ­£ç¡®åšæ³•æ˜¯è®¾ç½®canvaså…ƒç´ çš„widthå’Œheightå±æ€§ä¸ºclientWidth * devicePixelRatioï¼Œå¹¶åŒæ—¶å°†canvasçš„CSSå®½é«˜è®¾ç½®ä¸ºclientWidthï¼Œä»¥ç»´æŒæ¸…æ™°åº¦ã€‚è€Œç”¨æˆ·ä»£ç ä¸­çš„è®¾ç½®å¯èƒ½å¯¼è‡´æ ‡å°ºåœ¨é«˜åˆ†å±ä¸‹å‘ˆç°æ¨¡ç³Šã€‚
>
> 6. **å‚è€ƒçº¿ç®¡ç†**ï¼š
>
>    - ç”¨æˆ·ä»£ç ä¸­ç”¨guidelinesæ•°ç»„å­˜å‚¨å‚è€ƒçº¿ï¼Œå¯èƒ½æ²¡æœ‰é«˜æ•ˆçš„å¤„ç†æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå½“æœ‰å¤šæ¡å‚è€ƒçº¿æ—¶ï¼Œå¯èƒ½æ¯æ¬¡éƒ½è¦éå†æ•´ä¸ªæ•°ç»„è¿›è¡Œåæ ‡è®¡ç®—ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§é‡å‚è€ƒçº¿æƒ…å†µä¸‹å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚å¯èƒ½éœ€è¦é‡‡ç”¨ç´¢å¼•ç»“æ„æˆ–åˆ†åŒºåŸŸç®¡ç†æ¥ä¼˜åŒ–ã€‚
>
> 7. **äº‹ä»¶ç©¿é€é—®é¢˜**ï¼š
>
>    - æ ‡å°ºçš„Canvasè¦†ç›–åœ¨ç”»å¸ƒä¸Šï¼Œè¿™é‡Œçš„äº‹ä»¶å¤„ç†éœ€è¦ç¡®ä¿æ ‡å°ºçš„é¼ æ ‡äº‹ä»¶è¢«æ­£ç¡®å¤„ç†ï¼ˆå¦‚æ‹–åŠ¨å‚è€ƒçº¿ï¼‰çš„åŒæ—¶ï¼Œä¸å½±å“åº•å±‚ç”»å¸ƒçš„äº¤äº’ã€‚ä¾‹å¦‚ï¼Œåœ¨æ ‡å°ºåŒºåŸŸç‚¹å‡»å¹¶æ‹–åŠ¨æ—¶ï¼Œåº”é˜²æ­¢è§¦å‘ç”»å¸ƒçš„å¯¹è±¡é€‰æ‹©äº‹ä»¶ã€‚ç”¨æˆ·ä»£ç ä¸­çš„äº‹ä»¶ç›‘å¬æ˜¯å¦é˜»æ­¢äº†äº‹ä»¶å†’æ³¡ï¼Ÿåœ¨onMouseDownä¸­å¯èƒ½éœ€è¦è°ƒç”¨event.preventDefault()æˆ–event.stopPropagation()æ¥é˜²æ­¢äº‹ä»¶ä¼ é€’åˆ°ç”»å¸ƒï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æ ‡å°ºæ‹–åŠ¨æ—¶æ„å¤–é€‰æ‹©ç”»å¸ƒä¸­çš„å¯¹è±¡ã€‚
>
> 8. **åæ ‡è½¬æ¢ç²¾åº¦**ï¼š
>
>    - getPointeræ–¹æ³•å°†é¼ æ ‡äº‹ä»¶çš„ä½ç½®è½¬æ¢ä¸ºç›¸å¯¹äºæ ‡å°ºå®¹å™¨çš„åæ ‡ï¼Œä½†åœ¨åº”ç”¨åˆ°ä¸–ç•Œåæ ‡æ—¶æ˜¯å¦æ­£ç¡®å¤„ç†äº†è§†å£å˜æ¢ï¼Ÿä¾‹å¦‚ï¼Œè®¡ç®—å¾—åˆ°çš„æ˜¯å±å¹•åæ ‡ï¼Œéœ€è¦åº”ç”¨inverse viewportTransformçŸ©é˜µæ¥å¾—åˆ°ä¸–ç•Œåæ ‡ã€‚è¿™å¯èƒ½æ˜¯ä¸€ä¸ªéš¾ç‚¹ï¼Œå°¤å…¶æ˜¯å½“è§†å£å­˜åœ¨æ—‹è½¬æˆ–å€¾æ–œæ—¶ï¼Œç”¨æˆ·ä»£ç æ˜¯å¦è€ƒè™‘äº†å®Œæ•´çš„å˜æ¢çŸ©é˜µï¼Ÿç›®å‰çš„ä»£ç ä¸­calcZoomä»…ä»ç¼©æ”¾è§’åº¦å¤„ç†ï¼Œè€Œå¿½ç•¥äº†å˜æ¢çŸ©é˜µçš„å…¶ä»–éƒ¨åˆ†ï¼Œå¯èƒ½åœ¨å¤æ‚å˜æ¢ä¸‹åæ ‡ä¸æ­£ç¡®ã€‚
>
> ç»¼ä¸Šæ‰€è¿°ï¼Œä»ç”¨æˆ·æä¾›çš„ä»£ç æ¥çœ‹ï¼Œè™½ç„¶å·²ç»å®ç°äº†æ ‡å°ºçš„åŸºæœ¬åŠŸèƒ½å’Œå‚è€ƒçº¿çš„æ‹–åŠ¨ï¼Œä½†åœ¨ä»¥ä¸‹æ–¹é¢å¯èƒ½å­˜åœ¨æŠ€æœ¯éš¾ç‚¹æˆ–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼š
>
> 1. **åŠ¨æ€åˆ»åº¦è®¡ç®—çš„é²æ£’æ€§**ï¼šå½“å‰çš„stepè®¡ç®—å¯èƒ½åœ¨é«˜ç¼©æ”¾çº§åˆ«ä¸‹å¯¼è‡´æ ‡ç­¾é‡å ï¼Œæˆ–åœ¨ä½ç¼©æ”¾çº§åˆ«æ ‡ç­¾è¿‡äºç¨€ç–ã€‚éœ€è¦æ›´æ™ºèƒ½çš„æ­¥é•¿é€‰æ‹©ç®—æ³•ï¼Œä¾‹å¦‚åŸºäºå½“å‰ç¼©æ”¾çº§åˆ«çš„å¯¹æ•°è§„å¾‹è°ƒæ•´ä¸»åˆ»åº¦å’Œæ¬¡åˆ»åº¦ã€‚
>
> 2. **é«˜DPIæ”¯æŒ**ï¼šæœªå¤„ç†devicePixelRatioï¼Œå¯¼è‡´é«˜åˆ†è¾¨ç‡å±å¹•ä¸‹æ ‡å°ºæ¨¡ç³Šã€‚è§£å†³æ–¹æ³•æ˜¯åœ¨åˆ›å»ºCanvasæ—¶å°†å°ºå¯¸ä¹˜ä»¥devicePixelRatioï¼Œå¹¶åœ¨ç»˜åˆ¶æ—¶é€‚å½“ç¼©æ”¾ä¸Šä¸‹æ–‡ã€‚
>
> 3. **å‚è€ƒçº¿çš„åæ ‡è½¬æ¢**ï¼šåœ¨è®¡ç®—å‚è€ƒçº¿ä½ç½®æ—¶æ˜¯å¦æ­£ç¡®åº”ç”¨äº†è§†å£å˜æ¢çš„æ‰€æœ‰åˆ†é‡ï¼ˆå¹³ç§»ã€ç¼©æ”¾ã€æ—‹è½¬ï¼‰ï¼Œç›®å‰çš„ä»£ç ä¾èµ–Fabric.jsçš„viewportTransformçŸ©é˜µï¼Œä½†å¯èƒ½éœ€è¦æ›´ä¸¥æ ¼çš„æ•°å­¦å¤„ç†ã€‚
>
> 4. **æ€§èƒ½ä¼˜åŒ–**ï¼šæœªé™åˆ¶é‡ç»˜é¢‘ç‡ï¼Œå¯èƒ½å¯¼è‡´åœ¨é¢‘ç¹æ“ä½œæ—¶çš„æ€§èƒ½é—®é¢˜ã€‚éœ€å¼•å…¥requestAnimationFrameæˆ–å…¶ä»–èŠ‚æµæœºåˆ¶ã€‚
>
> 5. **äº‹ä»¶å†’æ³¡å’Œç©¿é€å¤„ç†**ï¼šæ ‡å°ºCanvasçš„äº‹ä»¶å¯èƒ½ä¼ é€’åˆ°ä¸‹å±‚ç”»å¸ƒï¼Œå½±å“ç”¨æˆ·äº¤äº’ã€‚éœ€è¦åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­é˜»æ­¢äº‹ä»¶å†’æ³¡ã€‚
>
> 6. **å¤æ‚è§†å£å˜æ¢çš„æ”¯æŒ**ï¼šå½“å‰çš„åæ ‡è½¬æ¢ä»…å¤„ç†ç¼©æ”¾å’Œå¹³ç§»ï¼Œå¦‚æœviewportTransformåŒ…æ‹¬æ—‹è½¬æˆ–å€¾æ–œï¼Œåˆ™æ ‡å°ºçš„ç»˜åˆ¶å¯èƒ½ä¸æ­£ç¡®ã€‚
>
> æ¥ä¸‹æ¥éœ€è¦å°†è¿™äº›åˆ†ææ•´ç†æˆæ¡ç†æ¸…æ™°çš„å›ç­”ï¼ŒæŒ‡å‡ºä»£ç ä¸­çš„å…·ä½“æŠ€æœ¯éš¾ç‚¹åŠå…¶è§£å†³æ–¹æ¡ˆã€‚
>
> 



ä»¥ä¸‹æ˜¯é’ˆå¯¹åŸæœ‰æ ‡å°ºæ’ä»¶ä»£ç çš„æŠ€æœ¯éš¾ç‚¹æ·±åº¦è§£æï¼ˆåŸºäºæä¾›çš„[ruler.ts]å®ç°ï¼‰ï¼š

---

### ä¸€ã€é«˜ç²¾åº¦è§†å£å˜æ¢åŒæ­¥ (å…³é”®é—®é¢˜)
**å®ç°ç¼ºé™·**ï¼š  
è§†å›¾çŸ©é˜µè®¡ç®—ä»…ä»ç¼©æ”¾ç³»æ•°çš„å€’æ•°è·å–ï¼ˆcalcmethodä¸­ `1 / zoomLevel`ï¼‰

```typescript
// åŸä»£ç å­˜åœ¨é—®é¢˜ï¼š
const zoom = this.calcZoom();
ctx.translate(-origin[0] * zoom, -origin[1] * zoom);
```

**æ­£ç¡®è§£å†³æ–¹æ¡ˆ**ï¼š  
éœ€åè§£å®Œæ•´çš„è§†å£å˜æ¢çŸ©é˜µï¼š
```typescript
const vpt = this.canvas.viewportTransform;
const inverted = invertTransform(vpt); // éœ€è¦å®ç°çŸ©é˜µåå‘è®¡ç®—
ctx.transform(inverted[0], inverted[1], inverted[2], inverted[3], inverted[4], inverted[5]);
```

**ç†è®ºä¾æ®**ï¼š  
è§†å›¾å˜æ¢å…¬å¼åº”æ»¡è¶³ï¼š
$$
\begin{cases} 
x' = a \cdot x + c \cdot y + e \\
y' = b \cdot x + d \cdot y + f 
\end{cases}
$$
åŸå®ç°æœªå¤„ç†çŸ©é˜µçš„é”™åˆ‡åˆ†é‡ï¼ˆc/bé¡¹ï¼‰

---

### äºŒã€åŠ¨æ€åˆ»åº¦å¯†åº¦ç®—æ³•ä¼˜åŒ– (æ ¸å¿ƒç—›ç‚¹)
**ç°æœ‰é€»è¾‘é—®é¢˜**ï¼š
```typescript
// ç°å­˜ä¼ªä»£ç é€»è¾‘ï¼š
if (zoom < 0.2) step = 100;
else if (zoom < 0.5) step = 50; 
else step = 10;
```
å¯¼è‡´å‡ºç°ä¸´ç•Œå€¼æŠ–åŠ¨ï¼ˆå¦‚åœ¨zoom=0.5æ—¶é¢‘ç¹åˆ‡æ¢ï¼‰ 

**ç§‘å­¦åŒ–é—´éš”ç®—æ³•**ï¼š  
åº”ç”¨å¯¹æ•°åˆ»åº¦åŠ¨æ€è®¡ç®—æ³•åˆ™ï¼š
```typescript
const baseStep = 10 * Math.pow(10, Math.floor(Math.log10(1/zoom)));
const steps = [baseStep, baseStep*2, baseStep*5];
const validSteps = steps.filter(s => s * zoom >= minDisplayPixels);
step = validSteps[0] || steps[0];
```

**å¯è§†åŒ–éªŒè¯**ï¼š  

| ç¼©æ”¾çº§åˆ« | æ—§ç®—æ³•ç»“æœ | æ–°ç®—æ³•ç»“æœ | æ”¹è¿›ç‚¹                |
|----------|------------|------------|----------------------|
| 0.18     | 100px      | 100px      | ç»´æŒç¨³å®šæ€§           | 
| 0.25     | 50px       | 50px       | çº¿æ€§è¿‡æ¸¡åŒºé—´         |
| 0.6      | 10px       | 20px       | é¿å…è¿‡åº¦è·³è·ƒ         |
| 1.2      | 10px       | 10px       | æ”¯æŒäºš10pxç²¾åº¦      |

---

### ä¸‰ã€å¼‚æ„DPIè®¾å¤‡æ¨¡ç³Šé—®é¢˜ (æ˜¾æ€§ç¼ºé™·)
**ç¼ºé™·ä»£ç **ï¼š  
åˆ›å»ºCanvasæ—¶åªè®¾ç½®äº†å®¹å™¨ç‰©ç†å°ºå¯¸ï¼š
```typescript
horizontalRuler.width = horizontalRulerContainer.clientWidth;
verticalRuler.height = verticalRulerContainer.clientHeight;
```

**é«˜DPIé€‚é…æ–¹æ¡ˆ**ï¼š  
```typescript
const dpr = window.devicePixelRatio || 1;
horizontalRuler.width = horizontalRulerContainer.clientWidth * dpr;
horizontalRuler.height = 20 * dpr; // 20ä¸ºæ ‡å°ºé«˜åº¦
horizontalRuler.style.width = `${horizontalRulerContainer.clientWidth}px`;
horizontalRuler.style.height = `20px`;
ctx.scale(dpr, dpr); // å…³é”®ç¼©æ”¾æ“ä½œ
```

---

### å››ã€å‚è€ƒçº¿åŠ¨æ€å¸é™„å¤±æ•ˆ (äº¤äº’ç—›ç‚¹)
å½“å‰å®ç°åªèƒ½åˆ›å»ºé™æ€å‚è€ƒçº¿ï¼Œç¼ºå°‘ï¼š
```typescript
// åŠ¨æ€å¸é™„æ ¸å¿ƒé€»è¾‘ç¼ºå¤±ï¼š
function checkSnapping(worldPos) {
  const SNAP_THRESHOLD = 5;
  const activeObjects = canvas.getActiveObjects(); 
  activeObjects.forEach(obj => {
    const bounds = obj.getBoundingRect();
    if (Math.abs(bounds.left - worldPos.x) < SNAP_THRESHOLD) {
      return bounds.left; // è¿”å›å¸é™„ç‚¹
    }
    // å…¶ä»–è¾¹ç•Œæ£€æµ‹
  });
}
```

**å®Œæ•´å¸é™„æµç¨‹**ï¼š  
1. åœ¨`onMouseMove`é˜¶æ®µå®æ—¶æ£€æµ‹é™„è¿‘å¯¹è±¡è¾¹ç•Œ  
2. ä½¿ç”¨å››å‰æ ‘ç©ºé—´ç´¢å¼•åŠ é€Ÿæ£€æµ‹  
3. å åŠ åŒåˆ¤æ–­ç­–ç•¥ï¼ˆåƒç´ è·ç¦» & é€»è¾‘åæ ‡è·ç¦»ï¼‰

---

### äº”ã€é‡ç»˜æ€§èƒ½é»‘æ´ (éšæ€§é£é™©)
**ç°å­˜æ€§èƒ½é™·é˜±**ï¼š
```typescript
canvas.on('after:render', () => this.draw());
```
å¯¼è‡´æ‰€æœ‰ç”»å¸ƒæ“ä½œå‡è§¦å‘æ ‡å°ºé‡ç»˜

**ä¼˜åŒ–ç­–ç•¥**ï¼š  
```typescript
// èŠ‚æµæ¸²æŸ“ï¼š
let renderRequested = false;
function requestRender() {
  if (!renderRequested) {
    renderRequested = true;
    requestAnimationFrame(() => {
      this.draw();
      renderRequested = false;
    });
  }
}

canvas.on({
  'object:moving': requestRender,
  'mouse:wheel': requestRender
});
```

---

### å…­ã€é€†çŸ©é˜µè®¡ç®—ç¼ºé™· (æ•°å­¦é”™è¯¯)
**åŸä»£ç æ½œåœ¨é”™è¯¯**ï¼š  
è§†å›¾å˜æ¢æœªæ­£ç¡®åˆ†è§£æ—‹è½¬åˆ†é‡  
å•çº¯é€šè¿‡zoomå‚æ•°å¤„ç†ä¼šå¯¼è‡´æ–œåˆ‡å˜å½¢

**æ­£ç¡®æ–¹æ¡ˆ**ï¼š  
ä½¿ç”¨å®Œæ•´çŸ©é˜µé€†è¿ç®—ï¼š
```typescript
import { invertTransform } from 'fabric.js/lib/util/misc';

const vpt = canvas.viewportTransform;
const inverted = invertTransform(vpt); // ä½¿ç”¨Fabricè‡ªå¸¦çŸ©é˜µé€†è¿ç®—
ctx.transform(...inverted);
```

---

### ä¸ƒã€å¯¹è±¡è¶Šç•Œæ¸²æŸ“æ®‹ç•™ (è§†è§‰ç¼ºé™·)
**ç°è±¡**ï¼š  
å‚è€ƒçº¿æ‹–å‡ºç”»å¸ƒåä»å¯è§  

**è¾¹ç•Œæ§åˆ¶**ï¼š
```typescript
// åœ¨onMouseMoveä¸­æ·»åŠ è¾¹ç•Œæ£€æµ‹ï¼š
const maxX = canvas.width / zoom; 
const maxY = canvas.height / zoom;

this.currentGuide.position = Math.max(0, Math.min(position, maxX)); 
```

---

### å…«ã€åˆ†å±‚äº‹ä»¶å†²çª (äº¤äº’é˜»æ–­)
**å½“å‰é—®é¢˜**ï¼š  
æœªå¤„ç†æ ‡å°ºåŒºåŸŸäº‹ä»¶å†’æ³¡ï¼Œå¯¼è‡´ï¼š
- æ ‡å°ºç‚¹å‡»å¯èƒ½è¯¯è§¦å‘ä¸‹å±‚ç”»å¸ƒé€‰åŒº
- å¿«é€Ÿæ“ä½œæ—¶äº‹ä»¶æµæ··ä¹±

**ä¿®å¤æ–¹æ¡ˆ**ï¼š  
```typescript
private initEventHandlers() {
  this.horizontalRuler.addEventListener('mousedown', (e) => {
    e.stopPropagation(); // é˜»æ–­äº‹ä»¶ä¼ æ’­
    this.onMouseDown(e, 'horizontal');
  });
  // å…¶ä»–äº‹ä»¶åŒç†
}
```

---

### ä¹ã€å¤šå‚è€ƒçº¿æ·±åº¦ç®¡ç†ç¼ºé™· (æ•°æ®é£é™©)
**ç°å­˜éšæ‚£**ï¼š  
ä½¿ç”¨çº¿æ€§æ•°ç»„å­˜å‚¨å¯¼è‡´æ“ä½œå¤æ‚åº¦ä¸ºO(n)  
```typescript
private guidelines: GuideLine[] = [];
```

**é«˜æ•ˆæ•°æ®ç»“æ„**ï¼š  
```typescript
interface GuideLineMap {
  horizontal: Map<number, GuideLine>;
  vertical: Map<number, GuideLine>;
}

// æ”¯æŒå¿«é€ŸæŸ¥æ‰¾ä¸å»é‡
this.guidelines.vertical.set(position, newLine);
```

---

### åã€åæ ‡è½¬æ¢ç²¾åº¦ä¸¢å¤± (è®¡ç®—è¯¯å·®)
**è¯¯å·®åœºæ™¯**ï¼š  
ç›´æ¥å–æ•´å¯¼è‡´å‚è€ƒçº¿ä½ç½®åç§»  
```typescript
const position = Math.round(pos / step) * step; // ç²¾åº¦æˆªæ–­
```

**äºšåƒç´ è¡¥å¿æŠ€æœ¯**ï¼š
```typescript
// æ·»åŠ äºšåƒç´ åç§»è¡¥å¿
const compensate = (origin: number) => {
  const scaled = origin * devicePixelRatio;
  return Math.round(scaled) / devicePixelRatio;
}

const precisePos = compensate(rawPos);
```

---

### æ€»ç»“ä¼˜åŒ–æ–¹æ¡ˆ

| é—®é¢˜çº§åˆ« | ä¼˜åŒ–ç‚¹                 | é¢„æœŸæ”¶ç›Š                      | å®ç°æˆæœ¬ |
|----------|-----------------------|-------------------------------|----------|
| è‡´å‘½ç¼ºé™· | çŸ©é˜µé€†è¿ç®—ä¿®æ­£         | ç¡®ä¿å¤æ‚å˜æ¢ä¸‹æ˜¾ç¤ºæ­£ç¡®æ€§       | é«˜       |
| ä¸¥é‡ç¼ºé™· | DPRé€‚é…               | æå‡é«˜åˆ†è¾¨ç‡è®¾å¤‡æ˜¾ç¤ºæ¸…æ™°åº¦     | ä¸­       |
| é‡è¦ç¼ºé™· | å‚è€ƒçº¿å¸é™„ç®—æ³•         | æå‡ä¸“ä¸šç”¨æˆ·æ“ä½œä½“éªŒ           | é«˜       |  
| ä¼˜åŒ–é¡¹   | åŠ¨æ€åˆ»åº¦ç®—æ³•           | å¢å¼ºå¯è§†åŒ–ä¿¡æ¯å¯†åº¦åˆç†æ€§       | ä¸­       |
| ä¼˜åŒ–é¡¹   | åˆ†å±‚äº‹ä»¶ç®¡ç†           | é¿å…äº¤äº’å†²çªæå‡æ“ä½œæµç•…åº¦     | ä½       |

å»ºè®®ä¼˜å…ˆå¤„ç†å‰ä¸‰ç±»é—®é¢˜ï¼Œå…¶ä»£ç æ”¹åŠ¨é‡çº¦å æ€»å·¥ä½œé‡çš„70%ï¼Œä½†å¯è§£å†³90%çš„æ ¸å¿ƒäº¤äº’é—®é¢˜ã€‚
