> ğŸ’­ å—¯ï¼Œç”¨æˆ·ç°åœ¨ç»™äº†æˆ‘ä¸€æ®µä½¿ç”¨Web Workerçš„ä»£ç ï¼Œçœ‹èµ·æ¥æ˜¯ç”¨æ¥åœ¨åå°çº¿ç¨‹åŠ è½½å’Œå¤„ç†3Dæ¨¡å‹çš„ã€‚æˆ‘éœ€è¦ä»”ç»†åˆ†æè¿™ä¸ªä»£ç çš„ç»“æ„å’ŒåŠŸèƒ½ï¼Œæ‰¾å‡ºå¯èƒ½å­˜åœ¨çš„é—®é¢˜å¹¶æå‡ºä¼˜åŒ–å»ºè®®ã€‚
>
> é¦–å…ˆï¼Œä»£ç çš„æ•´ä½“ç»“æ„æ˜¯ä¸€ä¸ªWeb Workerï¼Œé€šè¿‡onmessageç›‘å¬ä¸»çº¿ç¨‹çš„æ¶ˆæ¯ã€‚å½“æ¥æ”¶åˆ°æ–‡ä»¶å’Œç›¸å…³å‚æ•°æ—¶ï¼Œå®ƒå¯åŠ¨äº†å¼‚æ­¥çš„æ¨¡å‹åŠ è½½è¿‡ç¨‹ã€‚è¿™é‡Œä½¿ç”¨Babylon.jsæ¥åŠ è½½å’Œå¤„ç†æ¨¡å‹ï¼Œç„¶ååœ¨åŠ è½½å®Œæˆåé€šè¿‡postMessageè¿”å›ç»“æœã€‚ä½†çœ‹èµ·æ¥ä»£ç è¿˜æœ‰ä¸€äº›æ½œåœ¨çš„é—®é¢˜éœ€è¦è§£å†³ã€‚
>
> æ¥ä¸‹æ¥ï¼Œæˆ‘çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°ã€‚ç¬¬ä¸€éƒ¨åˆ†æ˜¯æ¨¡å‹åŠ è½½çš„ImportMeshå‡½æ•°ï¼Œä¼ é€’äº†urlã€sceneï¼Œç„¶ååœ¨åŠ è½½å®Œæˆåè°ƒæ•´æ¨¡å‹çš„ä¸­å¿ƒç‚¹ã€‚è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼ŒURLçš„å¤„ç†æ˜¯å¦æ­£ç¡®ï¼Ÿå› ä¸ºåœ¨Web Workerä¸­ï¼Œæ–‡ä»¶çš„è·¯å¾„å¯èƒ½ä¼šæœ‰é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å½“ä¼ å…¥çš„æ˜¯Blobæˆ–è€…Fileå¯¹è±¡æ—¶ï¼Œéœ€è¦æ­£ç¡®å¤„ç†ã€‚è¿™é‡Œçš„urlå‚æ•°æ˜¯file.originFileï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡æˆ–å­—ç¬¦ä¸²ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥å…¶ç±»å‹å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚
>
> è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯åœ¨è°ƒæ•´æ¨¡å‹çš„ä¸­å¿ƒç‚¹æ—¶ï¼Œæ˜¯å¦åº”è¯¥é’ˆå¯¹æ¯ä¸ªç½‘æ ¼è¿›è¡Œæ“ä½œï¼Ÿä¹Ÿè®¸åº”è¯¥è®¡ç®—æ•´ä¸ªåœºæ™¯çš„åŒ…å›´ç›’ï¼Œè€Œä¸ä»…ä»…æ˜¯æ¯ä¸ªç½‘æ ¼çš„å•ç‹¬ä¸­å¿ƒç‚¹ã€‚å¦åˆ™ï¼Œå¦‚æœæ¨¡å‹ç”±å¤šä¸ªç½‘æ ¼ç»„æˆï¼Œæ¯ä¸ªç½‘æ ¼éƒ½ä¼šè¢«å•ç‹¬å±…ä¸­ï¼Œå¯¼è‡´æ•´ä½“ä½ç½®ä¸æ­£ç¡®ã€‚
>
> ç„¶åæ˜¯å…³äºç›¸æœºçš„è®¾ç½®ï¼Œè¿™é‡Œè§£é™¤äº†ä¸Šä¸‹è§’åº¦çš„é™åˆ¶ï¼Œä½†ä»£ç ä¸­å°†upperBetaLimitå’ŒlowerBetaLimitè®¾ç½®ä¸ºnullã€‚åœ¨Babylon.jsä¸­ï¼Œé»˜è®¤çš„ArcRotateCameraçš„ä¸Šä¸‹è§’åº¦é™åˆ¶å¯èƒ½å·²ç»æ˜¯åˆç†çš„ï¼Œè§£é™¤é™åˆ¶å¯èƒ½å¯¼è‡´ç›¸æœºæ—‹è½¬è¿‡äºè‡ªç”±ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚éœ€è¦ç¡®è®¤æ˜¯å¦éœ€è¦è§£é™¤è¿™äº›é™åˆ¶ï¼Œæˆ–è€…æ˜¯å¦åº”è¯¥æ ¹æ®å®é™…éœ€æ±‚è®¾ç½®åˆç†çš„è§’åº¦é™åˆ¶ã€‚
>
> å…‰ç…§éƒ¨åˆ†ä½¿ç”¨äº†HemisphericLightï¼Œå¹¶è®¾ç½®äº†æ–¹å‘å’Œé¢œè‰²ã€‚ä½†æ˜¯ä»£ç ä¸­å°†groundColorè®¾ç½®ä¸ºé»‘è‰²ï¼Œè¿™å¯èƒ½å¯¼è‡´åœºæ™¯çš„é˜´å½±éƒ¨åˆ†è¿‡æš—ã€‚å¦å¤–ï¼Œlight.direction.copyFrom(camera.rotation)å¯èƒ½åœ¨æ¯ä¸€å¸§ä¹‹å‰è¢«è°ƒç”¨ï¼Œä½†æ˜¯camera.rotationæ˜¯ä¸€ä¸ªå››å…ƒæ•°å—ï¼Ÿè¿™é‡Œå¯èƒ½éœ€è¦ä½¿ç”¨camera.getTarget()æˆ–ç›¸æœºçš„targetä½ç½®æ¥ç¡®å®šå…‰ç…§æ–¹å‘æ˜¯å¦æ­£ç¡®è·Ÿéšç›¸æœºã€‚
>
> æè´¨å¤„ç†éƒ¨åˆ†ï¼Œè¿™é‡Œä¸ºæ¯ä¸ªç½‘æ ¼åˆ›å»ºäº†é»˜è®¤æè´¨ï¼Œå¹¶è®¾ç½®äº†åŒé¢æ¸²æŸ“å’Œç›¸å…³é¢œè‰²ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå°¤å…¶æ˜¯å½“æ¨¡å‹æœ‰å¾ˆå¤šç½‘æ ¼æ—¶ï¼Œæ¯ä¸ªç½‘æ ¼éƒ½æœ‰å•ç‹¬çš„æè´¨å®ä¾‹ã€‚åº”è¯¥è€ƒè™‘å…±äº«æè´¨å®ä¾‹ï¼Œä»¥å‡å°‘èµ„æºæ¶ˆè€—ã€‚
>
> å¦å¤–ï¼Œåœ¨æ¨¡å‹åŠ è½½å®Œæˆåï¼Œè®¾ç½®äº†ä¸€ä¸ªsetTimeoutå»¶è¿Ÿ1ç§’åå†å‘é€æˆåŠŸæ¶ˆæ¯ï¼Œè¿™æ ·çš„ç¡¬ç¼–ç å»¶è¿Ÿå¯èƒ½ä¸å¯é ã€‚åº”è¯¥é€šè¿‡æ£€æµ‹æ¸²æŸ“å¾ªç¯æ˜¯å¦å®Œæˆæˆ–ä½¿ç”¨Babylonçš„å›è°ƒæ¥ç¡®è®¤åœºæ™¯å·²ç»æ­£ç¡®æ¸²æŸ“ï¼Œè€Œä¸æ˜¯ä¾èµ–å®šæ—¶å™¨ã€‚
>
> è¿˜æœ‰åœ¨Web Workerä¸­ä½¿ç”¨Babylon.jsæ˜¯å¦æ­£ç¡®ï¼Ÿå¯èƒ½å­˜åœ¨æ— æ³•è®¿é—®DOMçš„é—®é¢˜ï¼Œå› ä¸ºWeb Workerä¸èƒ½æ“ä½œDOMï¼Œè€ŒBabylon.jsé€šå¸¸ä¾èµ–äºcanvaså…ƒç´ è¿›è¡Œæ¸²æŸ“ã€‚ä½†å®é™…ä¸Šï¼Œè¿™é‡Œåœ¨Workerä¸­åˆ›å»ºäº†ä¸€ä¸ªengineå’Œsceneå¯èƒ½å¹¶ä¸æ­£ç¡®ï¼Œå› ä¸ºå®é™…çš„æ¸²æŸ“å¿…é¡»å‘ç”Ÿåœ¨ä¸»çº¿ç¨‹ã€‚å¯èƒ½ç”¨æˆ·è¯¯è§£äº†Web Workerçš„ç”¨é€”ï¼Œæˆ–è€…è¿™é‡Œçš„ä»£ç ç»“æ„æœ‰é—®é¢˜ã€‚çœŸæ­£çš„3Dæ¸²æŸ“åº”è¯¥åœ¨ä¸»çº¿ç¨‹ï¼Œè€Œæ•°æ®å¤„ç†å¯ä»¥åœ¨Workerï¼Œéœ€è¦æ˜ç¡®åˆ†å·¥ã€‚
>
> å¦å¤–ï¼Œåœ¨æ–‡ä»¶è§£æé˜¶æ®µï¼Œä½¿ç”¨SceneLoader.ImportMeshå¯èƒ½é€‚åˆåœ¨Workerä¸­è¿›è¡Œï¼Œä½†è¿”å›ç»“æœéœ€è¦é€šè¿‡Transferableå¯¹è±¡ä¼ é€’ç»™ä¸»çº¿ç¨‹ï¼Œæˆ–è€…ç”Ÿæˆé¢„è§ˆå›¾åƒåä¼ é€’base64æ•°æ®ã€‚å½“å‰çš„ä»£ç ä¼¼ä¹åœ¨Workerå†…éƒ¨è¿›è¡Œæ¸²æŸ“ï¼Œä½†Web Workeræ— æ³•ç›´æ¥æ“ä½œCanvasè¿›è¡Œæ¸²æŸ“è¾“å‡ºï¼Œè¿™ä¼šå¯¼è‡´é—®é¢˜ã€‚æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯å°†æ¨¡å‹çš„å‡ ä½•æ•°æ®åºåˆ—åŒ–ä¼ é€’åˆ°ä¸»çº¿ç¨‹ï¼Œç”±ä¸»çº¿ç¨‹è¿›è¡Œæ¸²æŸ“ã€‚
>
> ç»¼ä¸Šï¼Œè¿™æ®µä»£ç çš„ä¸»è¦é—®é¢˜åœ¨äºå°è¯•åœ¨Web Workerä¸­è¿›è¡Œå®Œæ•´çš„æ¨¡å‹åŠ è½½å’Œæ¸²æŸ“ï¼Œè¿™åœ¨æŠ€æœ¯ä¸Šæ˜¯ä¸å¯è¡Œçš„ï¼Œå› ä¸ºWeb Workeræ— æ³•ç›´æ¥è®¿é—®WebGLä¸Šä¸‹æ–‡ã€‚æ­£ç¡®çš„åšæ³•æ˜¯å°†æ¨¡å‹åŠ è½½å’Œæ•°æ®å¤„ç†ï¼ˆå¦‚è§£æã€è®¡ç®—åŒ…å›´ç›’ç­‰ï¼‰æ”¾åœ¨Workerä¸­è¿›è¡Œï¼Œç„¶åå°†å¤„ç†åçš„æ•°æ®ä¼ é€’ç»™ä¸»çº¿ç¨‹è¿›è¡Œå®é™…æ¸²æŸ“ã€‚åŒæ—¶ï¼Œéœ€è¦ä¼˜åŒ–æè´¨ç®¡ç†ã€ç›¸æœºè®¾ç½®å’Œå…‰ç…§è°ƒæ•´ï¼Œç¡®ä¿æ€§èƒ½å’Œè§†è§‰æ•ˆæœã€‚
>
> 



ä»¥ä¸‹æ˜¯å¯¹æä¾›çš„ Web Worker ä»£ç çš„åˆ†æä¸ä¼˜åŒ–å®ç°ï¼š

---

### æ ¸å¿ƒé—®é¢˜æ¢³ç†

#### 1. **çº¿ç¨‹è´£ä»»æ¨¡ç³Š**
```javascript
const engine = new Babylon.Engine(canvas, true) // âŒ Web Worker æ— æ³•å¤„ç†çœŸå®çš„ Canvas æ¸²æŸ“
```
* **é—®é¢˜**: Web Worker æ— æ³•ç›´æ¥æ“ä½œ DOM/WebGL æ¸²æŸ“ï¼Œåº”å½“åªæ‰¿æ‹…æ•°æ®è®¡ç®—ä»»åŠ¡

#### 2. **åŒ…å›´ç›’è®¡ç®—é€»è¾‘ä¸å‡†ç¡®**
```javascript
mesh.setPivotPoint( // å„ç½‘æ ¼å•ç‹¬å±…ä¸­ âŒ
```
* **é—®é¢˜**: åº”åŸºäºæ•´ä¸ªæ¨¡å‹çš„å…¨å±€åŒ…å›´ç›’è°ƒæ•´

#### 3. **å…‰ç…§ç³»ç»Ÿä¸ç›¸æœºè”åŠ¨ç¼ºé™·**
```javascript
light.direction.copyFrom(camera.rotation) // é”™è¯¯çš„æ–¹å‘åŒæ­¥æ–¹å¼ âŒ
```
* **é—®é¢˜**: åº”ä½¿ç”¨ `camera.getForwardRay().direction` è·å–å‰å‘å‘é‡

#### 4. **å®šæ—¶å™¨ç¡¬ç¼–ç é£é™©**
```javascript
setTimeout(() => { ... }, 1000) // éå¯é é€»è¾‘ âš ï¸
```
* **é£é™©**: å¼‚æ­¥æ“ä½œæ— æ³•ä¿è¯è€—æ—¶é•¿åº¦ä¸€è‡´

---

### é‡æ„å»ºæ–¹æ¡ˆ

#### ğŸ“ worker.js (ä¼˜åŒ–å)
```javascript
import '@babylonjs/core/Loading/loadingScreen'
import { SceneLoader, Mesh, Vector3, BoundingBox } from '@babylonjs/core'
import { GeometrySerializer } from 'babylonjs-serializers'

let _sceneCache = null // èµ„æºç¼“å­˜

onmessage = async ({ data }) => {
  const { file, options } = data

  try {
    const { meshes, bounds } = await parseModel(file, options)
    
    // ä¼ è¾“ä¼˜åŒ–ï¼šåºåˆ—åŒ–åçš„å‡ ä½•æ•°æ®
    const transferList = GeometrySerializer.Serialize(meshes)
    postMessage({
      status: 'ready', 
      data: {
        geometries: transferList,
        center: bounds.center.asArray(),
        extents: bounds.extents.asArray()
      }
    }, [transferList.buffer])
  } catch (error) {
    postMessage({ status: 'error', error: error.message })
  }
}

async function parseModel(file, options) {
  // æ–‡ä»¶é¢„å¤„ç†
  const blobUrl = URL.createObjectURL(file)
  
  // åŠ è½½æ¨¡å‹å¹¶è®¡ç®—å…¨å±€åŒ…å›´ç›’  
  const { meshes } = await SceneLoader.ImportMeshAsync('', blobUrl, null)
  const globalBounds = new BoundingBox()
  
  meshes.forEach(mesh => {
    mesh.refreshBoundingInfo(true)
    BoundingBox.Merge(globalBounds, mesh.getBoundingInfo().boundingBox)
  })
  
  // é‡Šæ”¾å¼•ç”¨
  URL.revokeObjectURL(blobUrl)
  
  return {
    meshes,
    bounds: {
      center: globalBounds.center,
      extents: globalBounds.extend
    }
  }
}
```

#### ğŸ“¦ MainThreadComponent.jsx
```javascript
import { GeometrySerializer } from 'babylonjs-serializers'

class PreviewRenderer {
  constructor(canvas) {
    this.engine = new BABYLON.Engine(canvas)
    this.scene = new BABYLON.Scene(this.engine)
    
    this._worker = new Worker('./modelParser.worker.js') 
    this._worker.onmessage = this.handleWorkerMessage
  }

  async loadModel(file) {
    this.engine.displayLoadingUI() // æ˜¾ç¤ºåŠ è½½ç•Œé¢
    
    // å‘é€è§£æä»»åŠ¡
    this._worker.postMessage({ 
      file, 
      options: { 
        precision: 'high', 
        materialPolicy: 'meta-only' 
      }
    })
  }

  handleWorkerMessage = ({ data }) => {
    if(data.status === 'ready') {
      this.rebuildScene(data.geometries, data.bounds)
      this.engine.hideLoadingUI()
      this.renderLoop()
    }
  }

  rebuildScene(serializedGeoms, bounds) {
    // ååºåˆ—åŒ–å‡ ä½•ä½“
    const meshes = GeometrySerializer.Parse(serializedGeoms, this.scene)
    
    // ä¸­å¿ƒåŒ–åœºæ™¯
    const pivot = new BABYLON.Vector3().copyFrom(bounds.center)
    meshes.forEach(mesh => {
      mesh.setPivotPoint(pivot) 
      mesh.position.subtractInPlace(pivot)
    })
    
    // é…ç½®æœ€ä½³ç›¸æœºè§†è§’
    this.setupCamera(bounds)
    this.setupLightTracking()
  }

  setupCamera({ extents }) {
    const radius = Vector3.Distance(extents, Vector3.Zero()) * 1.5
    this.camera.lowerRadiusLimit = radius * 0.1
    this.camera.upperRadiusLimit = radius * 5
    // ...åŠ¨æ€è°ƒæ•´å…¶ä»–å‚æ•°
  }

  setupLightTracking() {
    this.scene.registerBeforeRender(() => {
      const lightDir = this.camera.getForwardRay().direction
      this._light.direction.copyFrom(lightDir)
    })
  } 
}
```

---

### æ€§èƒ½ä¼˜åŒ–æ¸…å•

#### âš¡ï¸ **æ”¹è¿›ç‰ˆç¼“å­˜ç­–ç•¥**
```javascript
// worker.js
const LRUCache = {
  maxSize: 5,
  map: new Map(),
  
  get(key) {
    if(this.map.has(key)) {
      const value = this.map.get(key)
      this.map.delete(key)
      this.map.set(key, value)
      return value
    }
  },
  
  set(key, value) {
    if(this.map.size >= this.maxSize) {
      const oldest = this.map.keys().next().value
      this.map.delete(oldest)
    }
    this.map.set(key, value)
  }
}

async function parseModel(file) {
  const cacheKey = await hashFile(file)
  
  if(LRUCache.get(cacheKey)) {
    return LRUCache.get(cacheKey)  
  }
  
  // ...æ­£å¸¸è§£ææµç¨‹
  LRUCache.set(cacheKey, result)
  return result
}
```

---

### æœ€ä½³å®è·µå»ºè®®

1. **æ¸²æŸ“çº¿ç¨‹åˆ†å·¥**
   - ğŸŒˆ **Worker**: åªè´Ÿè´£æ¨¡å‹è§£æå’Œå‡ ä½•è®¡ç®—
   - ğŸ® **Main Thread**: å¤„ç†ç”¨æˆ·äº¤äº’å’Œå®é™…ç»˜åˆ¶

2. **æ¸è¿›å¼åŠ è½½**
   ```javascript
   postMessage({
     phase: 'texture-loaded',
     progress: 0.3
   })
   ```

3. **å®¹é”™æœºåˆ¶**
   ```javascript
   try {
     await loadWithRetry(url, { retries: 3 })
   } catch(err) {
     showFallbackPreview()
   }
   ```

è¯¥æ¶æ„é€šè¿‡æ˜ç¡®çš„çº¿ç¨‹åˆ†å·¥å’Œåºåˆ—åŒ–æœºåˆ¶ï¼Œå®ç°äº†å¤æ‚æ¨¡å‹çš„å®‰å…¨åŠ è½½ä¸é«˜æ•ˆè§£æï¼ŒåŒæ—¶é€šè¿‡ç¼“å­˜å’Œæ¸è¿›å¼åé¦ˆä¿éšœäº¤äº’æµç•…åº¦ã€‚
