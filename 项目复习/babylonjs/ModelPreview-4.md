> ğŸ’­ å—¯ï¼Œç”¨æˆ·è¯´ï¼šâ€œè¯¦ç»†è®²è§£ä¸€ä¸‹è¿™ä¸ªä»£ç â€ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨Reactå’ŒBabylon.jså®ç°çš„3Dæ¨¡å‹é¢„è§ˆç»„ä»¶ã€‚æˆ‘éœ€è¦å…ˆç†è§£æ•´ä¸ªä»£ç ç»“æ„ã€‚
>
> é¦–å…ˆï¼Œæ³¨æ„åˆ°ç»„ä»¶å¯¼å…¥äº†å¾ˆå¤šBabylon.jsçš„æ¨¡å—ï¼Œæ¯”å¦‚å¼•æ“ã€åœºæ™¯ã€åŠ è½½å™¨ã€å…‰ç…§ã€ç›¸æœºç­‰ã€‚è¿™è¯´æ˜ç»„ä»¶çš„ä¸»è¦åŠŸèƒ½æ˜¯åˆ›å»ºä¸€ä¸ª3Dåœºæ™¯ï¼ŒåŠ è½½å¹¶æ˜¾ç¤ºæ¨¡å‹ã€‚è¿˜æœ‰Reactçš„ä¸€äº›é’©å­ï¼Œæ¯”å¦‚useEffectã€useRefï¼Œä»¥åŠahooksçš„useLatestï¼Œç”¨äºç®¡ç†çŠ¶æ€å’Œå‰¯ä½œç”¨ã€‚
>
> ä»£ç çš„ç»“æ„æ˜¯ä¸€ä¸ªReactå‡½æ•°ç»„ä»¶ï¼Œä½¿ç”¨forwardRefæš´éœ²äº†reRenderæ–¹æ³•ï¼Œå…è®¸å¤–éƒ¨è°ƒç”¨é‡æ–°æ¸²æŸ“ã€‚ç»„ä»¶æ¥æ”¶å¤šä¸ªpropsï¼Œæ¯”å¦‚urlï¼ˆæ¨¡å‹åœ°å€ï¼‰ã€è§’åº¦ã€èƒŒæ™¯é¢œè‰²ç­‰ã€‚å…³é”®çš„é€»è¾‘æ˜¯åœ¨useEffectä¸­åˆå§‹åŒ–å’Œé”€æ¯Babylon.jsçš„å¼•æ“å’Œåœºæ™¯ï¼Œå¹¶åœ¨urlå˜åŒ–æ—¶é‡æ–°åŠ è½½æ¨¡å‹ã€‚
>
> é‡ç‚¹éƒ¨åˆ†æ˜¯loadå‡½æ•°ï¼Œè´Ÿè´£åŠ è½½æ¨¡å‹ã€‚è¿™é‡Œåˆ†ä¸¤ç§æƒ…å†µå¤„ç†ï¼šå¦‚æœurlæ˜¯S3æˆ–CloudFrontçš„é“¾æ¥ï¼Œç”¨parallelDownloadåˆ†ç‰‡ä¸‹è½½ï¼Œå¦åˆ™ç›´æ¥åŠ è½½ã€‚åŠ è½½å®Œæˆåè®¾ç½®æ¨¡å‹çš„æè´¨ã€å…‰æºå’Œç›¸æœºçš„å‚æ•°ï¼Œè°ƒæ•´æ¨¡å‹çš„ä¸­å¿ƒå’Œæ—‹è½¬è§’åº¦ã€‚
>
> å¦å¤–ï¼Œæ³¨æ„åˆ°ä½¿ç”¨äº†HemisphericLightå’ŒArcRotateCameraï¼Œè¿™ä¸ºåœºæ™¯æä¾›äº†åŸºç¡€çš„å…‰ç…§å’Œç›¸æœºæ§åˆ¶ã€‚æ¨¡å‹çš„æè´¨è¢«è®¾ç½®ä¸ºåŒé¢æ¸²æŸ“ï¼Œé¢œè‰²ä¹Ÿåšäº†å¤„ç†ï¼Œé€‚åº”ä¸åŒæ¨¡å‹çš„æ˜¾ç¤ºéœ€æ±‚ã€‚
>
> è¿˜éœ€è¦å…³æ³¨æ€§èƒ½ä¼˜åŒ–éƒ¨åˆ†ï¼Œæ¯”å¦‚è®¾ç½®ç¡¬ä»¶ç¼©æ”¾çº§åˆ«ï¼Œé™åˆ¶å¸§ç‡ï¼Œé¿å…åœ¨é›†æˆæ˜¾å¡ä¸Šå¡é¡¿ã€‚disposeSceneç”¨æ¥é‡Šæ”¾èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚reRenderæ–¹æ³•é€šè¿‡é”€æ¯æ—§åœºæ™¯å¹¶é‡æ–°åŠ è½½ï¼Œå®ç°æ¨¡å‹çš„åˆ·æ–°ã€‚
>
> ç”¨æˆ·å¯èƒ½å¯¹Babylon.jså’ŒReactç»“åˆä½¿ç”¨ä¸å¤ªç†Ÿæ‚‰ï¼Œéœ€è¦è§£é‡Šå¦‚ä½•å°†Babylon.jsåµŒå…¥Reactç»„ä»¶ï¼ŒåŒ…æ‹¬å¼•æ“åˆå§‹åŒ–ã€åœºæ™¯ç®¡ç†ä»¥åŠä¸Reactç”Ÿå‘½å‘¨æœŸçš„ç»“åˆã€‚æ­¤å¤–ï¼Œåˆ†ç‰‡ä¸‹è½½çš„parallelDownloadå‡½æ•°å¯èƒ½æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å·¥å…·ï¼Œä½†ä»£ç ä¸­æ²¡æœ‰ç»™å‡ºå®ç°ï¼Œå¯èƒ½éœ€è¦è¯´æ˜å…¶ä½œç”¨ã€‚
>
> è¿˜è¦æ³¨æ„ç»„ä»¶å¦‚ä½•å¤„ç†ä¸åŒçš„è¾“å…¥ç±»å‹ï¼Œæ¯”å¦‚æ–‡ä»¶æ•°ç»„æˆ–å­—ç¬¦ä¸²URLã€‚æ¨¡å‹åŠ è½½åçš„æ—‹è½¬å’Œä¸­å¿ƒè°ƒæ•´æ˜¯å…³é”®æ­¥éª¤ï¼Œç¡®ä¿æ¨¡å‹æ­£ç¡®æ˜¾ç¤ºåœ¨åœºæ™¯ä¸­ã€‚ä½¿ç”¨useImperativeHandleæš´éœ²reRenderï¼Œå…è®¸å¤–éƒ¨è§¦å‘é‡æ–°åŠ è½½ï¼Œè¿™åœ¨åŠ¨æ€æ›´æ–°æ¨¡å‹æ—¶å¾ˆæœ‰ç”¨ã€‚
>
> å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼šä¸ºä»€ä¹ˆéœ€è¦æ‰‹åŠ¨è®¾ç½®æ¨¡å‹çš„pivotç‚¹ï¼Ÿå› ä¸ºä¸åŒçš„æ¨¡å‹å¯¼å‡ºæ–¹å¼å¯èƒ½å¯¼è‡´åŸç‚¹ä¸åœ¨å‡ ä½•ä¸­å¿ƒï¼Œè°ƒæ•´åä½¿å¾—æ—‹è½¬å’Œç¼©æ”¾æ›´ç›´è§‚ã€‚æ­¤å¤–ï¼Œå…‰æºè·Ÿéšç›¸æœºçš„æ–¹å‘ï¼Œç¡®ä¿å…‰ç…§éšç€è§†è§’å˜åŒ–ï¼Œæå‡è§†è§‰æ•ˆæœã€‚
>
> æœ€åï¼Œæ€»ç»“è¿™ä¸ªç»„ä»¶æ˜¯å¦‚ä½•æ•´åˆReactçš„çŠ¶æ€ç®¡ç†å’ŒBabylon.jsçš„3Dæ¸²æŸ“èƒ½åŠ›ï¼Œå®ç°åŠ¨æ€åŠ è½½å’Œæ˜¾ç¤º3Dæ¨¡å‹ï¼ŒåŒæ—¶å…·å¤‡æ€§èƒ½ä¼˜åŒ–å’Œå¯å®šåˆ¶é€‰é¡¹ã€‚
>
> 



ä»¥ä¸‹æ˜¯å¯¹ `src/components/ModelPreview/index.tsx` ä»£ç çš„è¯¦ç»†è®²è§£ï¼š

---

### ä¸€ã€æ•´ä½“ç»“æ„
è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ **React** å’Œ **Babylon.js** å®ç°çš„ 3D æ¨¡å‹é¢„è§ˆç»„ä»¶ï¼Œæ”¯æŒ `STL` å’Œ `OBJ` æ ¼å¼çš„æ¨¡å‹åŠ è½½ä¸äº¤äº’å¼æ˜¾ç¤ºã€‚ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š
- åœºæ™¯åˆå§‹åŒ–ä¸èµ„æºç®¡ç†
- æ”¯æŒè‡ªå®šä¹‰å…‰ç…§ã€ç›¸æœºå‚æ•°ã€æ¨¡å‹åŠ è½½é€‰é¡¹
- å®ç°åˆ†ç‰‡ä¸‹è½½ä¼˜åŒ–ï¼ˆé’ˆå¯¹ S3/CloudFront æ¨¡å‹æ–‡ä»¶ï¼‰
- React çŠ¶æ€ä¸ 3D å¼•æ“çš„é›†æˆ

---

### äºŒã€æ ¸å¿ƒæ¨¡å—è§£æ

#### 1. åŸºç¡€ä¾èµ–ä¸å·¥å…·å‡½æ•°
```typescript
import '@babylonjs/loaders/STL'        // åŠ è½½ STL æ ¼å¼æ”¯æŒ
import '@babylonjs/loaders/OBJ'        // åŠ è½½ OBJ æ ¼å¼æ”¯æŒ
import { Engine } '@babylonjs/core'    // 3D å¼•æ“æ ¸å¿ƒ
import { Scene } '@babylonjs/core'     // 3D åœºæ™¯ç®¡ç†
import { SceneLoader } from '@babylonjs/core' // æ¨¡å‹åŠ è½½å™¨
import { parallelDownload } from 'src/common/utils' // è‡ªå®šä¹‰åˆ†ç‰‡ä¸‹è½½å·¥å…·
```
- `SceneLoader` æ˜¯ Babylon.js çš„æ¨¡å‹åŠ è½½ä¸­æ¢
- `parallelDownload` å¤„ç†å¤§æ–‡ä»¶åˆ†ç‰‡ä¸‹è½½ï¼ˆéœ€å¯¹æ¥å…·ä½“æœåŠ¡ç«¯ï¼‰

---

#### 2. ç»„ä»¶æ¥å£å®šä¹‰
```typescript
interface LoadOptions {   // å¯é…ç½®çš„åŠ è½½é€‰é¡¹
  angle?: number          // åˆå§‹æ—‹è½¬è§’åº¦
  clearColor?: Color4     // åœºæ™¯èƒŒæ™¯è‰²
  upperRadiusLimit?: number // ç›¸æœºè¿œè·é™åˆ¶
  lowerRadiusLimit?: number // ç›¸æœºè¿‘è·é™åˆ¶
  fileExtension?: string  // æ–‡ä»¶æ‰©å±•åï¼ˆç”¨äºç‰¹æ®Šæ ¼å¼ï¼‰
}

type ModelPreviewProps = { // ç»„ä»¶ Props
  url?: string | ArrayBufferView | File[] // æ¨¡å‹æº
  onLoadingChange?: (isLoading: boolean) => void // åŠ è½½çŠ¶æ€å›è°ƒ
  // ...å…¶ä»–é…ç½®å‚æ•°
}

interface ModelPreviewInstance { // Ref æš´éœ²çš„æ–¹æ³•
  reRender(): void
}
```

---

#### 3. æ ¸å¿ƒåŠŸèƒ½å®ç°

##### (1) åœºæ™¯åˆå§‹åŒ– (`useEffect`)
```typescript
useEffect(() => {
  const engine = new Engine(canvas)
  engine.setHardwareScalingLevel(0.5) // GPU æ€§èƒ½é€‚é…
  
  const scene = createDefaultScene(engine) // åˆ›å»ºé»˜è®¤åœºæ™¯
  
  // æ¸²æŸ“å¾ªç¯ï¼ˆé™åˆ¶å¸§ç‡ï¼‰
  engine.runRenderLoop(() => {
    if (Date.now() - lastTime > delta) {
      scene.render()
      lastTime = Date.now()
    }
  })
  
  // çª—å£å¤§å°å˜åŒ–å“åº”
  window.addEventListener('resize', () => engine.resize())
})
```

##### (2) æ¨¡å‹åŠ è½½é€»è¾‘ (`load` å‡½æ•°)
```typescript
const load = async (
  url: string | ArrayBufferView | File[],
  scene: Scene,
  canvas: HTMLCanvasElement,
  options: LoadOptions | null,
  onFinish: (scene: Scene) => void
) => {
  // å¤„ç†åˆ†ç‰‡ä¸‹è½½ï¼ˆä¼˜åŒ–å¤§æ–‡ä»¶åŠ è½½ï¼‰
  if (isS3Url(url)) {
    const stlFile = await parallelDownload(url, {
      splitNumber: 4,
      onProcess: onLoadProgress
    })
    urlOrBuffer = [stlFile]
  }
  
  // ä½¿ç”¨ SceneLoader åŠ è½½æ¨¡å‹
  SceneLoader.ImportMesh('', '', urlOrBuffer, scene, meshes => {
    meshes.forEach(mesh => {
      // è‡ªåŠ¨è®¡ç®—å‡ ä½•ä¸­å¿ƒä½œä¸ºæ—‹è½¬è½´å¿ƒ
      const boundingInfo = mesh.getBoundingInfo()
      mesh.setPivotPoint(
        boundingInfo.maximumWorld.add(boundingInfo.minimumWorld).scale(0.5)
      )
    })
  })
  
  // é…ç½®ç›¸æœºå‚æ•°
  const camera = scene.activeCamera as ArcRotateCamera
  camera.upperRadiusLimit = options?.upperRadiusLimit ?? 10
  camera.lowerRadiusLimit = options?.lowerRadiusLimit ?? 2
  camera.beta = Math.PI / 4 // åˆå§‹ä¿¯è§†è§’ 45 åº¦

  // é…ç½®å…‰ç…§
  const light = new HemisphericLight('hl', new Vector3(0, -1, 0), scene)
  light.intensity = 1.2
  light.groundColor = Color3.Black()
  
  // æè´¨åŒé¢æ¸²æŸ“è®¾ç½®
  scene.meshes.forEach(mesh => {
    const material = mesh.material as StandardMaterial
    material.backFaceCulling = false
    material.twoSidedLighting = true
  })
  
  onFinish(scene)
}
```

##### (3) å…‰ç…§è·Ÿéšç›¸æœº (`registerBeforeRender`)
```typescript
scene.registerBeforeRender(() => {
  const camera = scene.activeCamera as ArcRotateCamera
  light.direction.copyFrom(camera.rotation) // åŠ¨æ€è°ƒæ•´å…‰æºæ–¹å‘
})
```

---

#### 4. React é›†æˆå…³é”®ç‚¹

##### (1) æ€§èƒ½ä¼˜åŒ–
```typescript
const engineRef = useRef<Engine>()       // æŒä¹…åŒ–å¼•æ“å®ä¾‹
const activeSceneRef = useRef<Scene>()   // æŒä¹…åŒ–åœºæ™¯å®ä¾‹
const latestOptions = useLatest(props)   // é¿å…é—­åŒ…é—®é¢˜

// é‡æ–°æ¸²æŸ“æ–¹æ³•ï¼ˆé€šè¿‡ ref æš´éœ²ï¼‰
useImperativeHandle(ref, () => ({
  reRender() {
    disposeScene(activeSceneRef.current)
    doLoad(url, createDefaultScene(engine))
  }
}))
```

##### (2) èµ„æºæ¸…ç†
```typescript
// ç»„ä»¶å¸è½½æ—¶é‡Šæ”¾èµ„æº
useEffect(() => {
  return () => {
    engineRef.current?.dispose()
    disposeScene(activeSceneRef.current)
  }
}, [])
```

---

### ä¸‰ã€å…³é”®è®¾è®¡äº®ç‚¹

1. **åˆ†ç‰‡ä¸‹è½½ä¼˜åŒ–**ï¼š
   ```typescript
   if (/(\.s3\.)|(\.cloudfront\.)/.test(url)) {
     await parallelDownload(url, { splitNumber: 4 })
   }
   ```
   - é’ˆå¯¹ AWS S3 ç­‰å­˜å‚¨æœåŠ¡çš„å¤§æ–‡ä»¶åŠ è½½æé€Ÿ
   - å®ç°å¹¶è¡Œå¤šçº¿ç¨‹ä¸‹è½½ï¼ˆå…·ä½“å®ç°åœ¨ `parallelDownload` å·¥å…·ä¸­ï¼‰

2. **è‡ªåŠ¨ä¸­å¿ƒè®¡ç®—**ï¼š
   ```typescript
   mesh.setPivotPoint(
     boundingInfo.maximumWorld
       .add(boundingInfo.minimumWorld)
       .scale(0.5)
   )
   ```
   - åŠ¨æ€è®¡ç®—æ¨¡å‹åŒ…å›´ç›’ä¸­å¿ƒä½œä¸ºæ—‹è½¬è½´å¿ƒ
   - è§£å†³ä¸åŒå»ºæ¨¡è½¯ä»¶å¯¼å‡ºçš„æ¨¡å‹è½´å¿ƒä¸ä¸€è‡´é—®é¢˜

3. **å¸§ç‡æ§åˆ¶**ï¼š
   ```typescript
   const fps = isIntegratedGPU() ? 30 : 60
   const delta = 1000 / fps
   ```
   - æ ¹æ® GPU ç±»å‹åŠ¨æ€è°ƒæ•´æ¸²æŸ“å¸§ç‡
   - é›†æˆæ˜¾å¡è®¾å¤‡é™åˆ¶åˆ° 30 FPS ä»¥é™ä½åŠŸè€—

---

### å››ã€å…¸å‹ä½¿ç”¨åœºæ™¯
```tsx
// åœ¨çˆ¶ç»„ä»¶ä¸­çš„ä½¿ç”¨
<ModelPreview
  ref={modelRef}
  url="https://model-bucket.s3.amazonaws.com/robot.stl"
  angle={Math.PI/6}
  clearColor={new Color4(0.8, 0.8, 0.8, 1)}
  onLoadingChange={setLoading}
/>

// é‡æ–°åŠ è½½æ¨¡å‹
modelRef.current?.reRender()
```

æ­¤ä»£ç å®ç°äº†ä¸€ä¸ªé«˜æ€§èƒ½ã€å¯å¤ç”¨çš„3Dé¢„è§ˆç»„ä»¶ï¼Œå…¼å…·äº¤äº’æ€§ä¸æ‰©å±•æ€§ï¼Œé€‚åˆå„ç§éœ€è¦Webå±•ç¤º3Dæ¨¡å‹çš„åº”ç”¨åœºæ™¯ã€‚
