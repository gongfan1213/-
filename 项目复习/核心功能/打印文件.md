

**4.1.5 打印文件**

**4.1.5.1 总述**

*   **定义:** 当用户点击“打印”按钮时，系统会根据用户编辑的项目作品，生成设备需要打印的项目打印文件。
*   **目标:** 发起打印成功率 > 99.9%

**4.1.5.2 流程图 (详细整理)**

1.  **准备打印:**
    *   判断是否有最近使用的打印机,
    *   true: 到选择打印机配套设置
    *   false: 保存到我的项目.

2.  **选择打印机配套设置:**
    *   提示成功

3.  **每个画布分别生成打印文件:**
     *  自动检测1-5层有多少层.生成1-5张图.
       *  完整检测1-5层.
       *   完整性检测1-5层，有无缺少图层.
       *   生成纹理.
       *   生成光油.
       *  生成uv+uvlog打印文件.
        *  生成缩略图文件.

4.  **判断用户选择的打印机:**
    *   判断是否上传后台,
       * true:上传到后台, js/scene传递, 调试打印机.
       * false: 发送到用户选择的打印机: 筛选打印机

5. **筛选打印机:**
     *    筛选打印机:

6.  **上传到后台:**
 * 上传到后台

7. **调用打印:**
     *    调用打印

**4.1.5.3 接口设计**

*   **通信渠道:**
    *   `jsbridge`:
        *   **功能:** `jsbridge` 通信，`action` 是通信事件，`data` 是传递数据，当前是 tar 包（打印项目文件 + 打印数据文件）。
        *   **通信协议:**

            ```json
            {
              "action": "command_print",
              "data": {}
            }
            ```
    *   `scheme`:
        *   **功能:** 浏览器跳转到切片软件开始打印。
        *   **通信协议:** `ankerstudio://open/?project_id=f24eceffa33e1a09121e0df365a6691f&source=2dPrint&ud=xxxxx`

**4.1.5.4 数据存储设计**

*   **文件名示例:** `print_8c00d9563681fe0e0f6090a24c461c9b.tar` (180.00KB)
*   **config.json (示例):**
    *   `printModel`: 打印模式（根据产品定义的打印图层结构，包括全白墨、光油、全不打等）。
    *   `printlayerdata`: 里面包括打印图层信息，具体第几层打印什么，如：第一层打印什么图层，一共打印多少层，对应的图片名字是什么。

**另一个流程图 (详细整理): fabric 加载图层 json**

1.  **fabric 加载图层 json:** 开始流程。

2.  **加载监听:** 加载相关的监听器。

3.  **版本判断:** 进行版本判断。

4.  **发现旧版本?:**
    *   **True:** 根据版本号，修改对旧版本兼容。
    *   **False:** 根据最新代码处理。

5.  **得到最后渲染数据:** 流程结束。

**要点提炼:**

*   **打印文件生成:** 当用户点击打印时，系统会为每个画布生成打印文件。
*   **多层打印:** 支持多达 5 层的打印，并能生成纹理、光油等效果。
*   **通信方式:**
    *   `jsbridge`: 用于与客户端通信，传递 tar 包。
    *   `scheme`: 用于唤起切片软件。
*   **数据格式:**
    *   `.tar`: 包含打印项目文件和数据的压缩包。
    *   `config.json`: 包含打印模式和图层信息。
*   **版本兼容:** 系统能够处理旧版本的 json 数据。

**总结:**

这部分内容详细描述了打印文件的生成流程、通信方式、数据格式以及版本兼容机制。它展现了一个支持多层打印、多种打印效果，并能与客户端和切片软件进行交互的复杂打印系统。 另一个流程图展示了fabric加载图层json时候,处理兼容性的流程.
