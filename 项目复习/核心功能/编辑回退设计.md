

**编辑回退设计 (Undo/Redo)**

**设计者:** Kingsley Zhu

**核心概念:**

1.  **历史记录存储:**
    *   采用容量为 50 的 FIFO (First-In, First-Out，先进先出) 数据结构。
    *   这意味着最多保存 50 个历史操作记录，最早的操作记录会被最新的记录替换。

2.  **单条记录数据:**
    *   以 fabric.js 规则下的 JSON 字符串进行保存。
    *   fabric.js 是一个 JavaScript Canvas 库，这表明此设计是针对基于 Canvas 的编辑器。

3.  **触发动作:**
    *   以画布图层元素的增删改作为触发历史保存的动作。

**数据结构与操作:**

*   **History Stack (历史堆栈):**
    *   用于存储历史记录 (History Record) 的 FIFO 队列。
    *   最多存储 50 个 History Record。

*   **History Record (历史记录):**
    *   包含一个操作的完整信息 (fabric.js 的 JSON 字符串)。

*   **指针:**
    *   默认指向当前最新操作。

**操作流程:**

1.  **初始状态:**
    *   History Stack 中包含多个 History Record (最多 50 个)。
    *   指针指向最新的 History Record。

2.  **丢弃操作**
      *  指针默认指向当前最新操作

3.  **用户后退 (Undo):**
    *   指针向前移动（前进操作同理）
   *   History Stack的内容不变

4.  **后退后添加记录:**
    *   如果在撤销（后退）操作后进行了新的操作，则会在当前记录后插入新的 History Record (插队)。
    *   如果 History Stack 已满 (50 个记录)，则会移除最早的记录 (FIFO)。
     *   History Record 6 之后是新纪录,则为History Record 6(6->7)

**图示解读:**

*   **FIFO 队列 (先进先出队列):** 展示了 History Stack 的基本结构，新的记录添加到队尾，旧的记录从队首移除。
*   **指针默认指向当前最新操作:** 表示当前操作是基于哪个历史记录。
*   **用户后退，指针后退（前进操作同理):** 说明了 Undo 操作时指针的移动方式。
*   **后退后添加记录，则在当前记录后插入记录 (插队):** 说明了在 Undo 之后进行新操作时，新记录的插入位置。

**总结:**

这个编辑回退设计采用了一个简单而有效的 FIFO 队列来存储历史操作记录。它通过 fabric.js 的 JSON 字符串来保存每个操作的状态，并通过指针来跟踪当前操作。 这种设计能够实现基本的 Undo/Redo 功能，并且易于理解和实现。
